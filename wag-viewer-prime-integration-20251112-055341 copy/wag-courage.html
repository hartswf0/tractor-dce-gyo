<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAG Courage Editor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üß°</text></svg>">
    <style>
        :root {
            --bg-main: #0a0a0a;
            --bg-secondary: #151515;
            --bg-tertiary: #1f1f1f;
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --border-primary: #2a2a2a;
            --accent: #ffd700;
            --success: #0f0;
            --error: #f33;
        }
        :root[data-theme="light"] {
            --bg-main: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --border-primary: #d0d7de;
            --accent: #0969da;
            --success: #0a0;
            --error: #d1242f;
        }
        :root[data-theme="green"] {
            --bg-main: #0d1117;
            --bg-secondary: #0a1f1a;
            --bg-tertiary: #0f2920;
            --text-primary: #aff5b4;
            --text-secondary: #7ee787;
            --border-primary: #1f6feb;
            --accent: #3fb950;
            --success: #0f0;
            --error: #f85149;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            display: grid;
            grid-template-rows: 1fr;
            grid-template-columns: 1fr 1fr;  /* Equal 50/50 split */
            overflow: hidden;
            padding-top: 44px;
            padding-bottom: 44px;
        }
        
        /* Mobile/Tablet: Stack vertically */
        @media (max-width: 900px) {
            body {
                grid-template-columns: 1fr !important;
                grid-template-rows: minmax(300px, 1fr) minmax(300px, 1fr) !important;
            }
            #editor-panel {
                grid-row: 2 !important;
                grid-column: 1 !important;
                width: 100% !important;
                max-width: 100% !important;
                display: flex !important;
                visibility: visible !important;
                border-right: none !important;
                border-top: 2px solid var(--accent) !important;
            }
            #viewer-panel {
                grid-row: 1 !important;
                grid-column: 1 !important;
                width: 100% !important;
                max-width: 100% !important;
                display: flex !important;
                visibility: visible !important;
            }
        }
        /* Header - FIXED position like Bronze */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.05);
            z-index: 1000;
        }
        #header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #file-name {
            font-size: 13px;
            color: var(--accent);
            font-weight: 600;
        }
        #header-center {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .mode-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .mode-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        .mode-btn.active {
            background: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
        }
        .corner-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .corner-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        /* Footer - FIXED position like Bronze */
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 16px;
            z-index: 1000;
        }
        @media (max-width: 900px) {
            #footer {
                font-size: 9px;
                padding: 0 6px;
                gap: 4px;
            }
            #status-text {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                min-width: 0;
            }
        }
        #scene-selector {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 11px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.2s;
        }
        .footer-corner-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .footer-corner-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        #scene-selector:hover {
            border-color: var(--accent);
        }
        #status-text {
            color: var(--accent);
            flex: 1;
        }
        #model-stats {
            color: var(--text-secondary);
        }
        /* Editor Panel - left column (50% width, equal to viewer) */
        #editor-panel {
            grid-row: 1;
            grid-column: 1;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;  /* Allow flex shrink */
        }
        #editor-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
            overflow: hidden;
        }
        .section-title {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-top: 8px;
        }
        #editor-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }
        /* Panel Header - Above Editor */
        .panel-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 36px;
        }
        .panel-header-left, .panel-header-right {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .panel-btn {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
        }
        .panel-btn:hover {
            background: var(--bg-main);
            color: var(--text-primary);
            border-color: var(--accent);
        }
        
        /* Editor Scroll Container */
        #editor-scroll-container {
            display: flex;
            width: 100%;
            height: calc(100% - 36px);
            overflow: hidden;
        }
        
        /* Line-based Editor */
        #mpd-editor {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            background: var(--bg-main);
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .editor-line {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-left: 3px solid transparent;
            transition: all 0.15s;
            min-height: 28px;
        }
        .editor-line:hover {
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }
        .editor-line.locked {
            background: rgba(255, 215, 0, 0.15);
            border-left: 3px solid var(--accent);
        }
        .editor-line.selected {
            background: rgba(44, 194, 255, 0.2) !important;
            border-left: 3px solid var(--accent) !important;
            box-shadow: inset 0 0 0 1px var(--accent);
        }
        .editor-line.compiling {
            background: rgba(255, 215, 0, 0.15);
            border-left-color: var(--accent);
            animation: compileWave 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes compileWave {
            0% { background: rgba(255, 215, 0, 0.15); transform: translateX(-10px); }
            100% { background: rgba(255, 215, 0, 0); transform: translateX(0); }
        }
        .editor-line.highlighted {
            background: rgba(255, 215, 0, 0.2);
            border-left-color: #ffd700;
            animation: pulse 1s ease-in-out 2;
        }
        @keyframes pulse {
            0%, 100% { background: rgba(255, 215, 0, 0.2); }
            50% { background: rgba(255, 215, 0, 0.35); }
        }
        .editor-line.locked .line-content {
            color: #fa0;
            font-weight: 600;
        }
        .editor-line.missing-part {
            background: rgba(255, 105, 180, 0.15) !important;
            border-left: 3px solid #ff69b4 !important;
            position: relative;
            animation: errorPulse 2s ease-in-out infinite;
        }
        .editor-line.missing-part::after {
            content: 'üíî MISSING';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff69b4;
            font-size: 11px;
            font-weight: 700;
            background: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 4px;
        }
        @keyframes errorPulse {
            0%, 100% { background: rgba(255, 105, 180, 0.15); }
            50% { background: rgba(255, 105, 180, 0.25); }
        }
        
        .line-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: var(--accent);
            opacity: 1 !important;
            appearance: auto !important;
            -webkit-appearance: checkbox !important;
        }
        .editor-line.locked .line-checkbox {
            accent-color: #fa0;
        }
        
        .line-number {
            min-width: 32px;
            text-align: right;
            color: var(--text-tertiary);
            font-size: 10px;
            flex-shrink: 0;
            user-select: none;
        }
        
        .line-content {
            flex: 1;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            outline: none;
            white-space: pre;
            font-weight: 500;
        }
        .line-content:focus {
            background: rgba(255, 215, 0, 0.08);
            border-radius: 2px;
        }
        .line-content.comment {
            color: var(--text-tertiary);
            font-style: italic;
            font-weight: 400;
        }
        .line-content.part {
            color: var(--text-primary);
            font-weight: 600;
        }
        .line-content.disabled {
            color: var(--text-tertiary);
            text-decoration: line-through;
            opacity: 0.4;
        }
        .editor-line.file-line {
            background: rgba(255, 215, 0, 0.05);
        }
        .editor-line.file-line .line-content {
            color: var(--accent);
            font-weight: 700;
            text-decoration: underline;
        }
        .editor-line.step-line .line-content {
            color: #0ff;
            font-weight: 600;
        }
        
        /* Grace Error Panel */
        #grace-error-panel {
            position: fixed;
            bottom: 44px;
            left: 0;
            right: 50%;
            max-height: 200px;
            background: linear-gradient(180deg, rgba(255, 105, 180, 0.95) 0%, rgba(220, 20, 60, 0.95) 100%);
            border-top: 2px solid #ff1493;
            overflow-y: auto;
            z-index: 900;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: none;
        }
        #grace-error-panel.visible {
            display: block;
            transform: translateY(0);
        }
        .grace-error-header {
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #fff;
        }
        .grace-error-item {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            color: #fff;
            transition: background 0.2s;
        }
        .grace-error-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .grace-error-line {
            font-weight: 700;
            color: #ffff00;
        }
        .grace-error-copy {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .grace-error-copy:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        @media (max-width: 900px) {
            #grace-error-panel {
                right: 0;
                bottom: 0;
            }
        }
        
        /* Minimap */
        #mpd-minimap {
            width: 20px;
            height: 100%;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border-primary);
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        .mpd-minimap-strip {
            width: 100%;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        .mpd-minimap-strip:hover {
            background: rgba(255,255,255,0.2) !important;
        }
        .mpd-minimap-strip.part { background: #4a9eff; }
        .mpd-minimap-strip.comment { background: #555; }
        .mpd-minimap-strip.empty { background: #1a1a1a; }
        .mpd-minimap-strip.locked { background: #fa0; }
        
        /* 2D Grid View */
        #grid-2d {
            width: 100%;
            height: 100%;
            background: var(--bg-main);
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 2px;
            padding: 20px;
        }
        .grid-cell {
            background: var(--bg-main);
            border: 1px solid var(--border-primary);
            transition: all 0.2s;
            position: relative;
        }
        .grid-cell::after {
            content: attr(data-label);
            position: absolute;
            bottom: 3px;
            right: 4px;
            font-size: 9px;
            color: rgba(255,255,255,0.65);
            pointer-events: none;
        }
        .grid-cell.corner-marker::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            border-top: 2px solid var(--accent);
            border-left: 2px solid var(--accent);
            opacity: 0.9;
        }
        .grid-cell.occupied {
            background: var(--accent);
            border-color: rgba(255, 215, 0, 0.5);
        }
        .grid-cell.selected {
            box-shadow: inset 0 0 0 2px #00ff00, 0 0 8px #00ff00;
            animation: pulse-grid 1s ease-in-out infinite;
        }
        @keyframes pulse-grid {
            0%, 100% { box-shadow: inset 0 0 0 2px #00ff00, 0 0 8px #00ff00; }
            50% { box-shadow: inset 0 0 0 3px #00ff00, 0 0 12px #00ff00; }
        }
        .grid-cell:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent);
        }
        
        /* Minimap grid cells */
        .minimap-cell {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .minimap-cell.corner-marker::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 5px;
            height: 5px;
            border-top: 2px solid var(--accent);
            border-left: 2px solid var(--accent);
            opacity: 0.9;
        }
        .minimap-cell.occupied {
            background: var(--accent);
            box-shadow: 0 0 2px rgba(255, 215, 0, 0.8);
        }
        
        /* Scene dots */
        #scene-dots {
            z-index: 10;
        }
        
        /* Paste Zone Modal */
        #paste-zone {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            height: 60%;
            background: var(--bg-secondary);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }
        #paste-zone.active {
            display: flex;
        }
        #paste-zone textarea {
            width: 100%;
            height: 100%;
            background: var(--bg-main);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
            resize: none;
            margin-bottom: 16px;
        }
        .paste-buttons {
            display: flex;
            gap: 12px;
        }
        
        #render-btn {
            padding: 10px;
            background: var(--accent);
            color: var(--bg-main);
            border: none;
            border-radius: 4px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        #render-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
        }
        #render-btn:active { transform: translateY(0); }
        .char-count {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
        }
        #search {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-primary);
            background: var(--bg-main);
            color: var(--text-primary);
            font-size: 11px;
        }
        #search:focus {
            outline: 1px solid var(--accent);
            border-color: var(--accent);
        }
        #stats {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 4px 0;
        }
        #model-list { display: flex; flex-direction: column; gap: 8px; }
        .model-item {
            padding: 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        .model-item:hover {
            border-color: var(--accent);
            transform: translateX(2px);
        }
        .model-item.active {
            border-color: var(--accent);
            background: rgba(255, 215, 0, 0.1);
        }
        .model-title { font-weight: 600; font-size: 14px; }
        .model-meta { font-size: 12px; color: #aaa; margin-top: 4px; }
        .scene-item:hover {
            border-color: var(--accent);
            transform: translateX(2px);
        }
        .scene-item.active {
            border-color: var(--accent) !important;
            background: rgba(255, 215, 0, 0.1) !important;
        }
        #new-scene-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--text-primary);
        }
        /* Viewer Panel - right column (50% width, equal to editor) */
        #viewer-panel {
            grid-row: 1;
            grid-column: 2;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;  /* Allow flex shrink */
        }
        
        /* On mobile, add top border instead of left border */
        @media (max-width: 900px) {
            #editor-panel {
                border-right: none !important;
                border-top: 2px solid var(--accent) !important;
            }
            /* Hide scene name on mobile to save space */
            #scene-name {
                display: none !important;
            }
            /* Make buttons smaller on mobile */
            .panel-btn, .corner-btn, .mode-btn {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }
        }
        #viewer-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* Mobile: Fix control bar positioning and visibility */
        @media (max-width: 900px) {
            #viewer-panel > div:first-of-type {
                position: sticky !important;
                top: 0 !important;
                z-index: 200 !important;
                flex-wrap: wrap !important;
            }
            
            #scene-dots-vertical {
                right: 5px !important;
                top: 60px !important;
                padding: 4px !important;
            }
            #minimap {
                right: 5px !important;
                top: 100px !important;
                width: 90px !important;
                height: 90px !important;
            }
        }
        #viewer { width: 100%; height: 100%; }
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        #loading.active {
            display: flex !important;
            opacity: 1;
            animation: breathe 2s ease-in-out infinite;
        }
        @keyframes breathe {
            0%, 100% { backdrop-filter: blur(8px); }
            50% { backdrop-filter: blur(12px); }
        }
        .loading-content {
            background: linear-gradient(135deg, rgba(10, 35, 50, 0.95), rgba(5, 20, 30, 0.95));
            padding: 40px 60px;
            border-radius: 16px;
            border: 2px solid var(--accent);
            box-shadow: 0 0 40px rgba(42, 193, 255, 0.3), 
                        0 8px 32px rgba(0,0,0,0.8),
                        inset 0 1px 0 rgba(255,255,255,0.1);
            text-align: center;
            animation: float 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        .loading-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(42, 193, 255, 0.05) 50%, 
                transparent 70%);
            animation: shimmer 3s linear infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        @keyframes shimmer {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid transparent;
            border-top: 5px solid var(--accent);
            border-right: 5px solid rgba(42, 193, 255, 0.3);
            border-radius: 50%;
            animation: spin 0.8s linear infinite, pulse 1.5s ease-in-out infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 20px rgba(42, 193, 255, 0.4),
                        inset 0 0 20px rgba(42, 193, 255, 0.2);
            position: relative;
        }
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 3px solid transparent;
            border-bottom: 3px solid rgba(42, 193, 255, 0.6);
            border-left: 3px solid rgba(42, 193, 255, 0.3);
            border-radius: 50%;
            animation: spin 1.2s linear infinite reverse;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 18px;
            color: var(--accent);
            margin-bottom: 12px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(42, 193, 255, 0.5),
                         0 0 20px rgba(42, 193, 255, 0.3);
            animation: textPulse 2s ease-in-out infinite;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        .loading-subtext {
            font-size: 13px;
            color: rgba(42, 193, 255, 0.7);
            animation: textPulse 2s ease-in-out infinite 0.3s;
            position: relative;
            z-index: 1;
        }
        @keyframes textPulse {
            0%, 100% { 
                opacity: 0.8;
                transform: translateY(0);
            }
            50% { 
                opacity: 1;
                transform: translateY(-2px);
            }
        }
        .loading-progress {
            margin-top: 20px;
            width: 100%;
            height: 4px;
            background: rgba(42, 193, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .loading-progress::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%,
                var(--accent) 50%,
                transparent 100%);
            animation: scanProgress 2s ease-in-out infinite;
            width: 50%;
        }
        @keyframes scanProgress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(300%); }
        }
        #info-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 280px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #1e90c2;
            backdrop-filter: blur(8px);
        }
        #info-panel h2 { font-size: 16px; margin-bottom: 10px; color: #8ae4ff; }
        .info-row { font-size: 12px; margin-bottom: 6px; }
        .label { color: #999; display: inline-block; width: 70px; }
        #controls {
            position: absolute;
            left: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(0, 0, 0, 0.75);
            border: 1px solid #1e90c2;
            border-radius: 8px;
            padding: 12px;
        }
        .control-row { display: flex; gap: 6px; flex-wrap: wrap; }
        #controls button {
            background: #1e90c2;
            color: #03131b;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        #controls button:hover { background: #28b3f5; }
        .toggle-button.active { background: #2cc2ff; color: #03131b; }
        .empty-state { font-size: 13px; color: #777; margin-top: 10px; }
        #manual-loader {
            background: #101010;
            border: 1px solid #2b2b2b;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #manual-loader h2 { font-size: 14px; color: #8ae4ff; }
        #manual-text {
            width: 100%;
            min-height: 80px;
            background: #050505;
            border: 1px solid #333;
            border-radius: 4px;
            color: #e8e8e8;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }
        .manual-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        #manual-loader button,
        #manual-loader label.file-label {
            background: #1e90c2;
            color: #03131b;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }
        #manual-loader button:hover,
        #manual-loader label.file-label:hover { background: #28b3f5; }
        #manual-file { display: none; }
        #manual-path {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #333;
            background: #0e0e0e;
            color: #fefefe;
            font-size: 12px;
        }
        #info-panel .value { color: #e8e8e8; }
        #info-panel .info-highlight { color: #8ae4ff; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Header: 4 corners + center -->
    <header id="header">
        <div id="header-left">
            <button class="corner-btn" id="help-btn" title="Help">?</button>
            <span id="file-name" style="font-size: 14px; font-weight: 600; margin-left: 12px;">Scene 1</span>
        </div>
        <div id="header-center">
            <div style="display: flex; gap: 4px; align-items: center; padding: 0 8px; border-right: 1px solid var(--border-primary); margin-right: 8px;">
                <button class="mode-btn" id="undo-btn" title="Undo">‚Ü∂</button>
                <button class="mode-btn" id="redo-btn" title="Redo">‚Ü∑</button>
            </div>
            <button class="mode-btn" id="clear-btn" title="Clear">‚àÖ</button>
            <button class="mode-btn active" id="select-mode" title="Select">‚åñ</button>
            <button class="mode-btn" id="lock-mode" title="Lock">‚äó</button>
        </div>
        <button class="corner-btn" id="theme-btn" title="Theme: Dark">üåô</button>
    </header>
    
    <!-- Editor Panel (left) -->
    <section id="editor-panel">
        <div class="panel-header">
            <div class="panel-header-left">
                <button class="panel-btn" id="mpd-undo-btn" title="Undo">‚Ü∂</button>
                <button class="panel-btn" id="mpd-redo-btn" title="Redo">‚Ü∑</button>
                <button class="panel-btn" id="new-mpd-btn" title="New MPD">New</button>
                <button class="panel-btn" id="clear-mpd-btn" title="Discard">Discard</button>
            </div>
            <div class="panel-header-right">
                <button class="panel-btn" id="select-all-btn" title="Select all lines (Cmd+A)">SELECT ALL</button>
                <button class="panel-btn" id="deselect-all-btn" title="Clear selection (Esc)" style="display: none;">CLEAR</button>
                <button class="panel-btn" id="invert-selection-btn" title="Invert selection" style="display: none;">INVERT</button>
                <div style="width: 1px; height: 20px; background: var(--border-primary); margin: 0 4px;"></div>
                <button class="panel-btn" id="copy-all-btn" title="Copy entire MPD to clipboard" style="background: var(--accent); color: var(--bg-main); font-weight: 600;">üìã COPY ALL</button>
                <button class="panel-btn" id="copy-ground-btn" title="Copy ground-corrected MPD to clipboard">üìã FIX GROUND</button>
                <button class="panel-btn" id="copy-skeleton-btn" title="Copy stud skeleton as MPD to clipboard">üìã SKELETON</button>
                <button class="panel-btn" id="render-btn" title="Force Render">‚ü≥</button>
            </div>
        </div>
        <div id="editor-scroll-container">
            <div id="mpd-editor"></div>
            <div id="mpd-minimap"></div>
        </div>
    </section>    
    <!-- Viewer Panel (right) -->
    <section id="viewer-panel">
        <!-- Viewer Mode Tabs + Controls (thin bar above grid) -->
        <div style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-primary); padding: 6px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 6px; align-items: center;">
                <button class="panel-btn active" id="mode-3d-tab">3D</button>
                <button class="panel-btn" id="mode-2d-tab">2D</button>
                <div style="width: 1px; height: 16px; background: var(--border-primary); margin: 0 4px;"></div>
                <button class="panel-btn" id="spin-quick" title="Auto Spin">S</button>
                <button class="panel-btn" id="reset-quick" title="Reset View">‚åñ</button>
            </div>
            <div style="flex: 1;"></div>
            <div style="display: flex; gap: 4px; align-items: center;">
                <button class="panel-btn" id="wire-quick" title="Wireframe">W</button>
                <button class="panel-btn active" id="axes-quick" title="Axes">A</button>
                <button class="panel-btn active" id="grid-quick" title="Grid">G</button>
                <button class="panel-btn" id="skeleton-quick" title="Skeleton-only view">üíÄ</button>
                <button class="panel-btn" id="ground-toggle-btn" title="Toggle ground corrections">ü™®</button>
                <button class="panel-btn" id="stud-normal-quick" title="Toggle normal (cyan) studs" style="color:#00ffff;">‚óè</button>
                <button class="panel-btn" id="stud-problem-quick" title="Toggle problem (red) studs" style="color:#ff4444;">‚óè</button>
                <button class="panel-btn" id="stud-ghost-quick" title="Toggle ghost (green) studs" style="color:#00ff00;">‚óè</button>
                <button class="panel-btn" id="flipy-quick" title="Flip Y">Y</button>
                <div style="width: 1px; height: 16px; background: var(--border-primary); margin: 0 4px;"></div>
                <button class="panel-btn active" id="minimap-toggle" title="Toggle Minimap">‚ñ£</button>
                <button class="panel-btn" id="screenshot-btn" title="Screenshot (4:3 + JSON)">IMG</button>
                <button class="panel-btn" id="gold-import-btn" title="Load GOLD JSON & restore MPD">GOLD</button>
                <button class="panel-btn" id="glb-export-btn" title="Export current scene as GLB">GLB</button>
            </div>
        </div>
        
        <div id="viewer-content">
            <div id="viewer" style="display: block;"></div>
            <!-- 2D Grid View -->
            <div id="grid-2d" style="display: none;"></div>
            <!-- Loading Indicator (full-screen overlay) -->
            <div id="loading">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading...</div>
                    <div class="loading-subtext">Please wait...</div>
                    <div class="loading-progress"></div>
                </div>
            </div>
            
            <!-- Scene dots (vertical strip on right edge) -->
            <div id="scene-dots-vertical" style="position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 6px; align-items: center; padding: 6px; background: rgba(0,0,0,0.7); border: 1px solid var(--border-primary); border-radius: 4px; z-index: 100;">
                <!-- Dots populated dynamically -->
            </div>
            
            <!-- Minimap (below scene dots on right edge) -->
            <div id="minimap" style="position: absolute; top: 140px; right: 10px; width: 120px; height: 120px; background: rgba(0,0,0,0.8); border: 2px solid var(--accent); border-radius: 4px; display: block; padding: 4px; z-index: 100;">
                <div style="font-size: 9px; color: var(--accent); text-align: center; margin-bottom: 2px; font-weight: 700;">MAP</div>
                <div id="minimap-grid" style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; height: calc(100% - 14px);"></div>
            </div>
            <!-- Frank corner tab (orientation helper matching 2D/minimap corner marker) -->
            <div id="frank-corner-tab" style="position: absolute; bottom: 10px; left: 10px; padding: 4px 6px; font-size: 9px; background: rgba(0,0,0,0.8); border: 1px solid var(--accent); border-radius: 3px; color: var(--accent); z-index: 100;">
                ‚Üñ A1
            </div>
        </div>
    </section>
    
    <!-- Footer: 4 corners -->
    <footer id="footer">
        <button class="footer-corner-btn" id="import-export-btn" title="Import/Export">‚áÑ</button>
        
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 12px;">
            <button id="catalog-browser-btn" class="corner-btn" style="font-size: 18px; padding: 4px 10px;" title="Open Part Catalog Browser">‚≠ê</button>
            <select id="scene-selector" style="min-width: 250px; font-size: 13px; padding: 6px;">
                <option value="">üíö Current Scene</option>
                <optgroup label="üì¶ Available MPD Files">
                    <option value="../catalogs/Axle_01.mpd">Axle 1/2 (30 parts)</option>
                    <option value="../catalogs/Axle_02.mpd">Axle 2/2 (1 parts)</option>
                    <option value="../catalogs/Door_01.mpd">Door 1/1 (4 parts)</option>
                    <option value="../catalogs/Hinge_01.mpd">Hinge 1/1 (3 parts)</option>
                    <option value="../catalogs/Other_01.mpd">Other 1/1126 (30 parts)</option>
                    <option value="../catalogs/Other_02.mpd">Other 2/1126 (30 parts)</option>
                    <option value="../catalogs/Other_03.mpd">Other 3/1126 (30 parts)</option>
                    <option value="../catalogs/Other_04.mpd">Other 4/1126 (30 parts)</option>
                    <option value="../catalogs/Other_05.mpd">Other 5/1126 (30 parts)</option>
                    <option value="../catalogs/Other_06.mpd">Other 6/1126 (30 parts)</option>
                    <option value="../catalogs/Other_07.mpd">Other 7/1126 (30 parts)</option>
                    <option value="../catalogs/Other_08.mpd">Other 8/1126 (30 parts)</option>
                    <option value="../catalogs/Other_09.mpd">Other 9/1126 (30 parts)</option>
                    <option value="../catalogs/Other_10.mpd">Other 10/1126 (30 parts)</option>
                    <option value="../catalogs/Other_11.mpd">Other 11/1126 (30 parts)</option>
                    <option value="../catalogs/Other_12.mpd">Other 12/1126 (30 parts)</option>
                    <option value="../catalogs/Other_13.mpd">Other 13/1126 (30 parts)</option>
                    <option value="../catalogs/Other_14.mpd">Other 14/1126 (30 parts)</option>
                    <option value="../catalogs/Other_15.mpd">Other 15/1126 (30 parts)</option>
                    <option value="../catalogs/Other_16.mpd">Other 16/1126 (30 parts)</option>
                    <option value="../catalogs/Other_17.mpd">Other 17/1126 (30 parts)</option>
                    <option value="../catalogs/Other_18.mpd">Other 18/1126 (30 parts)</option>
                    <option value="../catalogs/Other_19.mpd">Other 19/1126 (30 parts)</option>
                    <option value="../catalogs/Other_20.mpd">Other 20/1126 (30 parts)</option>
                    <option value="../catalogs/Other_21.mpd">Other 21/1126 (30 parts)</option>
                    <option value="../catalogs/Other_22.mpd">Other 22/1126 (30 parts)</option>
                    <option value="../catalogs/Other_23.mpd">Other 23/1126 (30 parts)</option>
                    <option value="../catalogs/Other_24.mpd">Other 24/1126 (30 parts)</option>
                    <option value="../catalogs/Other_25.mpd">Other 25/1126 (30 parts)</option>
                    <option value="../catalogs/Other_26.mpd">Other 26/1126 (30 parts)</option>
                    <option value="../catalogs/Other_27.mpd">Other 27/1126 (30 parts)</option>
                    <option value="../catalogs/Other_28.mpd">Other 28/1126 (30 parts)</option>
                    <option value="../catalogs/Other_29.mpd">Other 29/1126 (30 parts)</option>
                    <option value="../catalogs/Other_30.mpd">Other 30/1126 (30 parts)</option>
                    <option value="../catalogs/Other_31.mpd">Other 31/1126 (30 parts)</option>
                    <option value="../catalogs/Other_32.mpd">Other 32/1126 (30 parts)</option>
                    <option value="../catalogs/Other_33.mpd">Other 33/1126 (30 parts)</option>
                    <option value="../catalogs/Other_34.mpd">Other 34/1126 (30 parts)</option>
                    <option value="../catalogs/Other_35.mpd">Other 35/1126 (30 parts)</option>
                    <option value="../catalogs/Other_36.mpd">Other 36/1126 (30 parts)</option>
                    <option value="../catalogs/Other_37.mpd">Other 37/1126 (30 parts)</option>
                    <option value="../catalogs/Other_38.mpd">Other 38/1126 (30 parts)</option>
                    <option value="../catalogs/Other_39.mpd">Other 39/1126 (30 parts)</option>
                    <option value="../catalogs/Other_40.mpd">Other 40/1126 (30 parts)</option>
                    <option value="../catalogs/Other_41.mpd">Other 41/1126 (30 parts)</option>
                    <option value="../catalogs/Other_42.mpd">Other 42/1126 (30 parts)</option>
                    <option value="../catalogs/Other_43.mpd">Other 43/1126 (30 parts)</option>
                    <option value="../catalogs/Other_44.mpd">Other 44/1126 (30 parts)</option>
                    <option value="../catalogs/Other_45.mpd">Other 45/1126 (30 parts)</option>
                    <option value="../catalogs/Other_46.mpd">Other 46/1126 (30 parts)</option>
                    <option value="../catalogs/Other_47.mpd">Other 47/1126 (30 parts)</option>
                    <option value="../catalogs/Other_48.mpd">Other 48/1126 (30 parts)</option>
                    <option value="../catalogs/Other_49.mpd">Other 49/1126 (30 parts)</option>
                    <option value="../catalogs/Other_50.mpd">Other 50/1126 (30 parts)</option>
                    <option value="../catalogs/Other_51.mpd">Other 51/1126 (30 parts)</option>
                    <option value="../catalogs/Other_52.mpd">Other 52/1126 (30 parts)</option>
                    <option value="../catalogs/Other_53.mpd">Other 53/1126 (30 parts)</option>
                    <option value="../catalogs/Other_54.mpd">Other 54/1126 (30 parts)</option>
                    <option value="../catalogs/Other_55.mpd">Other 55/1126 (30 parts)</option>
                    <option value="../catalogs/Other_56.mpd">Other 56/1126 (30 parts)</option>
                    <option value="../catalogs/Other_57.mpd">Other 57/1126 (30 parts)</option>
                    <option value="../catalogs/Other_58.mpd">Other 58/1126 (30 parts)</option>
                    <option value="../catalogs/Other_59.mpd">Other 59/1126 (30 parts)</option>
                    <option value="../catalogs/Other_60.mpd">Other 60/1126 (30 parts)</option>
                    <option value="../catalogs/Other_61.mpd">Other 61/1126 (30 parts)</option>
                    <option value="../catalogs/Other_62.mpd">Other 62/1126 (30 parts)</option>
                    <option value="../catalogs/Other_63.mpd">Other 63/1126 (30 parts)</option>
                    <option value="../catalogs/Other_64.mpd">Other 64/1126 (30 parts)</option>
                    <option value="../catalogs/Other_65.mpd">Other 65/1126 (30 parts)</option>
                    <option value="../catalogs/Other_66.mpd">Other 66/1126 (30 parts)</option>
                    <option value="../catalogs/Other_67.mpd">Other 67/1126 (30 parts)</option>
                    <option value="../catalogs/Other_68.mpd">Other 68/1126 (30 parts)</option>
                    <option value="../catalogs/Other_69.mpd">Other 69/1126 (30 parts)</option>
                    <option value="../catalogs/Other_70.mpd">Other 70/1126 (30 parts)</option>
                    <option value="../catalogs/Other_71.mpd">Other 71/1126 (30 parts)</option>
                    <option value="../catalogs/Other_72.mpd">Other 72/1126 (30 parts)</option>
                    <option value="../catalogs/Other_73.mpd">Other 73/1126 (30 parts)</option>
                    <option value="../catalogs/Other_74.mpd">Other 74/1126 (30 parts)</option>
                    <option value="../catalogs/Other_75.mpd">Other 75/1126 (30 parts)</option>
                    <option value="../catalogs/Other_76.mpd">Other 76/1126 (30 parts)</option>
                    <option value="../catalogs/Other_77.mpd">Other 77/1126 (30 parts)</option>
                    <option value="../catalogs/Other_78.mpd">Other 78/1126 (30 parts)</option>
                    <option value="../catalogs/Other_79.mpd">Other 79/1126 (30 parts)</option>
                    <option value="../catalogs/Other_80.mpd">Other 80/1126 (30 parts)</option>
                    <option value="../catalogs/Other_81.mpd">Other 81/1126 (30 parts)</option>
                    <option value="../catalogs/Other_82.mpd">Other 82/1126 (30 parts)</option>
                    <option value="../catalogs/Other_83.mpd">Other 83/1126 (30 parts)</option>
                    <option value="../catalogs/Other_84.mpd">Other 84/1126 (30 parts)</option>
                    <option value="../catalogs/Other_85.mpd">Other 85/1126 (30 parts)</option>
                    <option value="../catalogs/Other_86.mpd">Other 86/1126 (30 parts)</option>
                    <option value="../catalogs/Other_87.mpd">Other 87/1126 (30 parts)</option>
                    <option value="../catalogs/Other_88.mpd">Other 88/1126 (30 parts)</option>
                    <option value="../catalogs/Other_89.mpd">Other 89/1126 (30 parts)</option>
                    <option value="../catalogs/Other_90.mpd">Other 90/1126 (30 parts)</option>
                    <option value="../catalogs/Other_91.mpd">Other 91/1126 (30 parts)</option>
                    <option value="../catalogs/Other_92.mpd">Other 92/1126 (30 parts)</option>
                    <option value="../catalogs/Other_93.mpd">Other 93/1126 (30 parts)</option>
                    <option value="../catalogs/Other_94.mpd">Other 94/1126 (30 parts)</option>
                    <option value="../catalogs/Other_95.mpd">Other 95/1126 (30 parts)</option>
                    <option value="../catalogs/Other_96.mpd">Other 96/1126 (30 parts)</option>
                    <option value="../catalogs/Other_97.mpd">Other 97/1126 (30 parts)</option>
                    <option value="../catalogs/Other_98.mpd">Other 98/1126 (30 parts)</option>
                    <option value="../catalogs/Other_99.mpd">Other 99/1126 (30 parts)</option>
                    <option value="../catalogs/Other_100.mpd">Other 100/1126 (30 parts)</option>
                    <option value="../catalogs/Other_101.mpd">Other 101/1126 (30 parts)</option>
                    <option value="../catalogs/Other_102.mpd">Other 102/1126 (30 parts)</option>
                    <option value="../catalogs/Other_103.mpd">Other 103/1126 (30 parts)</option>
                    <option value="../catalogs/Other_104.mpd">Other 104/1126 (30 parts)</option>
                    <option value="../catalogs/Other_105.mpd">Other 105/1126 (30 parts)</option>
                    <option value="../catalogs/Other_106.mpd">Other 106/1126 (30 parts)</option>
                    <option value="../catalogs/Other_107.mpd">Other 107/1126 (30 parts)</option>
                    <option value="../catalogs/Other_108.mpd">Other 108/1126 (30 parts)</option>
                    <option value="../catalogs/Other_109.mpd">Other 109/1126 (30 parts)</option>
                    <option value="../catalogs/Other_110.mpd">Other 110/1126 (30 parts)</option>
                    <option value="../catalogs/Other_111.mpd">Other 111/1126 (30 parts)</option>
                    <option value="../catalogs/Other_112.mpd">Other 112/1126 (30 parts)</option>
                    <option value="../catalogs/Other_113.mpd">Other 113/1126 (30 parts)</option>
                    <option value="../catalogs/Other_114.mpd">Other 114/1126 (30 parts)</option>
                    <option value="../catalogs/Other_115.mpd">Other 115/1126 (30 parts)</option>
                    <option value="../catalogs/Other_116.mpd">Other 116/1126 (30 parts)</option>
                    <option value="../catalogs/Other_117.mpd">Other 117/1126 (30 parts)</option>
                    <option value="../catalogs/Other_118.mpd">Other 118/1126 (30 parts)</option>
                    <option value="../catalogs/Other_119.mpd">Other 119/1126 (30 parts)</option>
                    <option value="../catalogs/Other_120.mpd">Other 120/1126 (30 parts)</option>
                    <option value="../catalogs/Other_121.mpd">Other 121/1126 (30 parts)</option>
                    <option value="../catalogs/Other_122.mpd">Other 122/1126 (30 parts)</option>
                    <option value="../catalogs/Other_123.mpd">Other 123/1126 (30 parts)</option>
                    <option value="../catalogs/Other_124.mpd">Other 124/1126 (30 parts)</option>
                    <option value="../catalogs/Other_125.mpd">Other 125/1126 (30 parts)</option>
                    <option value="../catalogs/Other_126.mpd">Other 126/1126 (30 parts)</option>
                    <option value="../catalogs/Other_127.mpd">Other 127/1126 (30 parts)</option>
                    <option value="../catalogs/Other_128.mpd">Other 128/1126 (30 parts)</option>
                    <option value="../catalogs/Other_129.mpd">Other 129/1126 (30 parts)</option>
                    <option value="../catalogs/Other_130.mpd">Other 130/1126 (30 parts)</option>
                    <option value="../catalogs/Other_131.mpd">Other 131/1126 (30 parts)</option>
                    <option value="../catalogs/Other_132.mpd">Other 132/1126 (30 parts)</option>
                    <option value="../catalogs/Other_133.mpd">Other 133/1126 (30 parts)</option>
                    <option value="../catalogs/Other_134.mpd">Other 134/1126 (30 parts)</option>
                    <option value="../catalogs/Other_135.mpd">Other 135/1126 (30 parts)</option>
                    <option value="../catalogs/Other_136.mpd">Other 136/1126 (30 parts)</option>
                    <option value="../catalogs/Other_137.mpd">Other 137/1126 (30 parts)</option>
                    <option value="../catalogs/Other_138.mpd">Other 138/1126 (30 parts)</option>
                    <option value="../catalogs/Other_139.mpd">Other 139/1126 (30 parts)</option>
                    <option value="../catalogs/Other_140.mpd">Other 140/1126 (30 parts)</option>
                    <option value="../catalogs/Other_141.mpd">Other 141/1126 (30 parts)</option>
                    <option value="../catalogs/Other_142.mpd">Other 142/1126 (30 parts)</option>
                    <option value="../catalogs/Other_143.mpd">Other 143/1126 (30 parts)</option>
                    <option value="../catalogs/Other_144.mpd">Other 144/1126 (30 parts)</option>
                    <option value="../catalogs/Other_145.mpd">Other 145/1126 (30 parts)</option>
                    <option value="../catalogs/Other_146.mpd">Other 146/1126 (30 parts)</option>
                    <option value="../catalogs/Other_147.mpd">Other 147/1126 (30 parts)</option>
                    <option value="../catalogs/Other_148.mpd">Other 148/1126 (30 parts)</option>
                    <option value="../catalogs/Other_149.mpd">Other 149/1126 (30 parts)</option>
                    <option value="../catalogs/Other_150.mpd">Other 150/1126 (30 parts)</option>
                    <option value="../catalogs/Other_151.mpd">Other 151/1126 (30 parts)</option>
                    <option value="../catalogs/Other_152.mpd">Other 152/1126 (30 parts)</option>
                    <option value="../catalogs/Other_153.mpd">Other 153/1126 (30 parts)</option>
                    <option value="../catalogs/Other_154.mpd">Other 154/1126 (30 parts)</option>
                    <option value="../catalogs/Other_155.mpd">Other 155/1126 (30 parts)</option>
                    <option value="../catalogs/Other_156.mpd">Other 156/1126 (30 parts)</option>
                    <option value="../catalogs/Other_157.mpd">Other 157/1126 (30 parts)</option>
                    <option value="../catalogs/Other_158.mpd">Other 158/1126 (30 parts)</option>
                    <option value="../catalogs/Other_159.mpd">Other 159/1126 (30 parts)</option>
                    <option value="../catalogs/Other_160.mpd">Other 160/1126 (30 parts)</option>
                    <option value="../catalogs/Other_161.mpd">Other 161/1126 (30 parts)</option>
                    <option value="../catalogs/Other_162.mpd">Other 162/1126 (30 parts)</option>
                    <option value="../catalogs/Other_163.mpd">Other 163/1126 (30 parts)</option>
                    <option value="../catalogs/Other_164.mpd">Other 164/1126 (30 parts)</option>
                    <option value="../catalogs/Other_165.mpd">Other 165/1126 (30 parts)</option>
                    <option value="../catalogs/Other_166.mpd">Other 166/1126 (30 parts)</option>
                    <option value="../catalogs/Other_167.mpd">Other 167/1126 (30 parts)</option>
                    <option value="../catalogs/Other_168.mpd">Other 168/1126 (30 parts)</option>
                    <option value="../catalogs/Other_169.mpd">Other 169/1126 (30 parts)</option>
                    <option value="../catalogs/Other_170.mpd">Other 170/1126 (30 parts)</option>
                    <option value="../catalogs/Other_171.mpd">Other 171/1126 (30 parts)</option>
                    <option value="../catalogs/Other_172.mpd">Other 172/1126 (30 parts)</option>
                    <option value="../catalogs/Other_173.mpd">Other 173/1126 (30 parts)</option>
                    <option value="../catalogs/Other_174.mpd">Other 174/1126 (30 parts)</option>
                    <option value="../catalogs/Other_175.mpd">Other 175/1126 (30 parts)</option>
                    <option value="../catalogs/Other_176.mpd">Other 176/1126 (30 parts)</option>
                    <option value="../catalogs/Other_177.mpd">Other 177/1126 (30 parts)</option>
                    <option value="../catalogs/Other_178.mpd">Other 178/1126 (30 parts)</option>
                    <option value="../catalogs/Other_179.mpd">Other 179/1126 (30 parts)</option>
                    <option value="../catalogs/Other_180.mpd">Other 180/1126 (30 parts)</option>
                    <option value="../catalogs/Other_181.mpd">Other 181/1126 (30 parts)</option>
                    <option value="../catalogs/Other_182.mpd">Other 182/1126 (30 parts)</option>
                    <option value="../catalogs/Other_183.mpd">Other 183/1126 (30 parts)</option>
                    <option value="../catalogs/Other_184.mpd">Other 184/1126 (30 parts)</option>
                    <option value="../catalogs/Other_185.mpd">Other 185/1126 (30 parts)</option>
                    <option value="../catalogs/Other_186.mpd">Other 186/1126 (30 parts)</option>
                    <option value="../catalogs/Other_187.mpd">Other 187/1126 (30 parts)</option>
                    <option value="../catalogs/Other_188.mpd">Other 188/1126 (30 parts)</option>
                    <option value="../catalogs/Other_189.mpd">Other 189/1126 (30 parts)</option>
                    <option value="../catalogs/Other_190.mpd">Other 190/1126 (30 parts)</option>
                    <option value="../catalogs/Other_191.mpd">Other 191/1126 (30 parts)</option>
                    <option value="../catalogs/Other_192.mpd">Other 192/1126 (30 parts)</option>
                    <option value="../catalogs/Other_193.mpd">Other 193/1126 (30 parts)</option>
                    <option value="../catalogs/Other_194.mpd">Other 194/1126 (30 parts)</option>
                    <option value="../catalogs/Other_195.mpd">Other 195/1126 (30 parts)</option>
                    <option value="../catalogs/Other_196.mpd">Other 196/1126 (30 parts)</option>
                    <option value="../catalogs/Other_197.mpd">Other 197/1126 (30 parts)</option>
                    <option value="../catalogs/Other_198.mpd">Other 198/1126 (30 parts)</option>
                    <option value="../catalogs/Other_199.mpd">Other 199/1126 (30 parts)</option>
                    <option value="../catalogs/Other_200.mpd">Other 200/1126 (30 parts)</option>
                    <option value="../catalogs/Other_201.mpd">Other 201/1126 (30 parts)</option>
                    <option value="../catalogs/Other_202.mpd">Other 202/1126 (30 parts)</option>
                    <option value="../catalogs/Other_203.mpd">Other 203/1126 (30 parts)</option>
                    <option value="../catalogs/Other_204.mpd">Other 204/1126 (30 parts)</option>
                    <option value="../catalogs/Other_205.mpd">Other 205/1126 (30 parts)</option>
                    <option value="../catalogs/Other_206.mpd">Other 206/1126 (30 parts)</option>
                    <option value="../catalogs/Other_207.mpd">Other 207/1126 (30 parts)</option>
                    <option value="../catalogs/Other_208.mpd">Other 208/1126 (30 parts)</option>
                    <option value="../catalogs/Other_209.mpd">Other 209/1126 (30 parts)</option>
                    <option value="../catalogs/Other_210.mpd">Other 210/1126 (30 parts)</option>
                    <option value="../catalogs/Other_211.mpd">Other 211/1126 (30 parts)</option>
                    <option value="../catalogs/Other_212.mpd">Other 212/1126 (30 parts)</option>
                    <option value="../catalogs/Other_213.mpd">Other 213/1126 (30 parts)</option>
                    <option value="../catalogs/Other_214.mpd">Other 214/1126 (30 parts)</option>
                    <option value="../catalogs/Other_215.mpd">Other 215/1126 (30 parts)</option>
                    <option value="../catalogs/Other_216.mpd">Other 216/1126 (30 parts)</option>
                    <option value="../catalogs/Other_217.mpd">Other 217/1126 (30 parts)</option>
                    <option value="../catalogs/Other_218.mpd">Other 218/1126 (30 parts)</option>
                    <option value="../catalogs/Other_219.mpd">Other 219/1126 (30 parts)</option>
                    <option value="../catalogs/Other_220.mpd">Other 220/1126 (30 parts)</option>
                    <option value="../catalogs/Other_221.mpd">Other 221/1126 (30 parts)</option>
                    <option value="../catalogs/Other_222.mpd">Other 222/1126 (30 parts)</option>
                    <option value="../catalogs/Other_223.mpd">Other 223/1126 (30 parts)</option>
                    <option value="../catalogs/Other_224.mpd">Other 224/1126 (30 parts)</option>
                    <option value="../catalogs/Other_225.mpd">Other 225/1126 (30 parts)</option>
                    <option value="../catalogs/Other_226.mpd">Other 226/1126 (30 parts)</option>
                    <option value="../catalogs/Other_227.mpd">Other 227/1126 (30 parts)</option>
                    <option value="../catalogs/Other_228.mpd">Other 228/1126 (30 parts)</option>
                    <option value="../catalogs/Other_229.mpd">Other 229/1126 (30 parts)</option>
                    <option value="../catalogs/Other_230.mpd">Other 230/1126 (30 parts)</option>
                    <option value="../catalogs/Other_231.mpd">Other 231/1126 (30 parts)</option>
                    <option value="../catalogs/Other_232.mpd">Other 232/1126 (30 parts)</option>
                    <option value="../catalogs/Other_233.mpd">Other 233/1126 (30 parts)</option>
                    <option value="../catalogs/Other_234.mpd">Other 234/1126 (30 parts)</option>
                    <option value="../catalogs/Other_235.mpd">Other 235/1126 (30 parts)</option>
                    <option value="../catalogs/Other_236.mpd">Other 236/1126 (30 parts)</option>
                    <option value="../catalogs/Other_237.mpd">Other 237/1126 (30 parts)</option>
                    <option value="../catalogs/Other_238.mpd">Other 238/1126 (30 parts)</option>
                    <option value="../catalogs/Other_239.mpd">Other 239/1126 (30 parts)</option>
                    <option value="../catalogs/Other_240.mpd">Other 240/1126 (30 parts)</option>
                    <option value="../catalogs/Other_241.mpd">Other 241/1126 (30 parts)</option>
                    <option value="../catalogs/Other_242.mpd">Other 242/1126 (30 parts)</option>
                    <option value="../catalogs/Other_243.mpd">Other 243/1126 (30 parts)</option>
                    <option value="../catalogs/Other_244.mpd">Other 244/1126 (30 parts)</option>
                    <option value="../catalogs/Other_245.mpd">Other 245/1126 (30 parts)</option>
                    <option value="../catalogs/Other_246.mpd">Other 246/1126 (30 parts)</option>
                    <option value="../catalogs/Other_247.mpd">Other 247/1126 (30 parts)</option>
                    <option value="../catalogs/Other_248.mpd">Other 248/1126 (30 parts)</option>
                    <option value="../catalogs/Other_249.mpd">Other 249/1126 (30 parts)</option>
                    <option value="../catalogs/Other_250.mpd">Other 250/1126 (30 parts)</option>
                    <option value="../catalogs/Other_251.mpd">Other 251/1126 (30 parts)</option>
                    <option value="../catalogs/Other_252.mpd">Other 252/1126 (30 parts)</option>
                    <option value="../catalogs/Other_253.mpd">Other 253/1126 (30 parts)</option>
                    <option value="../catalogs/Other_254.mpd">Other 254/1126 (30 parts)</option>
                    <option value="../catalogs/Other_255.mpd">Other 255/1126 (30 parts)</option>
                    <option value="../catalogs/Other_256.mpd">Other 256/1126 (30 parts)</option>
                    <option value="../catalogs/Other_257.mpd">Other 257/1126 (30 parts)</option>
                    <option value="../catalogs/Other_258.mpd">Other 258/1126 (30 parts)</option>
                    <option value="../catalogs/Other_259.mpd">Other 259/1126 (30 parts)</option>
                    <option value="../catalogs/Other_260.mpd">Other 260/1126 (30 parts)</option>
                    <option value="../catalogs/Other_261.mpd">Other 261/1126 (30 parts)</option>
                    <option value="../catalogs/Other_262.mpd">Other 262/1126 (30 parts)</option>
                    <option value="../catalogs/Other_263.mpd">Other 263/1126 (30 parts)</option>
                    <option value="../catalogs/Other_264.mpd">Other 264/1126 (30 parts)</option>
                    <option value="../catalogs/Other_265.mpd">Other 265/1126 (30 parts)</option>
                    <option value="../catalogs/Other_266.mpd">Other 266/1126 (30 parts)</option>
                    <option value="../catalogs/Other_267.mpd">Other 267/1126 (30 parts)</option>
                    <option value="../catalogs/Other_268.mpd">Other 268/1126 (30 parts)</option>
                    <option value="../catalogs/Other_269.mpd">Other 269/1126 (30 parts)</option>
                    <option value="../catalogs/Other_270.mpd">Other 270/1126 (30 parts)</option>
                    <option value="../catalogs/Other_271.mpd">Other 271/1126 (30 parts)</option>
                    <option value="../catalogs/Other_272.mpd">Other 272/1126 (30 parts)</option>
                    <option value="../catalogs/Other_273.mpd">Other 273/1126 (30 parts)</option>
                    <option value="../catalogs/Other_274.mpd">Other 274/1126 (30 parts)</option>
                    <option value="../catalogs/Other_275.mpd">Other 275/1126 (30 parts)</option>
                    <option value="../catalogs/Other_276.mpd">Other 276/1126 (30 parts)</option>
                    <option value="../catalogs/Other_277.mpd">Other 277/1126 (30 parts)</option>
                    <option value="../catalogs/Other_278.mpd">Other 278/1126 (30 parts)</option>
                    <option value="../catalogs/Other_279.mpd">Other 279/1126 (30 parts)</option>
                    <option value="../catalogs/Other_280.mpd">Other 280/1126 (30 parts)</option>
                    <option value="../catalogs/Other_281.mpd">Other 281/1126 (30 parts)</option>
                    <option value="../catalogs/Other_282.mpd">Other 282/1126 (30 parts)</option>
                    <option value="../catalogs/Other_283.mpd">Other 283/1126 (30 parts)</option>
                    <option value="../catalogs/Other_284.mpd">Other 284/1126 (30 parts)</option>
                    <option value="../catalogs/Other_285.mpd">Other 285/1126 (30 parts)</option>
                    <option value="../catalogs/Other_286.mpd">Other 286/1126 (30 parts)</option>
                    <option value="../catalogs/Other_287.mpd">Other 287/1126 (30 parts)</option>
                    <option value="../catalogs/Other_288.mpd">Other 288/1126 (30 parts)</option>
                    <option value="../catalogs/Other_289.mpd">Other 289/1126 (30 parts)</option>
                    <option value="../catalogs/Other_290.mpd">Other 290/1126 (30 parts)</option>
                    <option value="../catalogs/Other_291.mpd">Other 291/1126 (30 parts)</option>
                    <option value="../catalogs/Other_292.mpd">Other 292/1126 (30 parts)</option>
                    <option value="../catalogs/Other_293.mpd">Other 293/1126 (30 parts)</option>
                    <option value="../catalogs/Other_294.mpd">Other 294/1126 (30 parts)</option>
                    <option value="../catalogs/Other_295.mpd">Other 295/1126 (30 parts)</option>
                    <option value="../catalogs/Other_296.mpd">Other 296/1126 (30 parts)</option>
                    <option value="../catalogs/Other_297.mpd">Other 297/1126 (30 parts)</option>
                    <option value="../catalogs/Other_298.mpd">Other 298/1126 (30 parts)</option>
                    <option value="../catalogs/Other_299.mpd">Other 299/1126 (30 parts)</option>
                    <option value="../catalogs/Other_300.mpd">Other 300/1126 (30 parts)</option>
                    <option value="../catalogs/Other_301.mpd">Other 301/1126 (30 parts)</option>
                    <option value="../catalogs/Other_302.mpd">Other 302/1126 (30 parts)</option>
                    <option value="../catalogs/Other_303.mpd">Other 303/1126 (30 parts)</option>
                    <option value="../catalogs/Other_304.mpd">Other 304/1126 (30 parts)</option>
                    <option value="../catalogs/Other_305.mpd">Other 305/1126 (30 parts)</option>
                    <option value="../catalogs/Other_306.mpd">Other 306/1126 (30 parts)</option>
                    <option value="../catalogs/Other_307.mpd">Other 307/1126 (30 parts)</option>
                    <option value="../catalogs/Other_308.mpd">Other 308/1126 (30 parts)</option>
                    <option value="../catalogs/Other_309.mpd">Other 309/1126 (30 parts)</option>
                    <option value="../catalogs/Other_310.mpd">Other 310/1126 (30 parts)</option>
                    <option value="../catalogs/Other_311.mpd">Other 311/1126 (30 parts)</option>
                    <option value="../catalogs/Other_312.mpd">Other 312/1126 (30 parts)</option>
                    <option value="../catalogs/Other_313.mpd">Other 313/1126 (30 parts)</option>
                    <option value="../catalogs/Other_314.mpd">Other 314/1126 (30 parts)</option>
                    <option value="../catalogs/Other_315.mpd">Other 315/1126 (30 parts)</option>
                    <option value="../catalogs/Other_316.mpd">Other 316/1126 (30 parts)</option>
                    <option value="../catalogs/Other_317.mpd">Other 317/1126 (30 parts)</option>
                    <option value="../catalogs/Other_318.mpd">Other 318/1126 (30 parts)</option>
                    <option value="../catalogs/Other_319.mpd">Other 319/1126 (30 parts)</option>
                    <option value="../catalogs/Other_320.mpd">Other 320/1126 (30 parts)</option>
                    <option value="../catalogs/Other_321.mpd">Other 321/1126 (30 parts)</option>
                    <option value="../catalogs/Other_322.mpd">Other 322/1126 (30 parts)</option>
                    <option value="../catalogs/Other_323.mpd">Other 323/1126 (30 parts)</option>
                    <option value="../catalogs/Other_324.mpd">Other 324/1126 (30 parts)</option>
                    <option value="../catalogs/Other_325.mpd">Other 325/1126 (30 parts)</option>
                    <option value="../catalogs/Other_326.mpd">Other 326/1126 (30 parts)</option>
                    <option value="../catalogs/Other_327.mpd">Other 327/1126 (30 parts)</option>
                    <option value="../catalogs/Other_328.mpd">Other 328/1126 (30 parts)</option>
                    <option value="../catalogs/Other_329.mpd">Other 329/1126 (30 parts)</option>
                    <option value="../catalogs/Other_330.mpd">Other 330/1126 (30 parts)</option>
                    <option value="../catalogs/Other_331.mpd">Other 331/1126 (30 parts)</option>
                    <option value="../catalogs/Other_332.mpd">Other 332/1126 (30 parts)</option>
                    <option value="../catalogs/Other_333.mpd">Other 333/1126 (30 parts)</option>
                    <option value="../catalogs/Other_334.mpd">Other 334/1126 (30 parts)</option>
                    <option value="../catalogs/Other_335.mpd">Other 335/1126 (30 parts)</option>
                    <option value="../catalogs/Other_336.mpd">Other 336/1126 (30 parts)</option>
                    <option value="../catalogs/Other_337.mpd">Other 337/1126 (30 parts)</option>
                    <option value="../catalogs/Other_338.mpd">Other 338/1126 (30 parts)</option>
                    <option value="../catalogs/Other_339.mpd">Other 339/1126 (30 parts)</option>
                    <option value="../catalogs/Other_340.mpd">Other 340/1126 (30 parts)</option>
                    <option value="../catalogs/Other_341.mpd">Other 341/1126 (30 parts)</option>
                    <option value="../catalogs/Other_342.mpd">Other 342/1126 (30 parts)</option>
                    <option value="../catalogs/Other_343.mpd">Other 343/1126 (30 parts)</option>
                    <option value="../catalogs/Other_344.mpd">Other 344/1126 (30 parts)</option>
                    <option value="../catalogs/Other_345.mpd">Other 345/1126 (30 parts)</option>
                    <option value="../catalogs/Other_346.mpd">Other 346/1126 (30 parts)</option>
                    <option value="../catalogs/Other_347.mpd">Other 347/1126 (30 parts)</option>
                    <option value="../catalogs/Other_348.mpd">Other 348/1126 (30 parts)</option>
                    <option value="../catalogs/Other_349.mpd">Other 349/1126 (30 parts)</option>
                    <option value="../catalogs/Other_350.mpd">Other 350/1126 (30 parts)</option>
                    <option value="../catalogs/Other_351.mpd">Other 351/1126 (30 parts)</option>
                    <option value="../catalogs/Other_352.mpd">Other 352/1126 (30 parts)</option>
                    <option value="../catalogs/Other_353.mpd">Other 353/1126 (30 parts)</option>
                    <option value="../catalogs/Other_354.mpd">Other 354/1126 (30 parts)</option>
                    <option value="../catalogs/Other_355.mpd">Other 355/1126 (30 parts)</option>
                    <option value="../catalogs/Other_356.mpd">Other 356/1126 (30 parts)</option>
                    <option value="../catalogs/Other_357.mpd">Other 357/1126 (30 parts)</option>
                    <option value="../catalogs/Other_358.mpd">Other 358/1126 (30 parts)</option>
                    <option value="../catalogs/Other_359.mpd">Other 359/1126 (30 parts)</option>
                    <option value="../catalogs/Other_360.mpd">Other 360/1126 (30 parts)</option>
                    <option value="../catalogs/Other_361.mpd">Other 361/1126 (30 parts)</option>
                    <option value="../catalogs/Other_362.mpd">Other 362/1126 (30 parts)</option>
                    <option value="../catalogs/Other_363.mpd">Other 363/1126 (30 parts)</option>
                    <option value="../catalogs/Other_364.mpd">Other 364/1126 (30 parts)</option>
                    <option value="../catalogs/Other_365.mpd">Other 365/1126 (30 parts)</option>
                    <option value="../catalogs/Other_366.mpd">Other 366/1126 (30 parts)</option>
                    <option value="../catalogs/Other_367.mpd">Other 367/1126 (30 parts)</option>
                    <option value="../catalogs/Other_368.mpd">Other 368/1126 (30 parts)</option>
                    <option value="../catalogs/Other_369.mpd">Other 369/1126 (30 parts)</option>
                    <option value="../catalogs/Other_370.mpd">Other 370/1126 (30 parts)</option>
                    <option value="../catalogs/Other_371.mpd">Other 371/1126 (30 parts)</option>
                    <option value="../catalogs/Other_372.mpd">Other 372/1126 (30 parts)</option>
                    <option value="../catalogs/Other_373.mpd">Other 373/1126 (30 parts)</option>
                    <option value="../catalogs/Other_374.mpd">Other 374/1126 (30 parts)</option>
                    <option value="../catalogs/Other_375.mpd">Other 375/1126 (30 parts)</option>
                    <option value="../catalogs/Other_376.mpd">Other 376/1126 (30 parts)</option>
                    <option value="../catalogs/Other_377.mpd">Other 377/1126 (30 parts)</option>
                    <option value="../catalogs/Other_378.mpd">Other 378/1126 (30 parts)</option>
                    <option value="../catalogs/Other_379.mpd">Other 379/1126 (30 parts)</option>
                    <option value="../catalogs/Other_380.mpd">Other 380/1126 (30 parts)</option>
                    <option value="../catalogs/Other_381.mpd">Other 381/1126 (30 parts)</option>
                    <option value="../catalogs/Other_382.mpd">Other 382/1126 (30 parts)</option>
                    <option value="../catalogs/Other_383.mpd">Other 383/1126 (30 parts)</option>
                    <option value="../catalogs/Other_384.mpd">Other 384/1126 (30 parts)</option>
                    <option value="../catalogs/Other_385.mpd">Other 385/1126 (30 parts)</option>
                    <option value="../catalogs/Other_386.mpd">Other 386/1126 (30 parts)</option>
                    <option value="../catalogs/Other_387.mpd">Other 387/1126 (30 parts)</option>
                    <option value="../catalogs/Other_388.mpd">Other 388/1126 (30 parts)</option>
                    <option value="../catalogs/Other_389.mpd">Other 389/1126 (30 parts)</option>
                    <option value="../catalogs/Other_390.mpd">Other 390/1126 (30 parts)</option>
                    <option value="../catalogs/Other_391.mpd">Other 391/1126 (30 parts)</option>
                    <option value="../catalogs/Other_392.mpd">Other 392/1126 (30 parts)</option>
                    <option value="../catalogs/Other_393.mpd">Other 393/1126 (30 parts)</option>
                    <option value="../catalogs/Other_394.mpd">Other 394/1126 (30 parts)</option>
                    <option value="../catalogs/Other_395.mpd">Other 395/1126 (30 parts)</option>
                    <option value="../catalogs/Other_396.mpd">Other 396/1126 (30 parts)</option>
                    <option value="../catalogs/Other_397.mpd">Other 397/1126 (30 parts)</option>
                    <option value="../catalogs/Other_398.mpd">Other 398/1126 (30 parts)</option>
                    <option value="../catalogs/Other_399.mpd">Other 399/1126 (30 parts)</option>
                    <option value="../catalogs/Other_400.mpd">Other 400/1126 (30 parts)</option>
                    <option value="../catalogs/Other_401.mpd">Other 401/1126 (30 parts)</option>
                    <option value="../catalogs/Other_402.mpd">Other 402/1126 (30 parts)</option>
                    <option value="../catalogs/Other_403.mpd">Other 403/1126 (30 parts)</option>
                    <option value="../catalogs/Other_404.mpd">Other 404/1126 (30 parts)</option>
                    <option value="../catalogs/Other_405.mpd">Other 405/1126 (30 parts)</option>
                    <option value="../catalogs/Other_406.mpd">Other 406/1126 (30 parts)</option>
                    <option value="../catalogs/Other_407.mpd">Other 407/1126 (30 parts)</option>
                    <option value="../catalogs/Other_408.mpd">Other 408/1126 (30 parts)</option>
                    <option value="../catalogs/Other_409.mpd">Other 409/1126 (30 parts)</option>
                    <option value="../catalogs/Other_410.mpd">Other 410/1126 (30 parts)</option>
                    <option value="../catalogs/Other_411.mpd">Other 411/1126 (30 parts)</option>
                    <option value="../catalogs/Other_412.mpd">Other 412/1126 (30 parts)</option>
                    <option value="../catalogs/Other_413.mpd">Other 413/1126 (30 parts)</option>
                    <option value="../catalogs/Other_414.mpd">Other 414/1126 (30 parts)</option>
                    <option value="../catalogs/Other_415.mpd">Other 415/1126 (30 parts)</option>
                    <option value="../catalogs/Other_416.mpd">Other 416/1126 (30 parts)</option>
                    <option value="../catalogs/Other_417.mpd">Other 417/1126 (30 parts)</option>
                    <option value="../catalogs/Other_418.mpd">Other 418/1126 (30 parts)</option>
                    <option value="../catalogs/Other_419.mpd">Other 419/1126 (30 parts)</option>
                    <option value="../catalogs/Other_420.mpd">Other 420/1126 (30 parts)</option>
                    <option value="../catalogs/Other_421.mpd">Other 421/1126 (30 parts)</option>
                    <option value="../catalogs/Other_422.mpd">Other 422/1126 (30 parts)</option>
                    <option value="../catalogs/Other_423.mpd">Other 423/1126 (30 parts)</option>
                    <option value="../catalogs/Other_424.mpd">Other 424/1126 (30 parts)</option>
                    <option value="../catalogs/Other_425.mpd">Other 425/1126 (30 parts)</option>
                    <option value="../catalogs/Other_426.mpd">Other 426/1126 (30 parts)</option>
                    <option value="../catalogs/Other_427.mpd">Other 427/1126 (30 parts)</option>
                    <option value="../catalogs/Other_428.mpd">Other 428/1126 (30 parts)</option>
                    <option value="../catalogs/Other_429.mpd">Other 429/1126 (30 parts)</option>
                    <option value="../catalogs/Other_430.mpd">Other 430/1126 (30 parts)</option>
                    <option value="../catalogs/Other_431.mpd">Other 431/1126 (30 parts)</option>
                    <option value="../catalogs/Other_432.mpd">Other 432/1126 (30 parts)</option>
                    <option value="../catalogs/Other_433.mpd">Other 433/1126 (30 parts)</option>
                    <option value="../catalogs/Other_434.mpd">Other 434/1126 (30 parts)</option>
                    <option value="../catalogs/Other_435.mpd">Other 435/1126 (30 parts)</option>
                    <option value="../catalogs/Other_436.mpd">Other 436/1126 (30 parts)</option>
                    <option value="../catalogs/Other_437.mpd">Other 437/1126 (30 parts)</option>
                    <option value="../catalogs/Other_438.mpd">Other 438/1126 (30 parts)</option>
                    <option value="../catalogs/Other_439.mpd">Other 439/1126 (30 parts)</option>
                    <option value="../catalogs/Other_440.mpd">Other 440/1126 (30 parts)</option>
                    <option value="../catalogs/Other_441.mpd">Other 441/1126 (30 parts)</option>
                    <option value="../catalogs/Other_442.mpd">Other 442/1126 (30 parts)</option>
                    <option value="../catalogs/Other_443.mpd">Other 443/1126 (30 parts)</option>
                    <option value="../catalogs/Other_444.mpd">Other 444/1126 (30 parts)</option>
                    <option value="../catalogs/Other_445.mpd">Other 445/1126 (30 parts)</option>
                    <option value="../catalogs/Other_446.mpd">Other 446/1126 (30 parts)</option>
                    <option value="../catalogs/Other_447.mpd">Other 447/1126 (30 parts)</option>
                    <option value="../catalogs/Other_448.mpd">Other 448/1126 (30 parts)</option>
                    <option value="../catalogs/Other_449.mpd">Other 449/1126 (30 parts)</option>
                    <option value="../catalogs/Other_450.mpd">Other 450/1126 (30 parts)</option>
                    <option value="../catalogs/Other_451.mpd">Other 451/1126 (30 parts)</option>
                    <option value="../catalogs/Other_452.mpd">Other 452/1126 (30 parts)</option>
                    <option value="../catalogs/Other_453.mpd">Other 453/1126 (30 parts)</option>
                    <option value="../catalogs/Other_454.mpd">Other 454/1126 (30 parts)</option>
                    <option value="../catalogs/Other_455.mpd">Other 455/1126 (30 parts)</option>
                    <option value="../catalogs/Other_456.mpd">Other 456/1126 (30 parts)</option>
                    <option value="../catalogs/Other_457.mpd">Other 457/1126 (30 parts)</option>
                    <option value="../catalogs/Other_458.mpd">Other 458/1126 (30 parts)</option>
                    <option value="../catalogs/Other_459.mpd">Other 459/1126 (30 parts)</option>
                    <option value="../catalogs/Other_460.mpd">Other 460/1126 (30 parts)</option>
                    <option value="../catalogs/Other_461.mpd">Other 461/1126 (30 parts)</option>
                    <option value="../catalogs/Other_462.mpd">Other 462/1126 (30 parts)</option>
                    <option value="../catalogs/Other_463.mpd">Other 463/1126 (30 parts)</option>
                    <option value="../catalogs/Other_464.mpd">Other 464/1126 (30 parts)</option>
                    <option value="../catalogs/Other_465.mpd">Other 465/1126 (30 parts)</option>
                    <option value="../catalogs/Other_466.mpd">Other 466/1126 (30 parts)</option>
                    <option value="../catalogs/Other_467.mpd">Other 467/1126 (30 parts)</option>
                    <option value="../catalogs/Other_468.mpd">Other 468/1126 (30 parts)</option>
                    <option value="../catalogs/Other_469.mpd">Other 469/1126 (30 parts)</option>
                    <option value="../catalogs/Other_470.mpd">Other 470/1126 (30 parts)</option>
                    <option value="../catalogs/Other_471.mpd">Other 471/1126 (30 parts)</option>
                    <option value="../catalogs/Other_472.mpd">Other 472/1126 (30 parts)</option>
                    <option value="../catalogs/Other_473.mpd">Other 473/1126 (30 parts)</option>
                    <option value="../catalogs/Other_474.mpd">Other 474/1126 (30 parts)</option>
                    <option value="../catalogs/Other_475.mpd">Other 475/1126 (30 parts)</option>
                    <option value="../catalogs/Other_476.mpd">Other 476/1126 (30 parts)</option>
                    <option value="../catalogs/Other_477.mpd">Other 477/1126 (30 parts)</option>
                    <option value="../catalogs/Other_478.mpd">Other 478/1126 (30 parts)</option>
                    <option value="../catalogs/Other_479.mpd">Other 479/1126 (30 parts)</option>
                    <option value="../catalogs/Other_480.mpd">Other 480/1126 (30 parts)</option>
                    <option value="../catalogs/Other_481.mpd">Other 481/1126 (30 parts)</option>
                    <option value="../catalogs/Other_482.mpd">Other 482/1126 (30 parts)</option>
                    <option value="../catalogs/Other_483.mpd">Other 483/1126 (30 parts)</option>
                    <option value="../catalogs/Other_484.mpd">Other 484/1126 (30 parts)</option>
                    <option value="../catalogs/Other_485.mpd">Other 485/1126 (30 parts)</option>
                    <option value="../catalogs/Other_486.mpd">Other 486/1126 (30 parts)</option>
                    <option value="../catalogs/Other_487.mpd">Other 487/1126 (30 parts)</option>
                    <option value="../catalogs/Other_488.mpd">Other 488/1126 (30 parts)</option>
                    <option value="../catalogs/Other_489.mpd">Other 489/1126 (30 parts)</option>
                    <option value="../catalogs/Other_490.mpd">Other 490/1126 (30 parts)</option>
                    <option value="../catalogs/Other_491.mpd">Other 491/1126 (30 parts)</option>
                    <option value="../catalogs/Other_492.mpd">Other 492/1126 (30 parts)</option>
                    <option value="../catalogs/Other_493.mpd">Other 493/1126 (30 parts)</option>
                    <option value="../catalogs/Other_494.mpd">Other 494/1126 (30 parts)</option>
                    <option value="../catalogs/Other_495.mpd">Other 495/1126 (30 parts)</option>
                    <option value="../catalogs/Other_496.mpd">Other 496/1126 (30 parts)</option>
                    <option value="../catalogs/Other_497.mpd">Other 497/1126 (30 parts)</option>
                    <option value="../catalogs/Other_498.mpd">Other 498/1126 (30 parts)</option>
                    <option value="../catalogs/Other_499.mpd">Other 499/1126 (30 parts)</option>
                    <option value="../catalogs/Other_500.mpd">Other 500/1126 (30 parts)</option>
                    <option value="../catalogs/Other_501.mpd">Other 501/1126 (30 parts)</option>
                    <option value="../catalogs/Other_502.mpd">Other 502/1126 (30 parts)</option>
                    <option value="../catalogs/Other_503.mpd">Other 503/1126 (30 parts)</option>
                    <option value="../catalogs/Other_504.mpd">Other 504/1126 (30 parts)</option>
                    <option value="../catalogs/Other_505.mpd">Other 505/1126 (30 parts)</option>
                    <option value="../catalogs/Other_506.mpd">Other 506/1126 (30 parts)</option>
                    <option value="../catalogs/Other_507.mpd">Other 507/1126 (30 parts)</option>
                    <option value="../catalogs/Other_508.mpd">Other 508/1126 (30 parts)</option>
                    <option value="../catalogs/Other_509.mpd">Other 509/1126 (30 parts)</option>
                    <option value="../catalogs/Other_510.mpd">Other 510/1126 (30 parts)</option>
                    <option value="../catalogs/Other_511.mpd">Other 511/1126 (30 parts)</option>
                    <option value="../catalogs/Other_512.mpd">Other 512/1126 (30 parts)</option>
                    <option value="../catalogs/Other_513.mpd">Other 513/1126 (30 parts)</option>
                    <option value="../catalogs/Other_514.mpd">Other 514/1126 (30 parts)</option>
                    <option value="../catalogs/Other_515.mpd">Other 515/1126 (30 parts)</option>
                    <option value="../catalogs/Other_516.mpd">Other 516/1126 (30 parts)</option>
                    <option value="../catalogs/Other_517.mpd">Other 517/1126 (30 parts)</option>
                    <option value="../catalogs/Other_518.mpd">Other 518/1126 (30 parts)</option>
                    <option value="../catalogs/Other_519.mpd">Other 519/1126 (30 parts)</option>
                    <option value="../catalogs/Other_520.mpd">Other 520/1126 (30 parts)</option>
                    <option value="../catalogs/Other_521.mpd">Other 521/1126 (30 parts)</option>
                    <option value="../catalogs/Other_522.mpd">Other 522/1126 (30 parts)</option>
                    <option value="../catalogs/Other_523.mpd">Other 523/1126 (30 parts)</option>
                    <option value="../catalogs/Other_524.mpd">Other 524/1126 (30 parts)</option>
                    <option value="../catalogs/Other_525.mpd">Other 525/1126 (30 parts)</option>
                    <option value="../catalogs/Other_526.mpd">Other 526/1126 (30 parts)</option>
                    <option value="../catalogs/Other_527.mpd">Other 527/1126 (30 parts)</option>
                    <option value="../catalogs/Other_528.mpd">Other 528/1126 (30 parts)</option>
                    <option value="../catalogs/Other_529.mpd">Other 529/1126 (30 parts)</option>
                    <option value="../catalogs/Other_530.mpd">Other 530/1126 (30 parts)</option>
                    <option value="../catalogs/Other_531.mpd">Other 531/1126 (30 parts)</option>
                    <option value="../catalogs/Other_532.mpd">Other 532/1126 (30 parts)</option>
                    <option value="../catalogs/Other_533.mpd">Other 533/1126 (30 parts)</option>
                    <option value="../catalogs/Other_534.mpd">Other 534/1126 (30 parts)</option>
                    <option value="../catalogs/Other_535.mpd">Other 535/1126 (30 parts)</option>
                    <option value="../catalogs/Other_536.mpd">Other 536/1126 (30 parts)</option>
                    <option value="../catalogs/Other_537.mpd">Other 537/1126 (30 parts)</option>
                    <option value="../catalogs/Other_538.mpd">Other 538/1126 (30 parts)</option>
                    <option value="../catalogs/Other_539.mpd">Other 539/1126 (30 parts)</option>
                    <option value="../catalogs/Other_540.mpd">Other 540/1126 (30 parts)</option>
                    <option value="../catalogs/Other_541.mpd">Other 541/1126 (30 parts)</option>
                    <option value="../catalogs/Other_542.mpd">Other 542/1126 (30 parts)</option>
                    <option value="../catalogs/Other_543.mpd">Other 543/1126 (30 parts)</option>
                    <option value="../catalogs/Other_544.mpd">Other 544/1126 (30 parts)</option>
                    <option value="../catalogs/Other_545.mpd">Other 545/1126 (30 parts)</option>
                    <option value="../catalogs/Other_546.mpd">Other 546/1126 (30 parts)</option>
                    <option value="../catalogs/Other_547.mpd">Other 547/1126 (30 parts)</option>
                    <option value="../catalogs/Other_548.mpd">Other 548/1126 (30 parts)</option>
                    <option value="../catalogs/Other_549.mpd">Other 549/1126 (30 parts)</option>
                    <option value="../catalogs/Other_550.mpd">Other 550/1126 (30 parts)</option>
                    <option value="../catalogs/Other_551.mpd">Other 551/1126 (30 parts)</option>
                    <option value="../catalogs/Other_552.mpd">Other 552/1126 (30 parts)</option>
                    <option value="../catalogs/Other_553.mpd">Other 553/1126 (30 parts)</option>
                    <option value="../catalogs/Other_554.mpd">Other 554/1126 (30 parts)</option>
                    <option value="../catalogs/Other_555.mpd">Other 555/1126 (30 parts)</option>
                    <option value="../catalogs/Other_556.mpd">Other 556/1126 (30 parts)</option>
                    <option value="../catalogs/Other_557.mpd">Other 557/1126 (30 parts)</option>
                    <option value="../catalogs/Other_558.mpd">Other 558/1126 (30 parts)</option>
                    <option value="../catalogs/Other_559.mpd">Other 559/1126 (30 parts)</option>
                    <option value="../catalogs/Other_560.mpd">Other 560/1126 (30 parts)</option>
                    <option value="../catalogs/Other_561.mpd">Other 561/1126 (30 parts)</option>
                    <option value="../catalogs/Other_562.mpd">Other 562/1126 (30 parts)</option>
                    <option value="../catalogs/Other_563.mpd">Other 563/1126 (30 parts)</option>
                    <option value="../catalogs/Other_564.mpd">Other 564/1126 (30 parts)</option>
                    <option value="../catalogs/Other_565.mpd">Other 565/1126 (30 parts)</option>
                    <option value="../catalogs/Other_566.mpd">Other 566/1126 (30 parts)</option>
                    <option value="../catalogs/Other_567.mpd">Other 567/1126 (30 parts)</option>
                    <option value="../catalogs/Other_568.mpd">Other 568/1126 (30 parts)</option>
                    <option value="../catalogs/Other_569.mpd">Other 569/1126 (30 parts)</option>
                    <option value="../catalogs/Other_570.mpd">Other 570/1126 (30 parts)</option>
                    <option value="../catalogs/Other_571.mpd">Other 571/1126 (30 parts)</option>
                    <option value="../catalogs/Other_572.mpd">Other 572/1126 (30 parts)</option>
                    <option value="../catalogs/Other_573.mpd">Other 573/1126 (30 parts)</option>
                    <option value="../catalogs/Other_574.mpd">Other 574/1126 (30 parts)</option>
                    <option value="../catalogs/Other_575.mpd">Other 575/1126 (30 parts)</option>
                    <option value="../catalogs/Other_576.mpd">Other 576/1126 (30 parts)</option>
                    <option value="../catalogs/Other_577.mpd">Other 577/1126 (30 parts)</option>
                    <option value="../catalogs/Other_578.mpd">Other 578/1126 (30 parts)</option>
                    <option value="../catalogs/Other_579.mpd">Other 579/1126 (30 parts)</option>
                    <option value="../catalogs/Other_580.mpd">Other 580/1126 (30 parts)</option>
                    <option value="../catalogs/Other_581.mpd">Other 581/1126 (30 parts)</option>
                    <option value="../catalogs/Other_582.mpd">Other 582/1126 (30 parts)</option>
                    <option value="../catalogs/Other_583.mpd">Other 583/1126 (30 parts)</option>
                    <option value="../catalogs/Other_584.mpd">Other 584/1126 (30 parts)</option>
                    <option value="../catalogs/Other_585.mpd">Other 585/1126 (30 parts)</option>
                    <option value="../catalogs/Other_586.mpd">Other 586/1126 (30 parts)</option>
                    <option value="../catalogs/Other_587.mpd">Other 587/1126 (30 parts)</option>
                    <option value="../catalogs/Other_588.mpd">Other 588/1126 (30 parts)</option>
                    <option value="../catalogs/Other_589.mpd">Other 589/1126 (30 parts)</option>
                    <option value="../catalogs/Other_590.mpd">Other 590/1126 (30 parts)</option>
                    <option value="../catalogs/Other_591.mpd">Other 591/1126 (30 parts)</option>
                    <option value="../catalogs/Other_592.mpd">Other 592/1126 (30 parts)</option>
                    <option value="../catalogs/Other_593.mpd">Other 593/1126 (30 parts)</option>
                    <option value="../catalogs/Other_594.mpd">Other 594/1126 (30 parts)</option>
                    <option value="../catalogs/Other_595.mpd">Other 595/1126 (30 parts)</option>
                    <option value="../catalogs/Other_596.mpd">Other 596/1126 (30 parts)</option>
                    <option value="../catalogs/Other_597.mpd">Other 597/1126 (30 parts)</option>
                    <option value="../catalogs/Other_598.mpd">Other 598/1126 (30 parts)</option>
                    <option value="../catalogs/Other_599.mpd">Other 599/1126 (30 parts)</option>
                    <option value="../catalogs/Other_600.mpd">Other 600/1126 (30 parts)</option>
                    <option value="../catalogs/Other_601.mpd">Other 601/1126 (30 parts)</option>
                    <option value="../catalogs/Other_602.mpd">Other 602/1126 (30 parts)</option>
                    <option value="../catalogs/Other_603.mpd">Other 603/1126 (30 parts)</option>
                    <option value="../catalogs/Other_604.mpd">Other 604/1126 (30 parts)</option>
                    <option value="../catalogs/Other_605.mpd">Other 605/1126 (30 parts)</option>
                    <option value="../catalogs/Other_606.mpd">Other 606/1126 (30 parts)</option>
                    <option value="../catalogs/Other_607.mpd">Other 607/1126 (30 parts)</option>
                    <option value="../catalogs/Other_608.mpd">Other 608/1126 (30 parts)</option>
                    <option value="../catalogs/Other_609.mpd">Other 609/1126 (30 parts)</option>
                    <option value="../catalogs/Other_610.mpd">Other 610/1126 (30 parts)</option>
                    <option value="../catalogs/Other_611.mpd">Other 611/1126 (30 parts)</option>
                    <option value="../catalogs/Other_612.mpd">Other 612/1126 (30 parts)</option>
                    <option value="../catalogs/Other_613.mpd">Other 613/1126 (30 parts)</option>
                    <option value="../catalogs/Other_614.mpd">Other 614/1126 (30 parts)</option>
                    <option value="../catalogs/Other_615.mpd">Other 615/1126 (30 parts)</option>
                    <option value="../catalogs/Other_616.mpd">Other 616/1126 (30 parts)</option>
                    <option value="../catalogs/Other_617.mpd">Other 617/1126 (30 parts)</option>
                    <option value="../catalogs/Other_618.mpd">Other 618/1126 (30 parts)</option>
                    <option value="../catalogs/Other_619.mpd">Other 619/1126 (30 parts)</option>
                    <option value="../catalogs/Other_620.mpd">Other 620/1126 (30 parts)</option>
                    <option value="../catalogs/Other_621.mpd">Other 621/1126 (30 parts)</option>
                    <option value="../catalogs/Other_622.mpd">Other 622/1126 (30 parts)</option>
                    <option value="../catalogs/Other_623.mpd">Other 623/1126 (30 parts)</option>
                    <option value="../catalogs/Other_624.mpd">Other 624/1126 (30 parts)</option>
                    <option value="../catalogs/Other_625.mpd">Other 625/1126 (30 parts)</option>
                    <option value="../catalogs/Other_626.mpd">Other 626/1126 (30 parts)</option>
                    <option value="../catalogs/Other_627.mpd">Other 627/1126 (30 parts)</option>
                    <option value="../catalogs/Other_628.mpd">Other 628/1126 (30 parts)</option>
                    <option value="../catalogs/Other_629.mpd">Other 629/1126 (30 parts)</option>
                    <option value="../catalogs/Other_630.mpd">Other 630/1126 (30 parts)</option>
                    <option value="../catalogs/Other_631.mpd">Other 631/1126 (30 parts)</option>
                    <option value="../catalogs/Other_632.mpd">Other 632/1126 (30 parts)</option>
                    <option value="../catalogs/Other_633.mpd">Other 633/1126 (30 parts)</option>
                    <option value="../catalogs/Other_634.mpd">Other 634/1126 (30 parts)</option>
                    <option value="../catalogs/Other_635.mpd">Other 635/1126 (30 parts)</option>
                    <option value="../catalogs/Other_636.mpd">Other 636/1126 (30 parts)</option>
                    <option value="../catalogs/Other_637.mpd">Other 637/1126 (30 parts)</option>
                    <option value="../catalogs/Other_638.mpd">Other 638/1126 (30 parts)</option>
                    <option value="../catalogs/Other_639.mpd">Other 639/1126 (30 parts)</option>
                    <option value="../catalogs/Other_640.mpd">Other 640/1126 (30 parts)</option>
                    <option value="../catalogs/Other_641.mpd">Other 641/1126 (30 parts)</option>
                    <option value="../catalogs/Other_642.mpd">Other 642/1126 (30 parts)</option>
                    <option value="../catalogs/Other_643.mpd">Other 643/1126 (30 parts)</option>
                    <option value="../catalogs/Other_644.mpd">Other 644/1126 (30 parts)</option>
                    <option value="../catalogs/Other_645.mpd">Other 645/1126 (30 parts)</option>
                    <option value="../catalogs/Other_646.mpd">Other 646/1126 (30 parts)</option>
                    <option value="../catalogs/Other_647.mpd">Other 647/1126 (30 parts)</option>
                    <option value="../catalogs/Other_648.mpd">Other 648/1126 (30 parts)</option>
                    <option value="../catalogs/Other_649.mpd">Other 649/1126 (30 parts)</option>
                    <option value="../catalogs/Other_650.mpd">Other 650/1126 (30 parts)</option>
                    <option value="../catalogs/Other_651.mpd">Other 651/1126 (30 parts)</option>
                    <option value="../catalogs/Other_652.mpd">Other 652/1126 (30 parts)</option>
                    <option value="../catalogs/Other_653.mpd">Other 653/1126 (30 parts)</option>
                    <option value="../catalogs/Other_654.mpd">Other 654/1126 (30 parts)</option>
                    <option value="../catalogs/Other_655.mpd">Other 655/1126 (30 parts)</option>
                    <option value="../catalogs/Other_656.mpd">Other 656/1126 (30 parts)</option>
                    <option value="../catalogs/Other_657.mpd">Other 657/1126 (30 parts)</option>
                    <option value="../catalogs/Other_658.mpd">Other 658/1126 (30 parts)</option>
                    <option value="../catalogs/Other_659.mpd">Other 659/1126 (30 parts)</option>
                    <option value="../catalogs/Other_660.mpd">Other 660/1126 (30 parts)</option>
                    <option value="../catalogs/Other_661.mpd">Other 661/1126 (30 parts)</option>
                    <option value="../catalogs/Other_662.mpd">Other 662/1126 (30 parts)</option>
                    <option value="../catalogs/Other_663.mpd">Other 663/1126 (30 parts)</option>
                    <option value="../catalogs/Other_664.mpd">Other 664/1126 (30 parts)</option>
                    <option value="../catalogs/Other_665.mpd">Other 665/1126 (30 parts)</option>
                    <option value="../catalogs/Other_666.mpd">Other 666/1126 (30 parts)</option>
                    <option value="../catalogs/Other_667.mpd">Other 667/1126 (30 parts)</option>
                    <option value="../catalogs/Other_668.mpd">Other 668/1126 (30 parts)</option>
                    <option value="../catalogs/Other_669.mpd">Other 669/1126 (30 parts)</option>
                    <option value="../catalogs/Other_670.mpd">Other 670/1126 (30 parts)</option>
                    <option value="../catalogs/Other_671.mpd">Other 671/1126 (30 parts)</option>
                    <option value="../catalogs/Other_672.mpd">Other 672/1126 (30 parts)</option>
                    <option value="../catalogs/Other_673.mpd">Other 673/1126 (30 parts)</option>
                    <option value="../catalogs/Other_674.mpd">Other 674/1126 (30 parts)</option>
                    <option value="../catalogs/Other_675.mpd">Other 675/1126 (30 parts)</option>
                    <option value="../catalogs/Other_676.mpd">Other 676/1126 (30 parts)</option>
                    <option value="../catalogs/Other_677.mpd">Other 677/1126 (30 parts)</option>
                    <option value="../catalogs/Other_678.mpd">Other 678/1126 (30 parts)</option>
                    <option value="../catalogs/Other_679.mpd">Other 679/1126 (30 parts)</option>
                    <option value="../catalogs/Other_680.mpd">Other 680/1126 (30 parts)</option>
                    <option value="../catalogs/Other_681.mpd">Other 681/1126 (30 parts)</option>
                    <option value="../catalogs/Other_682.mpd">Other 682/1126 (30 parts)</option>
                    <option value="../catalogs/Other_683.mpd">Other 683/1126 (30 parts)</option>
                    <option value="../catalogs/Other_684.mpd">Other 684/1126 (30 parts)</option>
                    <option value="../catalogs/Other_685.mpd">Other 685/1126 (30 parts)</option>
                    <option value="../catalogs/Other_686.mpd">Other 686/1126 (30 parts)</option>
                    <option value="../catalogs/Other_687.mpd">Other 687/1126 (30 parts)</option>
                    <option value="../catalogs/Other_688.mpd">Other 688/1126 (30 parts)</option>
                    <option value="../catalogs/Other_689.mpd">Other 689/1126 (30 parts)</option>
                    <option value="../catalogs/Other_690.mpd">Other 690/1126 (30 parts)</option>
                    <option value="../catalogs/Other_691.mpd">Other 691/1126 (30 parts)</option>
                    <option value="../catalogs/Other_692.mpd">Other 692/1126 (30 parts)</option>
                    <option value="../catalogs/Other_693.mpd">Other 693/1126 (30 parts)</option>
                    <option value="../catalogs/Other_694.mpd">Other 694/1126 (30 parts)</option>
                    <option value="../catalogs/Other_695.mpd">Other 695/1126 (30 parts)</option>
                    <option value="../catalogs/Other_696.mpd">Other 696/1126 (30 parts)</option>
                    <option value="../catalogs/Other_697.mpd">Other 697/1126 (30 parts)</option>
                    <option value="../catalogs/Other_698.mpd">Other 698/1126 (30 parts)</option>
                    <option value="../catalogs/Other_699.mpd">Other 699/1126 (30 parts)</option>
                    <option value="../catalogs/Other_700.mpd">Other 700/1126 (30 parts)</option>
                    <option value="../catalogs/Other_701.mpd">Other 701/1126 (30 parts)</option>
                    <option value="../catalogs/Other_702.mpd">Other 702/1126 (30 parts)</option>
                    <option value="../catalogs/Other_703.mpd">Other 703/1126 (30 parts)</option>
                    <option value="../catalogs/Other_704.mpd">Other 704/1126 (30 parts)</option>
                    <option value="../catalogs/Other_705.mpd">Other 705/1126 (30 parts)</option>
                    <option value="../catalogs/Other_706.mpd">Other 706/1126 (30 parts)</option>
                    <option value="../catalogs/Other_707.mpd">Other 707/1126 (30 parts)</option>
                    <option value="../catalogs/Other_708.mpd">Other 708/1126 (30 parts)</option>
                    <option value="../catalogs/Other_709.mpd">Other 709/1126 (30 parts)</option>
                    <option value="../catalogs/Other_710.mpd">Other 710/1126 (30 parts)</option>
                    <option value="../catalogs/Other_711.mpd">Other 711/1126 (30 parts)</option>
                    <option value="../catalogs/Other_712.mpd">Other 712/1126 (30 parts)</option>
                    <option value="../catalogs/Other_713.mpd">Other 713/1126 (30 parts)</option>
                    <option value="../catalogs/Other_714.mpd">Other 714/1126 (30 parts)</option>
                    <option value="../catalogs/Other_715.mpd">Other 715/1126 (30 parts)</option>
                    <option value="../catalogs/Other_716.mpd">Other 716/1126 (30 parts)</option>
                    <option value="../catalogs/Other_717.mpd">Other 717/1126 (30 parts)</option>
                    <option value="../catalogs/Other_718.mpd">Other 718/1126 (30 parts)</option>
                    <option value="../catalogs/Other_719.mpd">Other 719/1126 (30 parts)</option>
                    <option value="../catalogs/Other_720.mpd">Other 720/1126 (30 parts)</option>
                    <option value="../catalogs/Other_721.mpd">Other 721/1126 (30 parts)</option>
                    <option value="../catalogs/Other_722.mpd">Other 722/1126 (30 parts)</option>
                    <option value="../catalogs/Other_723.mpd">Other 723/1126 (30 parts)</option>
                    <option value="../catalogs/Other_724.mpd">Other 724/1126 (30 parts)</option>
                    <option value="../catalogs/Other_725.mpd">Other 725/1126 (30 parts)</option>
                    <option value="../catalogs/Other_726.mpd">Other 726/1126 (30 parts)</option>
                    <option value="../catalogs/Other_727.mpd">Other 727/1126 (30 parts)</option>
                    <option value="../catalogs/Other_728.mpd">Other 728/1126 (30 parts)</option>
                    <option value="../catalogs/Other_729.mpd">Other 729/1126 (30 parts)</option>
                    <option value="../catalogs/Other_730.mpd">Other 730/1126 (30 parts)</option>
                    <option value="../catalogs/Other_731.mpd">Other 731/1126 (30 parts)</option>
                    <option value="../catalogs/Other_732.mpd">Other 732/1126 (30 parts)</option>
                    <option value="../catalogs/Other_733.mpd">Other 733/1126 (30 parts)</option>
                    <option value="../catalogs/Other_734.mpd">Other 734/1126 (30 parts)</option>
                    <option value="../catalogs/Other_735.mpd">Other 735/1126 (30 parts)</option>
                    <option value="../catalogs/Other_736.mpd">Other 736/1126 (30 parts)</option>
                    <option value="../catalogs/Other_737.mpd">Other 737/1126 (30 parts)</option>
                    <option value="../catalogs/Other_738.mpd">Other 738/1126 (30 parts)</option>
                    <option value="../catalogs/Other_739.mpd">Other 739/1126 (30 parts)</option>
                    <option value="../catalogs/Other_740.mpd">Other 740/1126 (30 parts)</option>
                    <option value="../catalogs/Other_741.mpd">Other 741/1126 (30 parts)</option>
                    <option value="../catalogs/Other_742.mpd">Other 742/1126 (30 parts)</option>
                    <option value="../catalogs/Other_743.mpd">Other 743/1126 (30 parts)</option>
                    <option value="../catalogs/Other_744.mpd">Other 744/1126 (30 parts)</option>
                    <option value="../catalogs/Other_745.mpd">Other 745/1126 (30 parts)</option>
                    <option value="../catalogs/Other_746.mpd">Other 746/1126 (30 parts)</option>
                    <option value="../catalogs/Other_747.mpd">Other 747/1126 (30 parts)</option>
                    <option value="../catalogs/Other_748.mpd">Other 748/1126 (30 parts)</option>
                    <option value="../catalogs/Other_749.mpd">Other 749/1126 (30 parts)</option>
                    <option value="../catalogs/Other_750.mpd">Other 750/1126 (30 parts)</option>
                    <option value="../catalogs/Other_751.mpd">Other 751/1126 (30 parts)</option>
                    <option value="../catalogs/Other_752.mpd">Other 752/1126 (30 parts)</option>
                    <option value="../catalogs/Other_753.mpd">Other 753/1126 (30 parts)</option>
                    <option value="../catalogs/Other_754.mpd">Other 754/1126 (30 parts)</option>
                    <option value="../catalogs/Other_755.mpd">Other 755/1126 (30 parts)</option>
                    <option value="../catalogs/Other_756.mpd">Other 756/1126 (30 parts)</option>
                    <option value="../catalogs/Other_757.mpd">Other 757/1126 (30 parts)</option>
                    <option value="../catalogs/Other_758.mpd">Other 758/1126 (30 parts)</option>
                    <option value="../catalogs/Other_759.mpd">Other 759/1126 (30 parts)</option>
                    <option value="../catalogs/Other_760.mpd">Other 760/1126 (30 parts)</option>
                    <option value="../catalogs/Other_761.mpd">Other 761/1126 (30 parts)</option>
                    <option value="../catalogs/Other_762.mpd">Other 762/1126 (30 parts)</option>
                    <option value="../catalogs/Other_763.mpd">Other 763/1126 (30 parts)</option>
                    <option value="../catalogs/Other_764.mpd">Other 764/1126 (30 parts)</option>
                    <option value="../catalogs/Other_765.mpd">Other 765/1126 (30 parts)</option>
                    <option value="../catalogs/Other_766.mpd">Other 766/1126 (30 parts)</option>
                    <option value="../catalogs/Other_767.mpd">Other 767/1126 (30 parts)</option>
                    <option value="../catalogs/Other_768.mpd">Other 768/1126 (30 parts)</option>
                    <option value="../catalogs/Other_769.mpd">Other 769/1126 (30 parts)</option>
                    <option value="../catalogs/Other_770.mpd">Other 770/1126 (30 parts)</option>
                    <option value="../catalogs/Other_771.mpd">Other 771/1126 (30 parts)</option>
                    <option value="../catalogs/Other_772.mpd">Other 772/1126 (30 parts)</option>
                    <option value="../catalogs/Other_773.mpd">Other 773/1126 (30 parts)</option>
                    <option value="../catalogs/Other_774.mpd">Other 774/1126 (30 parts)</option>
                    <option value="../catalogs/Other_775.mpd">Other 775/1126 (30 parts)</option>
                    <option value="../catalogs/Other_776.mpd">Other 776/1126 (30 parts)</option>
                    <option value="../catalogs/Other_777.mpd">Other 777/1126 (30 parts)</option>
                    <option value="../catalogs/Other_778.mpd">Other 778/1126 (30 parts)</option>
                    <option value="../catalogs/Other_779.mpd">Other 779/1126 (30 parts)</option>
                    <option value="../catalogs/Other_780.mpd">Other 780/1126 (30 parts)</option>
                    <option value="../catalogs/Other_781.mpd">Other 781/1126 (30 parts)</option>
                    <option value="../catalogs/Other_782.mpd">Other 782/1126 (30 parts)</option>
                    <option value="../catalogs/Other_783.mpd">Other 783/1126 (30 parts)</option>
                    <option value="../catalogs/Other_784.mpd">Other 784/1126 (30 parts)</option>
                    <option value="../catalogs/Other_785.mpd">Other 785/1126 (30 parts)</option>
                    <option value="../catalogs/Other_786.mpd">Other 786/1126 (30 parts)</option>
                    <option value="../catalogs/Other_787.mpd">Other 787/1126 (30 parts)</option>
                    <option value="../catalogs/Other_788.mpd">Other 788/1126 (30 parts)</option>
                    <option value="../catalogs/Other_789.mpd">Other 789/1126 (30 parts)</option>
                    <option value="../catalogs/Other_790.mpd">Other 790/1126 (30 parts)</option>
                    <option value="../catalogs/Other_791.mpd">Other 791/1126 (30 parts)</option>
                    <option value="../catalogs/Other_792.mpd">Other 792/1126 (30 parts)</option>
                    <option value="../catalogs/Other_793.mpd">Other 793/1126 (30 parts)</option>
                    <option value="../catalogs/Other_794.mpd">Other 794/1126 (30 parts)</option>
                    <option value="../catalogs/Other_795.mpd">Other 795/1126 (30 parts)</option>
                    <option value="../catalogs/Other_796.mpd">Other 796/1126 (30 parts)</option>
                    <option value="../catalogs/Other_797.mpd">Other 797/1126 (30 parts)</option>
                    <option value="../catalogs/Other_798.mpd">Other 798/1126 (30 parts)</option>
                    <option value="../catalogs/Other_799.mpd">Other 799/1126 (30 parts)</option>
                    <option value="../catalogs/Other_800.mpd">Other 800/1126 (30 parts)</option>
                    <option value="../catalogs/Other_801.mpd">Other 801/1126 (30 parts)</option>
                    <option value="../catalogs/Other_802.mpd">Other 802/1126 (30 parts)</option>
                    <option value="../catalogs/Other_803.mpd">Other 803/1126 (30 parts)</option>
                    <option value="../catalogs/Other_804.mpd">Other 804/1126 (30 parts)</option>
                    <option value="../catalogs/Other_805.mpd">Other 805/1126 (30 parts)</option>
                    <option value="../catalogs/Other_806.mpd">Other 806/1126 (30 parts)</option>
                    <option value="../catalogs/Other_807.mpd">Other 807/1126 (30 parts)</option>
                    <option value="../catalogs/Other_808.mpd">Other 808/1126 (30 parts)</option>
                    <option value="../catalogs/Other_809.mpd">Other 809/1126 (30 parts)</option>
                    <option value="../catalogs/Other_810.mpd">Other 810/1126 (30 parts)</option>
                    <option value="../catalogs/Other_811.mpd">Other 811/1126 (30 parts)</option>
                    <option value="../catalogs/Other_812.mpd">Other 812/1126 (30 parts)</option>
                    <option value="../catalogs/Other_813.mpd">Other 813/1126 (30 parts)</option>
                    <option value="../catalogs/Other_814.mpd">Other 814/1126 (30 parts)</option>
                    <option value="../catalogs/Other_815.mpd">Other 815/1126 (30 parts)</option>
                    <option value="../catalogs/Other_816.mpd">Other 816/1126 (30 parts)</option>
                    <option value="../catalogs/Other_817.mpd">Other 817/1126 (30 parts)</option>
                    <option value="../catalogs/Other_818.mpd">Other 818/1126 (30 parts)</option>
                    <option value="../catalogs/Other_819.mpd">Other 819/1126 (30 parts)</option>
                    <option value="../catalogs/Other_820.mpd">Other 820/1126 (30 parts)</option>
                    <option value="../catalogs/Other_821.mpd">Other 821/1126 (30 parts)</option>
                    <option value="../catalogs/Other_822.mpd">Other 822/1126 (30 parts)</option>
                    <option value="../catalogs/Other_823.mpd">Other 823/1126 (30 parts)</option>
                    <option value="../catalogs/Other_824.mpd">Other 824/1126 (30 parts)</option>
                    <option value="../catalogs/Other_825.mpd">Other 825/1126 (30 parts)</option>
                    <option value="../catalogs/Other_826.mpd">Other 826/1126 (30 parts)</option>
                    <option value="../catalogs/Other_827.mpd">Other 827/1126 (30 parts)</option>
                    <option value="../catalogs/Other_828.mpd">Other 828/1126 (30 parts)</option>
                    <option value="../catalogs/Other_829.mpd">Other 829/1126 (30 parts)</option>
                    <option value="../catalogs/Other_830.mpd">Other 830/1126 (30 parts)</option>
                    <option value="../catalogs/Other_831.mpd">Other 831/1126 (30 parts)</option>
                    <option value="../catalogs/Other_832.mpd">Other 832/1126 (30 parts)</option>
                    <option value="../catalogs/Other_833.mpd">Other 833/1126 (30 parts)</option>
                    <option value="../catalogs/Other_834.mpd">Other 834/1126 (30 parts)</option>
                    <option value="../catalogs/Other_835.mpd">Other 835/1126 (30 parts)</option>
                    <option value="../catalogs/Other_836.mpd">Other 836/1126 (30 parts)</option>
                    <option value="../catalogs/Other_837.mpd">Other 837/1126 (30 parts)</option>
                    <option value="../catalogs/Other_838.mpd">Other 838/1126 (30 parts)</option>
                    <option value="../catalogs/Other_839.mpd">Other 839/1126 (30 parts)</option>
                    <option value="../catalogs/Other_840.mpd">Other 840/1126 (30 parts)</option>
                    <option value="../catalogs/Other_841.mpd">Other 841/1126 (30 parts)</option>
                    <option value="../catalogs/Other_842.mpd">Other 842/1126 (30 parts)</option>
                    <option value="../catalogs/Other_843.mpd">Other 843/1126 (30 parts)</option>
                    <option value="../catalogs/Other_844.mpd">Other 844/1126 (30 parts)</option>
                    <option value="../catalogs/Other_845.mpd">Other 845/1126 (30 parts)</option>
                    <option value="../catalogs/Other_846.mpd">Other 846/1126 (30 parts)</option>
                    <option value="../catalogs/Other_847.mpd">Other 847/1126 (30 parts)</option>
                    <option value="../catalogs/Other_848.mpd">Other 848/1126 (30 parts)</option>
                    <option value="../catalogs/Other_849.mpd">Other 849/1126 (30 parts)</option>
                    <option value="../catalogs/Other_850.mpd">Other 850/1126 (30 parts)</option>
                    <option value="../catalogs/Other_851.mpd">Other 851/1126 (30 parts)</option>
                    <option value="../catalogs/Other_852.mpd">Other 852/1126 (30 parts)</option>
                    <option value="../catalogs/Other_853.mpd">Other 853/1126 (30 parts)</option>
                    <option value="../catalogs/Other_854.mpd">Other 854/1126 (30 parts)</option>
                    <option value="../catalogs/Other_855.mpd">Other 855/1126 (30 parts)</option>
                    <option value="../catalogs/Other_856.mpd">Other 856/1126 (30 parts)</option>
                    <option value="../catalogs/Other_857.mpd">Other 857/1126 (30 parts)</option>
                    <option value="../catalogs/Other_858.mpd">Other 858/1126 (30 parts)</option>
                    <option value="../catalogs/Other_859.mpd">Other 859/1126 (30 parts)</option>
                    <option value="../catalogs/Other_860.mpd">Other 860/1126 (30 parts)</option>
                    <option value="../catalogs/Other_861.mpd">Other 861/1126 (30 parts)</option>
                    <option value="../catalogs/Other_862.mpd">Other 862/1126 (30 parts)</option>
                    <option value="../catalogs/Other_863.mpd">Other 863/1126 (30 parts)</option>
                    <option value="../catalogs/Other_864.mpd">Other 864/1126 (30 parts)</option>
                    <option value="../catalogs/Other_865.mpd">Other 865/1126 (30 parts)</option>
                    <option value="../catalogs/Other_866.mpd">Other 866/1126 (30 parts)</option>
                    <option value="../catalogs/Other_867.mpd">Other 867/1126 (30 parts)</option>
                    <option value="../catalogs/Other_868.mpd">Other 868/1126 (30 parts)</option>
                    <option value="../catalogs/Other_869.mpd">Other 869/1126 (30 parts)</option>
                    <option value="../catalogs/Other_870.mpd">Other 870/1126 (30 parts)</option>
                    <option value="../catalogs/Other_871.mpd">Other 871/1126 (30 parts)</option>
                    <option value="../catalogs/Other_872.mpd">Other 872/1126 (30 parts)</option>
                    <option value="../catalogs/Other_873.mpd">Other 873/1126 (30 parts)</option>
                    <option value="../catalogs/Other_874.mpd">Other 874/1126 (30 parts)</option>
                    <option value="../catalogs/Other_875.mpd">Other 875/1126 (30 parts)</option>
                    <option value="../catalogs/Other_876.mpd">Other 876/1126 (30 parts)</option>
                    <option value="../catalogs/Other_877.mpd">Other 877/1126 (30 parts)</option>
                    <option value="../catalogs/Other_878.mpd">Other 878/1126 (30 parts)</option>
                    <option value="../catalogs/Other_879.mpd">Other 879/1126 (30 parts)</option>
                    <option value="../catalogs/Other_880.mpd">Other 880/1126 (30 parts)</option>
                    <option value="../catalogs/Other_881.mpd">Other 881/1126 (30 parts)</option>
                    <option value="../catalogs/Other_882.mpd">Other 882/1126 (30 parts)</option>
                    <option value="../catalogs/Other_883.mpd">Other 883/1126 (30 parts)</option>
                    <option value="../catalogs/Other_884.mpd">Other 884/1126 (30 parts)</option>
                    <option value="../catalogs/Other_885.mpd">Other 885/1126 (30 parts)</option>
                    <option value="../catalogs/Other_886.mpd">Other 886/1126 (30 parts)</option>
                    <option value="../catalogs/Other_887.mpd">Other 887/1126 (30 parts)</option>
                    <option value="../catalogs/Other_888.mpd">Other 888/1126 (30 parts)</option>
                    <option value="../catalogs/Other_889.mpd">Other 889/1126 (30 parts)</option>
                    <option value="../catalogs/Other_890.mpd">Other 890/1126 (30 parts)</option>
                    <option value="../catalogs/Other_891.mpd">Other 891/1126 (30 parts)</option>
                    <option value="../catalogs/Other_892.mpd">Other 892/1126 (30 parts)</option>
                    <option value="../catalogs/Other_893.mpd">Other 893/1126 (30 parts)</option>
                    <option value="../catalogs/Other_894.mpd">Other 894/1126 (30 parts)</option>
                    <option value="../catalogs/Other_895.mpd">Other 895/1126 (30 parts)</option>
                    <option value="../catalogs/Other_896.mpd">Other 896/1126 (30 parts)</option>
                    <option value="../catalogs/Other_897.mpd">Other 897/1126 (30 parts)</option>
                    <option value="../catalogs/Other_898.mpd">Other 898/1126 (30 parts)</option>
                    <option value="../catalogs/Other_899.mpd">Other 899/1126 (30 parts)</option>
                    <option value="../catalogs/Other_900.mpd">Other 900/1126 (30 parts)</option>
                    <option value="../catalogs/Other_901.mpd">Other 901/1126 (30 parts)</option>
                    <option value="../catalogs/Other_902.mpd">Other 902/1126 (30 parts)</option>
                    <option value="../catalogs/Other_903.mpd">Other 903/1126 (30 parts)</option>
                    <option value="../catalogs/Other_904.mpd">Other 904/1126 (30 parts)</option>
                    <option value="../catalogs/Other_905.mpd">Other 905/1126 (30 parts)</option>
                    <option value="../catalogs/Other_906.mpd">Other 906/1126 (30 parts)</option>
                    <option value="../catalogs/Other_907.mpd">Other 907/1126 (30 parts)</option>
                    <option value="../catalogs/Other_908.mpd">Other 908/1126 (30 parts)</option>
                    <option value="../catalogs/Other_909.mpd">Other 909/1126 (30 parts)</option>
                    <option value="../catalogs/Other_910.mpd">Other 910/1126 (30 parts)</option>
                    <option value="../catalogs/Other_911.mpd">Other 911/1126 (30 parts)</option>
                    <option value="../catalogs/Other_912.mpd">Other 912/1126 (30 parts)</option>
                    <option value="../catalogs/Other_913.mpd">Other 913/1126 (30 parts)</option>
                    <option value="../catalogs/Other_914.mpd">Other 914/1126 (30 parts)</option>
                    <option value="../catalogs/Other_915.mpd">Other 915/1126 (30 parts)</option>
                    <option value="../catalogs/Other_916.mpd">Other 916/1126 (30 parts)</option>
                    <option value="../catalogs/Other_917.mpd">Other 917/1126 (30 parts)</option>
                    <option value="../catalogs/Other_918.mpd">Other 918/1126 (30 parts)</option>
                    <option value="../catalogs/Other_919.mpd">Other 919/1126 (30 parts)</option>
                    <option value="../catalogs/Other_920.mpd">Other 920/1126 (30 parts)</option>
                    <option value="../catalogs/Other_921.mpd">Other 921/1126 (30 parts)</option>
                    <option value="../catalogs/Other_922.mpd">Other 922/1126 (30 parts)</option>
                    <option value="../catalogs/Other_923.mpd">Other 923/1126 (30 parts)</option>
                    <option value="../catalogs/Other_924.mpd">Other 924/1126 (30 parts)</option>
                    <option value="../catalogs/Other_925.mpd">Other 925/1126 (30 parts)</option>
                    <option value="../catalogs/Other_926.mpd">Other 926/1126 (30 parts)</option>
                    <option value="../catalogs/Other_927.mpd">Other 927/1126 (30 parts)</option>
                    <option value="../catalogs/Other_928.mpd">Other 928/1126 (30 parts)</option>
                    <option value="../catalogs/Other_929.mpd">Other 929/1126 (30 parts)</option>
                    <option value="../catalogs/Other_930.mpd">Other 930/1126 (30 parts)</option>
                    <option value="../catalogs/Other_931.mpd">Other 931/1126 (30 parts)</option>
                    <option value="../catalogs/Other_932.mpd">Other 932/1126 (30 parts)</option>
                    <option value="../catalogs/Other_933.mpd">Other 933/1126 (30 parts)</option>
                    <option value="../catalogs/Other_934.mpd">Other 934/1126 (30 parts)</option>
                    <option value="../catalogs/Other_935.mpd">Other 935/1126 (30 parts)</option>
                    <option value="../catalogs/Other_936.mpd">Other 936/1126 (30 parts)</option>
                    <option value="../catalogs/Other_937.mpd">Other 937/1126 (30 parts)</option>
                    <option value="../catalogs/Other_938.mpd">Other 938/1126 (30 parts)</option>
                    <option value="../catalogs/Other_939.mpd">Other 939/1126 (30 parts)</option>
                    <option value="../catalogs/Other_940.mpd">Other 940/1126 (30 parts)</option>
                    <option value="../catalogs/Other_941.mpd">Other 941/1126 (30 parts)</option>
                    <option value="../catalogs/Other_942.mpd">Other 942/1126 (30 parts)</option>
                    <option value="../catalogs/Other_943.mpd">Other 943/1126 (30 parts)</option>
                    <option value="../catalogs/Other_944.mpd">Other 944/1126 (30 parts)</option>
                    <option value="../catalogs/Other_945.mpd">Other 945/1126 (30 parts)</option>
                    <option value="../catalogs/Other_946.mpd">Other 946/1126 (30 parts)</option>
                    <option value="../catalogs/Other_947.mpd">Other 947/1126 (30 parts)</option>
                    <option value="../catalogs/Other_948.mpd">Other 948/1126 (30 parts)</option>
                    <option value="../catalogs/Other_949.mpd">Other 949/1126 (30 parts)</option>
                    <option value="../catalogs/Other_950.mpd">Other 950/1126 (30 parts)</option>
                    <option value="../catalogs/Other_951.mpd">Other 951/1126 (30 parts)</option>
                    <option value="../catalogs/Other_952.mpd">Other 952/1126 (30 parts)</option>
                    <option value="../catalogs/Other_953.mpd">Other 953/1126 (30 parts)</option>
                    <option value="../catalogs/Other_954.mpd">Other 954/1126 (30 parts)</option>
                    <option value="../catalogs/Other_955.mpd">Other 955/1126 (30 parts)</option>
                    <option value="../catalogs/Other_956.mpd">Other 956/1126 (30 parts)</option>
                    <option value="../catalogs/Other_957.mpd">Other 957/1126 (30 parts)</option>
                    <option value="../catalogs/Other_958.mpd">Other 958/1126 (30 parts)</option>
                    <option value="../catalogs/Other_959.mpd">Other 959/1126 (30 parts)</option>
                    <option value="../catalogs/Other_960.mpd">Other 960/1126 (30 parts)</option>
                    <option value="../catalogs/Other_961.mpd">Other 961/1126 (30 parts)</option>
                    <option value="../catalogs/Other_962.mpd">Other 962/1126 (30 parts)</option>
                    <option value="../catalogs/Other_963.mpd">Other 963/1126 (30 parts)</option>
                    <option value="../catalogs/Other_964.mpd">Other 964/1126 (30 parts)</option>
                    <option value="../catalogs/Other_965.mpd">Other 965/1126 (30 parts)</option>
                    <option value="../catalogs/Other_966.mpd">Other 966/1126 (30 parts)</option>
                    <option value="../catalogs/Other_967.mpd">Other 967/1126 (30 parts)</option>
                    <option value="../catalogs/Other_968.mpd">Other 968/1126 (30 parts)</option>
                    <option value="../catalogs/Other_969.mpd">Other 969/1126 (30 parts)</option>
                    <option value="../catalogs/Other_970.mpd">Other 970/1126 (30 parts)</option>
                    <option value="../catalogs/Other_971.mpd">Other 971/1126 (30 parts)</option>
                    <option value="../catalogs/Other_972.mpd">Other 972/1126 (30 parts)</option>
                    <option value="../catalogs/Other_973.mpd">Other 973/1126 (30 parts)</option>
                    <option value="../catalogs/Other_974.mpd">Other 974/1126 (30 parts)</option>
                    <option value="../catalogs/Other_975.mpd">Other 975/1126 (30 parts)</option>
                    <option value="../catalogs/Other_976.mpd">Other 976/1126 (30 parts)</option>
                    <option value="../catalogs/Other_977.mpd">Other 977/1126 (30 parts)</option>
                    <option value="../catalogs/Other_978.mpd">Other 978/1126 (30 parts)</option>
                    <option value="../catalogs/Other_979.mpd">Other 979/1126 (30 parts)</option>
                    <option value="../catalogs/Other_980.mpd">Other 980/1126 (30 parts)</option>
                    <option value="../catalogs/Other_981.mpd">Other 981/1126 (30 parts)</option>
                    <option value="../catalogs/Other_982.mpd">Other 982/1126 (30 parts)</option>
                    <option value="../catalogs/Other_983.mpd">Other 983/1126 (30 parts)</option>
                    <option value="../catalogs/Other_984.mpd">Other 984/1126 (30 parts)</option>
                    <option value="../catalogs/Other_985.mpd">Other 985/1126 (30 parts)</option>
                    <option value="../catalogs/Other_986.mpd">Other 986/1126 (30 parts)</option>
                    <option value="../catalogs/Other_987.mpd">Other 987/1126 (30 parts)</option>
                    <option value="../catalogs/Other_988.mpd">Other 988/1126 (30 parts)</option>
                    <option value="../catalogs/Other_989.mpd">Other 989/1126 (30 parts)</option>
                    <option value="../catalogs/Other_990.mpd">Other 990/1126 (30 parts)</option>
                    <option value="../catalogs/Other_991.mpd">Other 991/1126 (30 parts)</option>
                    <option value="../catalogs/Other_992.mpd">Other 992/1126 (30 parts)</option>
                    <option value="../catalogs/Other_993.mpd">Other 993/1126 (30 parts)</option>
                    <option value="../catalogs/Other_994.mpd">Other 994/1126 (30 parts)</option>
                    <option value="../catalogs/Other_995.mpd">Other 995/1126 (30 parts)</option>
                    <option value="../catalogs/Other_996.mpd">Other 996/1126 (30 parts)</option>
                    <option value="../catalogs/Other_997.mpd">Other 997/1126 (30 parts)</option>
                    <option value="../catalogs/Other_998.mpd">Other 998/1126 (30 parts)</option>
                    <option value="../catalogs/Other_999.mpd">Other 999/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1000.mpd">Other 1000/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1001.mpd">Other 1001/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1002.mpd">Other 1002/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1003.mpd">Other 1003/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1004.mpd">Other 1004/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1005.mpd">Other 1005/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1006.mpd">Other 1006/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1007.mpd">Other 1007/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1008.mpd">Other 1008/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1009.mpd">Other 1009/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1010.mpd">Other 1010/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1011.mpd">Other 1011/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1012.mpd">Other 1012/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1013.mpd">Other 1013/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1014.mpd">Other 1014/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1015.mpd">Other 1015/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1016.mpd">Other 1016/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1017.mpd">Other 1017/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1018.mpd">Other 1018/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1019.mpd">Other 1019/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1020.mpd">Other 1020/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1021.mpd">Other 1021/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1022.mpd">Other 1022/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1023.mpd">Other 1023/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1024.mpd">Other 1024/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1025.mpd">Other 1025/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1026.mpd">Other 1026/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1027.mpd">Other 1027/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1028.mpd">Other 1028/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1029.mpd">Other 1029/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1030.mpd">Other 1030/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1031.mpd">Other 1031/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1032.mpd">Other 1032/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1033.mpd">Other 1033/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1034.mpd">Other 1034/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1035.mpd">Other 1035/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1036.mpd">Other 1036/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1037.mpd">Other 1037/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1038.mpd">Other 1038/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1039.mpd">Other 1039/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1040.mpd">Other 1040/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1041.mpd">Other 1041/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1042.mpd">Other 1042/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1043.mpd">Other 1043/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1044.mpd">Other 1044/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1045.mpd">Other 1045/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1046.mpd">Other 1046/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1047.mpd">Other 1047/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1048.mpd">Other 1048/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1049.mpd">Other 1049/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1050.mpd">Other 1050/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1051.mpd">Other 1051/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1052.mpd">Other 1052/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1053.mpd">Other 1053/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1054.mpd">Other 1054/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1055.mpd">Other 1055/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1056.mpd">Other 1056/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1057.mpd">Other 1057/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1058.mpd">Other 1058/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1059.mpd">Other 1059/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1060.mpd">Other 1060/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1061.mpd">Other 1061/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1062.mpd">Other 1062/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1063.mpd">Other 1063/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1064.mpd">Other 1064/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1065.mpd">Other 1065/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1066.mpd">Other 1066/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1067.mpd">Other 1067/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1068.mpd">Other 1068/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1069.mpd">Other 1069/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1070.mpd">Other 1070/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1071.mpd">Other 1071/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1072.mpd">Other 1072/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1073.mpd">Other 1073/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1074.mpd">Other 1074/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1075.mpd">Other 1075/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1076.mpd">Other 1076/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1077.mpd">Other 1077/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1078.mpd">Other 1078/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1079.mpd">Other 1079/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1080.mpd">Other 1080/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1081.mpd">Other 1081/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1082.mpd">Other 1082/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1083.mpd">Other 1083/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1084.mpd">Other 1084/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1085.mpd">Other 1085/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1086.mpd">Other 1086/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1087.mpd">Other 1087/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1088.mpd">Other 1088/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1089.mpd">Other 1089/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1090.mpd">Other 1090/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1091.mpd">Other 1091/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1092.mpd">Other 1092/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1093.mpd">Other 1093/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1094.mpd">Other 1094/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1095.mpd">Other 1095/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1096.mpd">Other 1096/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1097.mpd">Other 1097/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1098.mpd">Other 1098/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1099.mpd">Other 1099/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1100.mpd">Other 1100/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1101.mpd">Other 1101/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1102.mpd">Other 1102/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1103.mpd">Other 1103/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1104.mpd">Other 1104/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1105.mpd">Other 1105/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1106.mpd">Other 1106/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1107.mpd">Other 1107/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1108.mpd">Other 1108/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1109.mpd">Other 1109/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1110.mpd">Other 1110/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1111.mpd">Other 1111/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1112.mpd">Other 1112/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1113.mpd">Other 1113/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1114.mpd">Other 1114/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1115.mpd">Other 1115/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1116.mpd">Other 1116/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1117.mpd">Other 1117/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1118.mpd">Other 1118/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1119.mpd">Other 1119/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1120.mpd">Other 1120/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1121.mpd">Other 1121/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1122.mpd">Other 1122/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1123.mpd">Other 1123/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1124.mpd">Other 1124/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1125.mpd">Other 1125/1126 (30 parts)</option>
                    <option value="../catalogs/Other_1126.mpd">Other 1126/1126 (28 parts)</option>
                    <option value="../catalogs/Technic_01.mpd">Technic 1/1 (4 parts)</option>
<option value="../fabuland-raccoons.mpd">üß± SIMPLE TEST (3 bricks)</option>
                    <option value="../monkey-data-center-working.mpd">DATA CENTER ‚úÖ</option>
                    <option value="../minifig-configurator.mpd">MINIFIG LIB</option>
                    <option value="../rocket_launch_scene.ldr">ROCKET üöÄ</option>
                    <option value="../truck_full_200pieces.mpd">TRUCK</option>
                    <option value="../mars-rover.mpd">MARS ROVER</option>
                    <option value="../barbie-jeep.mpd">BARBIE JEEP</option>
                    <option value="../hello-world.mpd">HELLO WORLD</option>
                    <option value="../all_watched_over.mpd">ALL WATCHED OVER</option>
                    <option value="../stanza_1 (1).mpd">STANZA 1</option>
                    <option value="../stanza_2 (1).mpd">STANZA 2</option>
                    <option value="../stanza_3.mpd">STANZA 3</option>
                </optgroup>
            </select>
            <span id="status-text">Ready</span>
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center;">
            <span id="model-stats">No model loaded</span>
            <span id="lib-status" style="font-size: 10px; color: var(--text-tertiary);">Library: Loading...</span>
        </div>
        
        <button class="footer-corner-btn" id="new-scene-btn" title="New Scene">+</button>
    </footer>
    
    <!-- Grace Error Panel (slides up from bottom) -->
    <div id="grace-error-panel">
        <div class="grace-error-header">
            <span>üíö Grace Report - Missing Parts</span>
            <div style="display: flex; gap: 8px;">
                <button class="grace-error-copy" onclick="copyGraceErrors()">üìã COPY</button>
                <button class="grace-error-copy" onclick="closeGracePanel()">‚úï CLOSE</button>
            </div>
        </div>
        <div id="grace-error-list"></div>
    </div>
    
    <!-- Paste Zone (overlay) -->
    <div id="paste-zone">
        <h3 style="color:var(--accent);margin-bottom:12px;">Paste MPD Content</h3>
        <textarea id="paste-textarea" placeholder="Paste entire MPD file here..."></textarea>
        <div class="paste-buttons">
            <button class="panel-btn" id="paste-load-btn" style="padding: 8px 20px;">Load</button>
            <button class="panel-btn" id="paste-cancel-btn" style="padding: 8px 20px;">Cancel</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
    <script src="./examples/js/loaders/LDrawLoader.js?v=11"></script>
    <script src="./beta-prime-engine.js"></script>
    <script>
    const wagFrankBus = (typeof BroadcastChannel !== 'undefined') ? new BroadcastChannel('wag-frank') : null;
    const wagFrankPost = (message) => {
        if (!wagFrankBus) return;
        wagFrankBus.postMessage(message);
    };

    const AI_FILE_PATTERN = /^ai[\s_\-\(\.]?/i;
    const LIBRARY_BASE = './ldraw/';
    const ROOT_PREFIX_FROM_LIBRARY = '../';

    // Global error log (Bronze-style)
    const ERROR_LOG = [];
    
    // Grace Editor: Track missing parts for graceful rendering
    const MISSING_PARTS = new Map(); // partName -> { lineNumbers: [], count: number }
    const PLACEHOLDER_CACHE = new Map(); // Store created placeholder geometries
    let graceSystemReady = false;
    
    function logError(context, error) {
        const entry = {
            time: new Date().toISOString(),
            context: context,
            message: error.message || String(error),
            stack: error.stack || '',
            line: error.lineNumber || null
        };
        ERROR_LOG.push(entry);
        console.error(`[${context}]`, error);
        
        // Force update of error warning button
        setTimeout(() => updateErrorWarning(), 100);
    }
    
    function updateErrorWarning() {
        let errorBtn = document.getElementById('error-warning-btn');
        if (!errorBtn) {
            errorBtn = document.createElement('button');
            errorBtn.id = 'error-warning-btn';
            errorBtn.className = 'corner-btn';
            errorBtn.style.cssText = 'background: var(--error); color: #000; font-weight: 700; margin-left: 4px;';
            errorBtn.title = 'Console Errors - Click to copy';
            errorBtn.textContent = `‚ö† ${ERROR_LOG.length}`;
            
            errorBtn.addEventListener('click', () => {
                const logText = ERROR_LOG.map(e => 
                    `[${e.time}] ${e.context}: ${e.message}\n${e.stack}`
                ).join('\n\n');
                
                navigator.clipboard.writeText(logText).then(() => {
                    const statusText = document.getElementById('status-text');
                    if (statusText) {
                        statusText.textContent = `üìã Copied ${ERROR_LOG.length} errors!`;
                        statusText.style.color = 'var(--error)';
                        statusText.style.fontWeight = '700';
                        setTimeout(() => {
                            statusText.textContent = 'Ready';
                            statusText.style.color = '';
                            statusText.style.fontWeight = '';
                        }, 2000);
                    }
                });
            });
            
            const themeBtn = document.getElementById('theme-btn');
            if (themeBtn && themeBtn.parentNode) {
                themeBtn.parentNode.insertBefore(errorBtn, themeBtn.nextSibling);
            }
        } else {
            errorBtn.textContent = `‚ö† ${ERROR_LOG.length}`;
            errorBtn.style.display = ERROR_LOG.length > 0 ? 'block' : 'none';
        }
    }

    const STATE = {
        scenes: [],
        activeSceneIdx: 0,
        viewer: null,
        autoSpin: false,
        diagnostics: {
            grid: true,
            axes: true,
            flipY: false,
            wireframe: false,
            showEdges: true,
            backfaceCull: false,
            skeletonOnly: false,
            studNormal: true,
            studProblem: true,
            studGhost: true
        },
        libraryFileMap: null,  // Still need this for LDraw parts
        groundOriginalLines: null,
        groundActive: false
    };
    
    let editorContainer = null;  // Will be set on init
    let editorLines = [];  // Current lines array
    let selectedLines = new Set();  // Multi-selection set for editor line indices
    let selectionBoundingBox = null; // 3D group holding current selection bounding boxes / axes
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GRACE EDITOR: Graceful Error Handling System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function createPlaceholder(partName, position = {x: 0, y: 0, z: 0}) {
        // Safety check: THREE must be loaded
        if (typeof THREE === 'undefined') {
            console.warn('üíö THREE.js not loaded yet, deferring placeholder creation');
            return null;
        }
        
        // Check cache first
        if (PLACEHOLDER_CACHE.has(partName)) {
            return PLACEHOLDER_CACHE.get(partName).clone();
        }
        
        // Create a loving pink cube with label
        const geometry = new THREE.BoxGeometry(20, 20, 20);
        const material = new THREE.MeshBasicMaterial({
            color: 0xff69b4,  // Hot pink
            transparent: true,
            opacity: 0.6,
            wireframe: false
        });
        const cube = new THREE.Mesh(geometry, material);
        
        // Add wireframe edges
        const edges = new THREE.EdgesGeometry(geometry);
        const line = new THREE.LineSegments(edges, 
            new THREE.LineBasicMaterial({ color: 0xff1493, linewidth: 2 })
        );
        cube.add(line);
        
        // Store in cache
        PLACEHOLDER_CACHE.set(partName, cube);
        
        console.log(`üíö Created placeholder for missing part: ${partName}`);
        return cube.clone();
    }
    
    function trackMissingPart(partName, lineNumber) {
        if (!MISSING_PARTS.has(partName)) {
            MISSING_PARTS.set(partName, {
                lineNumbers: [],
                count: 0
            });
        }
        
        const entry = MISSING_PARTS.get(partName);
        if (!entry.lineNumbers.includes(lineNumber)) {
            entry.lineNumbers.push(lineNumber);
        }
        entry.count++;
        
        console.warn(`‚ö†Ô∏è Line ${lineNumber}: Missing part "${partName}" (${entry.count} total occurrences)`);
    }
    
    function showGraceReport() {
        if (MISSING_PARTS.size === 0) {
            console.log('üíö Perfect! No missing parts.');
            closeGracePanel();
            return;
        }
        
        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üíö MACHINE OF LOVING GRACE - Missing Parts Report');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`Scene rendered with ${MISSING_PARTS.size} missing components:\n`);
        
        MISSING_PARTS.forEach((data, partName) => {
            console.log(`  üì¶ ${partName}`);
            console.log(`     Occurrences: ${data.count}`);
            console.log(`     Lines: ${data.lineNumbers.join(', ')}`);
            console.log(`     üí° Tip: Check if this should be "parts/${partName}"\n`);
        });
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`‚úÖ Scene loaded successfully with ${MISSING_PARTS.size} placeholders`);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        
        // Show visual error panel with clickable lines
        const panel = document.getElementById('grace-error-panel');
        const list = document.getElementById('grace-error-list');
        
        list.innerHTML = '';
        
        MISSING_PARTS.forEach((data, partName) => {
            data.lineNumbers.forEach(lineNum => {
                const item = document.createElement('div');
                item.className = 'grace-error-item';
                item.innerHTML = `<span class="grace-error-line">Line ${lineNum}:</span> Missing "${partName}" <span style="opacity:0.7">(${data.count}x total)</span>`;
                
                // Click to highlight line in editor
                item.addEventListener('click', () => {
                    highlightErrorLine(lineNum);
                    scrollToLine(lineNum);
                });
                
                list.appendChild(item);
            });
        });
        
        panel.classList.add('visible');
        
        // Highlight all error lines in editor
        highlightAllErrorLines();
    }
    
    function highlightAllErrorLines() {
        // Clear previous error highlights
        document.querySelectorAll('.editor-line.missing-part').forEach(el => {
            el.classList.remove('missing-part');
        });
        
        // Highlight all lines with missing parts
        MISSING_PARTS.forEach((data, partName) => {
            data.lineNumbers.forEach(lineNum => {
                const lineIndex = lineNum - 1; // Convert to 0-based index
                const lineEl = editorContainer.children[lineIndex];
                if (lineEl) {
                    lineEl.classList.add('missing-part');
                }
            });
        });
    }
    
    function highlightErrorLine(lineNum) {
        // Clear previous highlights
        document.querySelectorAll('.editor-line.highlighted').forEach(el => {
            el.classList.remove('highlighted');
        });
        
        const lineIndex = lineNum - 1;
        const lineEl = editorContainer.children[lineIndex];
        if (lineEl) {
            lineEl.classList.add('highlighted');
            lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function scrollToLine(lineNum) {
        const lineIndex = lineNum - 1;
        const lineEl = editorContainer.children[lineIndex];
        if (lineEl) {
            lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function copyGraceErrors() {
        let text = 'üíö GRACE REPORT - Missing Parts\n';
        text += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
        
        MISSING_PARTS.forEach((data, partName) => {
            text += `üì¶ ${partName}\n`;
            text += `   Occurrences: ${data.count}\n`;
            text += `   Lines: ${data.lineNumbers.join(', ')}\n`;
            text += `   üí° Tip: Check if this should be "parts/${partName}"\n\n`;
        });
        
        text += `\n‚úÖ Scene loaded with ${MISSING_PARTS.size} placeholders\n`;
        
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target;
            const orig = btn.textContent;
            btn.textContent = '‚úì COPIED!';
            setTimeout(() => btn.textContent = orig, 2000);
        });
    }
    
    function closeGracePanel() {
        const panel = document.getElementById('grace-error-panel');
        panel.classList.remove('visible');
    }
    
    // Intercept fetch to catch 404s gracefully and CREATE PLACEHOLDERS!
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        return originalFetch.apply(this, args).then(response => {
            if (!response.ok && response.status === 404) {
                const url = args[0];
                const partName = url.split('/').pop();
                console.warn(`üíö Grace: 404 for ${partName}, creating placeholder`);
                
                // Track this missing part (we don't have line number here, will add later)
                if (!MISSING_PARTS.has(partName)) {
                    MISSING_PARTS.set(partName, {
                        lineNumbers: [],
                        count: 0
                    });
                }
                const entry = MISSING_PARTS.get(partName);
                entry.count++;
                
                // üíö GRACE: Return fake pink cube geometry so it actually renders!
                // Simple 20x20x20 pink box using quad primitives
                const fakeData = `0 FILE ${partName}
0 üíö GRACE PLACEHOLDER - Part not found
0 Name: ${partName}
0 BFC CERTIFY CCW

0 // Pink cube geometry (20x20x20 LDU)
4 494 -10 -10 -10  10 -10 -10  10 -10  10 -10 -10  10
4 494 -10  10 -10 -10  10  10  10  10  10  10  10 -10
4 494 -10 -10 -10 -10 -10  10 -10  10  10 -10  10 -10
4 494  10 -10 -10  10  10 -10  10  10  10  10 -10  10
4 494 -10 -10  10  10 -10  10  10  10  10 -10  10  10
4 494 -10 -10 -10 -10  10 -10  10  10 -10  10 -10 -10
`;
                return new Response(fakeData, {
                    status: 200,
                    statusText: 'OK (Grace Placeholder)',
                    headers: { 'Content-Type': 'text/plain' }
                });
            }
            return response;
        });
    };
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function createScene(name, initialLines = []) {
        return {
            name: name || `Scene ${STATE.scenes.length + 1}`,
            lines: initialLines.length ? initialLines : [
                '0 FILE untitled.mpd',
                '0 Name: untitled',
                '0 Author: ',
                '0 ',
                '0 WRITE YOUR DESCRIPTION HERE',
                '0 ',
                '0 BFC CERTIFY CCW',
                '0 ',
                '0 !CATEGORY ',
                '0 ',
                ''
            ],
            lockedLines: new Set(),
            timestamp: Date.now()
        };
    }
    
    function renderEditor(lines) {
        if (!editorContainer) editorContainer = document.getElementById('mpd-editor');
        if (!editorContainer) return;
        
        editorContainer.innerHTML = '';
        
        lines.forEach((line, idx) => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'editor-line';
            lineDiv.dataset.lineNum = idx + 1;
            
            const trimmed = line.trim();
            const isComment = trimmed.startsWith('0 ');
            const isPart = trimmed.startsWith('1 ');
            const isFile = trimmed.startsWith('0 FILE');
            const isStep = trimmed.startsWith('0 STEP');
            const scene = STATE.scenes[STATE.activeSceneIdx];
            const isLocked = scene && scene.lockedLines.has(idx);
            
            if (isLocked) lineDiv.classList.add('locked');
            if (isFile) lineDiv.classList.add('file-line');
            if (isStep) lineDiv.classList.add('step-line');
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'line-checkbox';
            checkbox.checked = true;
            checkbox.addEventListener('change', () => {
                content.classList.toggle('disabled', !checkbox.checked);
                // Don't auto-compile on checkbox change - use Render button
            });
            lineDiv.appendChild(checkbox);
            
            // Line number
            const lineNum = document.createElement('span');
            lineNum.className = 'line-number';
            lineNum.textContent = idx + 1;
            lineDiv.appendChild(lineNum);
            
            // Right-click context menu
            lineDiv.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showLineContextMenu(e, idx);
            });
                
            // Click line ‚Üí highlight on 2D grid / select section
            lineDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('line-checkbox')) return;

                const trimmed = line.trim();
                const isComment = trimmed.startsWith('0 ');
                const isFile = trimmed.startsWith('0 FILE');
                const isStep = trimmed.startsWith('0 STEP');
                const isMeta = trimmed.startsWith('0 !');
                const isHeader = isComment && !isFile && !isStep && !isMeta && !trimmed.startsWith('0 Name:') && !trimmed.startsWith('0 Author:');

                // Cmd/Ctrl+click for multi-selection
                if (e.metaKey || e.ctrlKey) {
                    toggleLineSelection(idx);
                    return;
                }

                // Header comments act as section markers
                if (isHeader) {
                    selectSection(idx);
                } else {
                    highlightLineOn2DGrid(idx);
                }
            });
            
            // Double-click line ‚Üí select section
            lineDiv.addEventListener('dblclick', (e) => {
                if (e.target.classList.contains('line-checkbox')) return;
                selectSection(idx);
            });
            
            // Content (contentEditable!)
            const content = document.createElement('span');
            content.className = `line-content ${isPart ? 'part' : isComment ? 'comment' : ''}`;
            content.textContent = line || ' ';
            content.contentEditable = !isLocked; // Lock mode prevents editing
            content.spellcheck = false;
            
            // Save on blur
            content.addEventListener('blur', () => {
                editorLines[idx] = content.textContent;
            });
            
            // Paste handler - SIMPLE & ELEGANT!
            content.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                const lines = text.split('\n');
                
                // If pasting many lines (10+), start fresh with new file
                if (lines.length >= 10) {
                    console.log(`üíö Grace: Pasting ${lines.length} lines - creating new file from scratch`);
                    
                    // Replace entire editor with pasted content
                    editorLines.length = 0;
                    editorLines.push(...lines);
                    
                    renderEditor(editorLines);
                    
                    document.getElementById('status-text').textContent = `üíö Pasted ${lines.length} lines - new file created`;
                    
                    // Auto-compile if it looks like MPD
                    if (text.includes('0 FILE') || text.includes('parts/')) {
                        setTimeout(() => compile(), 500);
                    }
                }
                // Few lines (1-9) - insert at current position
                else if (lines.length > 1) {
                    editorLines[idx] = lines[0];
                    editorLines.splice(idx + 1, 0, ...lines.slice(1));
                    renderEditor(editorLines);
                    setTimeout(() => {
                        const newLine = editorContainer.children[idx + lines.length - 1];
                        if (newLine) newLine.querySelector('.line-content').focus();
                    }, 0);
                }
                // Single line - insert at cursor
                else {
                    document.execCommand('insertText', false, text);
                }
            });
            
            // Keyboard shortcuts
            content.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    editorLines.splice(idx + 1, 0, '');
                    renderEditor(editorLines);
                    setTimeout(() => {
                        const nextLine = editorContainer.children[idx + 1];
                        if (nextLine) nextLine.querySelector('.line-content').focus();
                    }, 0);
                }
                // Delete/Backspace on empty line = delete line
                else if ((e.key === 'Delete' || e.key === 'Backspace') && !content.textContent.trim()) {
                    e.preventDefault();
                    if (editorLines.length > 1) {
                        deleteLine(idx);
                    }
                }
                // Arrow keys = navigate lines
                else if (e.key === 'ArrowUp' && !e.shiftKey) {
                    const sel = window.getSelection();
                    if (sel.anchorOffset === 0 && idx > 0) {
                        e.preventDefault();
                        const prevLine = editorContainer.children[idx - 1];
                        if (prevLine) prevLine.querySelector('.line-content').focus();
                    }
                }
                else if (e.key === 'ArrowDown' && !e.shiftKey) {
                    const sel = window.getSelection();
                    const atEnd = sel.anchorOffset === content.textContent.length;
                    if (atEnd && idx < editorLines.length - 1) {
                        e.preventDefault();
                        const nextLine = editorContainer.children[idx + 1];
                        if (nextLine) nextLine.querySelector('.line-content').focus();
                    }
                }
                // Ctrl+D = duplicate line
                else if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    editorLines.splice(idx + 1, 0, editorLines[idx]);
                    renderEditor(editorLines);
                    setTimeout(() => {
                        const newLine = editorContainer.children[idx + 1];
                        if (newLine) newLine.querySelector('.line-content').focus();
                    }, 0);
                }
                // Ctrl+Up/Down = move line
                else if (e.ctrlKey && e.key === 'ArrowUp') {
                    e.preventDefault();
                    moveLine(idx, -1);
                }
                else if (e.ctrlKey && e.key === 'ArrowDown') {
                    e.preventDefault();
                    moveLine(idx, 1);
                }
                // Cmd/Ctrl+S or Cmd/Ctrl+Enter ‚Üí Compile
                if ((e.metaKey || e.ctrlKey) && (e.key === 's' || e.key === 'S')) {
                    e.preventDefault();
                    compileCurrentMPD();
                }
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    compileCurrentMPD();
                }
                // Cmd/Ctrl+C ‚Üí Copy selection
                if ((e.metaKey || e.ctrlKey) && e.key === 'c' && selectedLines.size > 0) {
                    e.preventDefault();
                    copySelection();
                }
            });
            
            lineDiv.appendChild(content);
            editorContainer.appendChild(lineDiv);
        });
        
        renderMinimap(lines);
    }
    
    function renderMinimap(lines) {
        const minimap = document.getElementById('mpd-minimap');
        if (!minimap) return;
        
        minimap.innerHTML = '';
        const stripHeight = Math.max(2, Math.floor(minimap.clientHeight / lines.length));
        
        lines.forEach((line, idx) => {
            const strip = document.createElement('div');
            strip.className = 'mpd-minimap-strip';
            strip.style.height = stripHeight + 'px';
            
            const trimmed = line.trim();
            if (trimmed.startsWith('1 ')) {
                strip.classList.add('part');
            } else if (trimmed.startsWith('0 ')) {
                strip.classList.add('comment');
            } else {
                strip.classList.add('empty');
            }
            
            const scene = STATE.scenes[STATE.activeSceneIdx];
            if (scene && scene.lockedLines.has(idx)) {
                strip.classList.add('locked');
            }
            
            strip.addEventListener('click', () => {
                const lineEl = editorContainer.children[idx];
                if (lineEl) {
                    lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    lineEl.querySelector('.line-content').focus();
                }
            });
            
            minimap.appendChild(strip);
        });
    }
    
    // Line manipulation functions (Bronze parity)
    async function compileCurrentMPD() {
        const scene = STATE.scenes[STATE.activeSceneIdx];
        if (!scene || !scene.lines.length) {
            console.warn('‚ö†Ô∏è No MPD lines to compile');
            return;
        }
        await compile();
    }
    
    function deleteLine(idx) {
        const scene = STATE.scenes[STATE.activeSceneIdx];
        if (scene.lockedLines.has(idx)) {
            document.getElementById('status-text').textContent = 'Line is locked';
            return;
        }
        if (editorLines.length === 1) {
            editorLines[0] = '';
            renderEditor(editorLines);
            return;
        }
        editorLines.splice(idx, 1);
        // Update locked lines indices
        const newLocked = new Set();
        scene.lockedLines.forEach(i => {
            if (i < idx) newLocked.add(i);
            else if (i > idx) newLocked.add(i - 1);
        });
        scene.lockedLines = newLocked;
        renderEditor(editorLines);
        document.getElementById('status-text').textContent = 'Line deleted';
    }
    
    function moveLine(idx, direction) {
        const scene = STATE.scenes[STATE.activeSceneIdx];
        if (scene.lockedLines.has(idx)) {
            document.getElementById('status-text').textContent = 'Line is locked';
            return;
        }
        const newIdx = idx + direction;
        if (newIdx < 0 || newIdx >= editorLines.length) return;
        
        // Swap lines
        [editorLines[idx], editorLines[newIdx]] = [editorLines[newIdx], editorLines[idx]];
        
        // Update locked lines
        const wasLocked = scene.lockedLines.has(idx);
        const targetWasLocked = scene.lockedLines.has(newIdx);
        if (wasLocked) {
            scene.lockedLines.delete(idx);
            scene.lockedLines.add(newIdx);
        }
        if (targetWasLocked) {
            scene.lockedLines.delete(newIdx);
            scene.lockedLines.add(idx);
        }
        
        renderEditor(editorLines);
        
        // Scroll to moved line
        setTimeout(() => {
            const movedLine = editorContainer.children[newIdx];
            if (movedLine) {
                movedLine.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                movedLine.querySelector('.line-content').focus();
            }
        }, 50);
        
        document.getElementById('status-text').textContent = direction > 0 ? 'Moved down' : 'Moved up';
    }
    
    function toggleLock(idx) {
        const scene = STATE.scenes[STATE.activeSceneIdx];
        if (scene.lockedLines.has(idx)) {
            scene.lockedLines.delete(idx);
            document.getElementById('status-text').textContent = 'Unlocked';
        } else {
            scene.lockedLines.add(idx);
            document.getElementById('status-text').textContent = 'Locked';
        }
        renderEditor(editorLines);
    }
    
    function showLineContextMenu(e, idx) {
        const scene = STATE.scenes[STATE.activeSceneIdx];
        const isLocked = scene.lockedLines.has(idx);
        
        // Create proper context menu (Bronze style)
        const existingMenu = document.getElementById('line-context-menu');
        if (existingMenu) existingMenu.remove();
        
        const menu = document.createElement('div');
        menu.id = 'line-context-menu';
        menu.style.cssText = `
            position: fixed;
            left: ${e.clientX}px;
            top: ${e.clientY}px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 4px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            min-width: 180px;
        `;

        const hasSelection = selectedLines && selectedLines.size > 0;
        const inSelection = hasSelection && selectedLines.has(idx);
        const useSelection = hasSelection && inSelection;

        const headerLabel = useSelection
            ? `Selection (${selectedLines.size} line${selectedLines.size > 1 ? 's' : ''})`
            : `Line ${idx + 1}`;

        const items = [
            { label: headerLabel, action: null, style: 'font-weight: 700; color: var(--accent); padding: 4px 8px; border-bottom: 1px solid var(--border-primary);' },
            { label: isLocked ? 'üîì Unlock' : 'üîí Lock', action: () => toggleLock(idx) },
            {
                label: useSelection ? 'üìã Copy Selection' : 'üìã Copy Line',
                action: () => useSelection ? copySelection() : copyLine(idx)
            },
            {
                label: useSelection ? '‚úÇÔ∏è Cut Selection' : '‚úÇÔ∏è Cut Line',
                action: () => useSelection ? cutSelection() : cutLine(idx)
            },
            { label: 'üìù Duplicate', action: () => duplicateLine(idx) },
            { label: '‚ûï Insert Above', action: () => insertLine(idx, 'above') },
            { label: '‚ûï Insert Below', action: () => insertLine(idx, 'below') },
            { label: '---', action: null },
            { label: '‚Üë Move Up', action: () => moveLine(idx, -1) },
            { label: '‚Üì Move Down', action: () => moveLine(idx, 1) },
            {
                label: useSelection ? 'üóë Delete Selection' : 'üóë Delete Line',
                action: () => useSelection ? deleteSelection() : deleteLine(idx)
            },
        ];
        
        items.forEach(item => {
            if (item.label === '---') {
                const divider = document.createElement('div');
                divider.style.cssText = 'height: 1px; background: var(--border-primary); margin: 4px 0;';
                menu.appendChild(divider);
            } else {
                const menuItem = document.createElement('div');
                menuItem.textContent = item.label;
                menuItem.style.cssText = item.style || `
                    padding: 6px 12px;
                    cursor: ${item.action ? 'pointer' : 'default'};
                    color: var(--text-primary);
                    font-size: 12px;
                    transition: background 0.1s;
                `;
                
                if (item.action) {
                    menuItem.addEventListener('mouseenter', () => {
                        menuItem.style.background = 'var(--accent)';
                        menuItem.style.color = '#000';
                    });
                    menuItem.addEventListener('mouseleave', () => {
                        menuItem.style.background = '';
                        menuItem.style.color = 'var(--text-primary)';
                    });
                    menuItem.addEventListener('click', () => {
                        item.action();
                        menu.remove();
                    });
                }
                
                menu.appendChild(menuItem);
            }
        });
        
        document.body.appendChild(menu);
        
        // Close on click outside
        const closeMenu = (e2) => {
            if (!menu.contains(e2.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 10);
    }
    
    function copyLine(idx) {
        const line = editorLines[idx];
        navigator.clipboard.writeText(line).then(() => {
            const statusText = document.getElementById('status-text');
            statusText.textContent = 'üìã Copied!';
            statusText.style.color = 'var(--accent)';
            statusText.style.fontWeight = '700';
            setTimeout(() => {
                statusText.textContent = 'Ready';
                statusText.style.color = '';
                statusText.style.fontWeight = '';
            }, 1500);
        }).catch(err => {
            console.error('Copy failed:', err);
            document.getElementById('status-text').textContent = 'Copy failed';
        });
    }
    
    function cutLine(idx) {
        navigator.clipboard.writeText(editorLines[idx]);
        deleteLine(idx);
        document.getElementById('status-text').textContent = 'Line cut';
    }
    
    function duplicateLine(idx) {
        editorLines.splice(idx + 1, 0, editorLines[idx]);
        STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
        renderEditor(editorLines);
        document.getElementById('status-text').textContent = 'Line duplicated';
    }
    
    function insertLine(idx, position) {
        const newIdx = position === 'above' ? idx : idx + 1;
        editorLines.splice(newIdx, 0, '');
        STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
        renderEditor(editorLines);
        document.getElementById('status-text').textContent = `Line inserted ${position}`;
    }
    
    function highlightErrorLine(lineIdx, errorMsg) {
        console.log('[ERROR HIGHLIGHT] Attempting to highlight line', lineIdx, errorMsg);
        
        // Try multiple selectors
        let lineDiv = document.querySelector(`[data-line-idx="${lineIdx}"]`);
        if (!lineDiv) {
            lineDiv = document.querySelector(`.line-wrapper[data-line-idx="${lineIdx}"]`);
        }
        if (!lineDiv) {
            const allLines = document.querySelectorAll('.line-wrapper');
            if (allLines[lineIdx]) {
                lineDiv = allLines[lineIdx];
            }
        }
        
        if (lineDiv) {
            console.log('[ERROR HIGHLIGHT] Found line element, highlighting...');
            lineDiv.style.background = 'rgba(255, 0, 0, 0.2)';
            lineDiv.style.borderLeft = '3px solid var(--error)';
            lineDiv.style.transition = 'all 0.3s';
            lineDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Add error indicator
            const errorIndicator = document.createElement('span');
            errorIndicator.className = 'error-indicator';
            errorIndicator.textContent = ' ‚ö†Ô∏è';
            errorIndicator.title = errorMsg;
            errorIndicator.style.cssText = 'color: var(--error); font-weight: 700; margin-left: 8px; font-size: 16px;';
            lineDiv.appendChild(errorIndicator);
            
            // Clear after 8 seconds
            setTimeout(() => {
                lineDiv.style.background = '';
                lineDiv.style.borderLeft = '';
                const indicator = lineDiv.querySelector('.error-indicator');
                if (indicator) indicator.remove();
            }, 8000);
        } else {
            console.warn('[ERROR HIGHLIGHT] Could not find line element at index', lineIdx);
        }
    }
    
    function showLoadingOverlay(text = 'Loading...', subtext = 'Please wait...') {
        const loadingEl = document.getElementById('loading');
        const loadingText = loadingEl?.querySelector('.loading-text');
        const loadingSubtext = loadingEl?.querySelector('.loading-subtext');
        
        if (loadingEl) {
            loadingEl.classList.add('active');
            if (loadingText) loadingText.textContent = text;
            if (loadingSubtext) loadingSubtext.textContent = subtext;
            
            // Simulate progress with random MPD line previews
            simulateProgress();
        }
    }
    
    function simulateProgress() {
        const subtext = document.querySelector('.loading-subtext');
        if (!subtext) return;
        
        const steps = [
            'Parsing MPD structure...',
            'Processing part references...',
            'Loading 3D geometry...',
            'Building mesh hierarchy...',
            'Applying materials...',
            'Optimizing scene...',
            'Finalizing render...'
        ];
        
        let step = 0;
        const interval = setInterval(() => {
            if (!document.getElementById('loading').classList.contains('active')) {
                clearInterval(interval);
                return;
            }
            
            if (step < steps.length) {
                subtext.textContent = steps[step];
                step++;
            } else {
                clearInterval(interval);
            }
        }, 400);
    }
    
    function hideLoadingOverlay() {
        const loadingEl = document.getElementById('loading');
        if (loadingEl) loadingEl.classList.remove('active');
    }
    
    async function compile() {
        showLoadingOverlay('Compiling MPD...', 'Parsing lines and preparing 3D model...');
        
        // üíö GRACE: Always hide loading after 12 seconds max (compile + render timeout)
        const compileTimeout = setTimeout(() => {
            console.warn('üíö Grace: Compile timeout - forcing display');
            hideLoadingOverlay();
            document.getElementById('status-text').textContent = 'üíö Compile completed (check for errors)';
        }, 12000);
        
        // Safety check: Don't compile if viewer or file map not ready
        if (!STATE.viewer) {
            console.warn('‚ö†Ô∏è Viewer not initialized yet');
            clearTimeout(compileTimeout);
            hideLoadingOverlay();
            return;
        }
        if (!STATE.libraryFileMap || Object.keys(STATE.libraryFileMap).length === 0) {
            console.warn('‚ö†Ô∏è Library catalog not loaded yet - waiting...');
            clearTimeout(compileTimeout);
            hideLoadingOverlay();
            const statusText = document.getElementById('status-text');
            if (statusText) statusText.textContent = 'Library loading...';
            return;
        }
        
        // Parse MPD to track line numbers (Bronze method!)
        const lineMap = [];
        editorLines.forEach((line, idx) => {
            const trimmed = line.trim();
            if (trimmed && trimmed.startsWith('1 ')) {
                lineMap.push({ originalLineIdx: idx, lineContent: line });
            }
        });
        STATE.currentLineMap = lineMap;
        console.log('[COMPILE] Tracked', lineMap.length, 'part lines for click-to-highlight');
        
        // Animate compile (FAST - 5ms per line, 300ms duration)
        const lines = editorContainer.querySelectorAll('.editor-line');
        lines.forEach((line, idx) => {
            setTimeout(() => {
                line.classList.add('compiling');
                setTimeout(() => line.classList.remove('compiling'), 300);
            }, idx * 5);  // 5ms per line (was 20ms - 4x faster!)
        });
        
        // Get enabled lines only
        const enabledLines = [];
        editorLines.forEach((line, idx) => {
            const lineEl = editorContainer.children[idx];
            if (lineEl) {
                const checkbox = lineEl.querySelector('.line-checkbox');
                if (checkbox && checkbox.checked) {
                    enabledLines.push(line);
                }
            }
        });
        
        // Render with Prime engine
        const text = enabledLines.join('\n');
        if (text.trim()) {
            console.log('üìù Compiling', enabledLines.length, 'enabled lines...');
            
            // Clear previous missing parts tracking
            MISSING_PARTS.clear();
            
            try {
                await loadManualText(text, {
                    filename: STATE.scenes[STATE.activeSceneIdx].name + '.mpd',
                    origin: 'Grace Editor'
                });
                
                // üíö GRACE: Scan editor lines to find which ones reference missing parts
                if (MISSING_PARTS.size > 0) {
                    console.log(`üíö Grace: Scanning ${editorLines.length} lines for missing part references...`);
                    
                    editorLines.forEach((line, idx) => {
                        const trimmed = line.trim();
                        // Check if this is a part line (Type 1)
                        if (trimmed.startsWith('1 ')) {
                            // Extract part name from end of line
                            const parts = trimmed.split(/\s+/);
                            const partRef = parts[parts.length - 1]; // Last token is the part file
                            const partName = partRef.split('/').pop(); // Get filename only
                            
                            // Check if this part is in our missing parts list
                            MISSING_PARTS.forEach((data, missingPart) => {
                                if (partName === missingPart || partRef.includes(missingPart)) {
                                    // This line references a missing part!
                                    if (!data.lineNumbers.includes(idx + 1)) {
                                        data.lineNumbers.push(idx + 1); // 1-indexed for display
                                    }
                                    console.warn(`üíö Grace: Line ${idx + 1} references missing part: ${missingPart}`);
                                }
                            });
                        }
                    });
                }
                
                // Show grace report after load
                setTimeout(() => showGraceReport(), 500);
                
                clearTimeout(compileTimeout); // Success!
                hideLoadingOverlay();
            } catch (err) {
                console.error('üíö Grace: Compile error caught', err);
                clearTimeout(compileTimeout);
                hideLoadingOverlay();
                document.getElementById('status-text').textContent = 'üíö Compile failed - check console';
            }
        } else {
            console.warn('‚ö†Ô∏è No enabled lines to compile');
            clearTimeout(compileTimeout);
            hideLoadingOverlay();
        }
    }

    async function init() {
        // Check if loading from Parts Browser
        const urlParams = new URLSearchParams(window.location.search);
        const loadFromBrowser = urlParams.get('loadFromBrowser');
        
        if (loadFromBrowser === 'true') {
            const savedScene = localStorage.getItem('grace-parts-browser-scene');
            if (savedScene) {
                console.log('üíö Loading scene from Parts Browser...');
                STATE.scenes.push(createScene('Parts Browser Scene'));
                STATE.scenes[0].lines = savedScene.split('\n');
                localStorage.removeItem('grace-parts-browser-scene'); // Clean up
            } else {
                STATE.scenes.push(createScene('Scene 1'));
            }
        } else {
            // Initialize first scene
            STATE.scenes.push(createScene('Scene 1'));
        }
        
        // Create Prime Engine
        STATE.viewer = BetaPrimeEngine.create({
            canvas: document.getElementById('viewer'),
            loaderPath: LIBRARY_BASE
        });
        
        attachViewerEvents();
        
        // CRITICAL: Wait for library to load completely before allowing any renders
        await loadLibraryCatalog();
        
        // Wait for viewer to be fully ready
        if (STATE.viewer && STATE.viewer.ready) {
            await STATE.viewer.ready;
        }
        
        setupUI();
        updateSceneSelector();
        
        // Load first scene into editor
        const firstScene = STATE.scenes[0];
        editorLines = [...firstScene.lines];
        renderEditor(editorLines);
        initializeGrids();
        renderSceneDots();
        
        // Log ready state
        graceSystemReady = true;
        console.log('üíö Grace Editor fully initialized!');
        console.log('  - Machine of Loving Grace: Active');
        console.log('  - Graceful Error Handling: Enabled');
        console.log('  - Prime Engine: Ready');
        console.log('  - Library Catalog:', Object.keys(STATE.libraryFileMap || {}).length, 'variants');
        console.log('  - Line Editor: Ready');
        console.log('  - Scene System: Ready');
        
        // üîç PROOF: Scene selector dropdown debugging
        const sceneSelector = document.getElementById('scene-selector');
        if (sceneSelector) {
            const optionCount = sceneSelector.options.length;
            console.log('üîç SCENE SELECTOR FOUND:', sceneSelector);
            console.log('üîç OPTIONS COUNT:', optionCount);
            console.log('üîç ALL OPTIONS:');
            for (let i = 0; i < sceneSelector.options.length; i++) {
                const opt = sceneSelector.options[i];
                console.log(`   ${i}: "${opt.text}" ‚Üí "${opt.value}"`);
            }
            console.log('üîç Selector visible?', sceneSelector.offsetParent !== null);
            console.log('üîç Selector style:', sceneSelector.style.cssText);
        } else {
            console.error('‚ùå SCENE SELECTOR NOT FOUND IN DOM!');
        }
        
        const statusText = document.getElementById('status-text');
        if (statusText) statusText.textContent = 'Ready';
        
        if (STATE.viewer && STATE.viewer.render) {
            STATE.viewer.render();
            console.log('[INIT] Initial render complete');
        }
        
        if (window.parent && window.parent !== window && STATE.viewer) {
            window.MomentoInterface = {
                get renderer() { return STATE.viewer.renderer; },
                get scene() { return STATE.viewer.scene; },
                get camera() { return STATE.viewer.camera; },
                renderCurrentView() {
                    if (STATE.viewer && STATE.viewer.renderer && STATE.viewer.scene && STATE.viewer.camera) {
                        STATE.viewer.renderer.render(STATE.viewer.scene, STATE.viewer.camera);
                    }
                }
            };
            window._captureData = {
                renderer: window.MomentoInterface.renderer,
                scene: window.MomentoInterface.scene,
                camera: window.MomentoInterface.camera
            };
            window.parent.postMessage({ type: 'GRACE_SCENE_READY' }, '*');
        }
        
        // Setup click-to-highlight (Bronze feature!)
        setupClickToHighlight();
        
        // If loaded from Parts Browser, auto-compile the scene
        if (loadFromBrowser === 'true' && editorLines.length > 5) {
            console.log('üíö Auto-compiling Parts Browser scene...');
            setTimeout(() => compile(), 500);
        }
    }
    
    function setupClickToHighlight() {
        // Temporarily disabled to focus on stud skeleton / inference work
        console.log('[CLICK] Click-to-highlight is disabled in Courage.');
        return;

        const viewerDiv = document.getElementById('viewer');
        const canvas = viewerDiv.querySelector('canvas');
        if (!canvas) {
            console.warn('[CLICK] Canvas not found yet, will retry');
            return;
        }
        console.log('[CLICK] Click-to-highlight setup complete');
        
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        canvas.addEventListener('click', (event) => {
            console.log('[CLICK] Canvas clicked!');
            
            // In BetaPrime, STATE.viewer *is* the engine object (scene/camera/renderer)
            if (!STATE.viewer || !STATE.viewer.scene || !STATE.viewer.camera) {
                console.warn('[CLICK] Viewer not ready');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            console.log('[CLICK] Mouse coords:', mouse.x.toFixed(2), mouse.y.toFixed(2));
            
            // Use the primary camera from the prime engine
            const camera = STATE.viewer.camera;
            if (!camera) {
                console.warn('[CLICK] No camera found');
                return;
            }
            
            raycaster.setFromCamera(mouse, camera);
            
            // Get all meshes from the model - try multiple paths (match GLB export behavior)
            const meshes = [];
            const modelRoot = (STATE.viewer.getModel && STATE.viewer.getModel()) ||
                             STATE.viewer.modelRoot ||
                             STATE.viewer.modelWrapper ||
                             (STATE.viewer.engine && (STATE.viewer.engine.modelWrapper || STATE.viewer.engine.model)) ||
                             STATE.viewer.scene;
            
            if (modelRoot) {
                modelRoot.traverse(obj => {
                    if (obj.isMesh) meshes.push(obj);
                });
            }
            
            console.log('[CLICK] Found', meshes.length, 'meshes to check');
            
            const intersects = raycaster.intersectObjects(meshes, false);
            console.log('[CLICK] Raycaster intersects:', intersects.length);
            
            if (intersects.length > 0) {
                const clickedObj = intersects[0].object;
                console.log('[CLICK] Hit object:', clickedObj.name || clickedObj.type, 'userData:', clickedObj.userData);
                
                // Find line number from userData
                let lineNum = clickedObj.userData?.lineNum;
                if (lineNum === undefined && clickedObj.parent) {
                    lineNum = clickedObj.parent.userData?.lineNum;
                    console.log('[CLICK] Checking parent, lineNum:', lineNum);
                }
                
                if (lineNum !== undefined) {
                    console.log('[CLICK] ‚úÖ Part clicked, line:', lineNum);
                    highlightMPDLine(lineNum);
                } else {
                    console.warn('[CLICK] ‚ùå No lineNum found in userData');
                }

                // Flash the clicked part, guarding against multi-materials
                const materials = Array.isArray(clickedObj.material)
                    ? clickedObj.material
                    : [clickedObj.material];
                const originalColors = [];

                materials.forEach((mat, idx) => {
                    if (!mat || !mat.color) return;
                    originalColors[idx] = mat.color.getHex();
                    mat.color.setHex(0xffff00); // Yellow flash
                });

                if (originalColors.length > 0) {
                    setTimeout(() => {
                        materials.forEach((mat, idx) => {
                            if (!mat || !mat.color) return;
                            if (originalColors[idx] !== undefined) {
                                mat.color.setHex(originalColors[idx]);
                            }
                        });
                    }, 300);
                }
            } else {
                console.log('[CLICK] No objects hit by raycast');
            }
        });
    }
    
    function annotateModelWithLineNumbers() {
        console.log('[ANNOTATE] Starting annotation...');
        console.log('[ANNOTATE] STATE.viewer:', !!STATE.viewer);
        console.log('[ANNOTATE] STATE.viewer.engine:', !!STATE.viewer?.engine);
        
        // Try multiple paths to find the model (match GLB export behavior)
        const modelRoot = (STATE.viewer?.getModel && STATE.viewer.getModel()) ||
                         STATE.viewer?.modelRoot ||
                         STATE.viewer?.modelWrapper ||
                         (STATE.viewer?.engine && (STATE.viewer.engine.modelWrapper || STATE.viewer.engine.model)) ||
                         STATE.viewer?.scene;
        
        if (!modelRoot) {
            console.warn('[ANNOTATE] ‚ùå No model found in viewer');
            console.log('[ANNOTATE] Viewer structure:', Object.keys(STATE.viewer || {}));
            console.log('[ANNOTATE] Engine structure:', Object.keys(STATE.viewer?.engine || {}));
            return;
        }
        
        if (!STATE.currentLineMap || STATE.currentLineMap.length === 0) {
            console.warn('[ANNOTATE] ‚ùå No line map available - compile first!');
            return;
        }
        
        // Get all meshes from the model
        const meshes = [];
        modelRoot.traverse(obj => {
            if (obj.isMesh) meshes.push(obj);
        });
        
        console.log('[ANNOTATE] Found', meshes.length, 'meshes,', STATE.currentLineMap.length, 'tracked lines');
        
        if (meshes.length === 0) {
            console.warn('[ANNOTATE] ‚ùå No meshes found in model!');
            return;
        }
        
        // Annotate meshes with line numbers (match by order)
        let annotated = 0;
        meshes.forEach((mesh, idx) => {
            if (idx < STATE.currentLineMap.length) {
                mesh.userData.lineNum = STATE.currentLineMap[idx].originalLineIdx;
                annotated++;
                if (idx < 5) { // Log first 5 for debugging
                    console.log('[ANNOTATE] Mesh', idx, '‚Üí Line', mesh.userData.lineNum);
                }
            }
        });
        
        console.log('[ANNOTATE] ‚úÖ Annotated', annotated, 'meshes with line numbers');
    }
    
    function computeStudSkeletonAndPlanes() {
        if (!STATE || !STATE.viewer || !window.THREE) {
            console.warn('[STUD] Viewer or THREE missing; cannot compute stud skeleton');
            return;
        }

        const modelRoot = (STATE.viewer?.getModel && STATE.viewer.getModel()) ||
                         STATE.viewer?.modelRoot ||
                         STATE.viewer?.modelWrapper ||
                         (STATE.viewer?.engine && (STATE.viewer.engine.modelWrapper || STATE.viewer.engine.model)) ||
                         STATE.viewer?.scene;

        if (!modelRoot) {
            console.warn('[STUD] No model found for stud skeleton');
            return;
        }

        try {
            const box = new THREE.Box3().setFromObject(modelRoot);
            const size = new THREE.Vector3();
            box.getSize(size);
            STATE.modelPlanes = {
                minY: box.min.y,
                maxY: box.max.y,
                bounds: {
                    min: box.min.clone(),
                    max: box.max.clone(),
                    size: size.clone()
                }
            };
            console.log('[STUD] Model Y range:', box.min.y, 'to', box.max.y);
        } catch (e) {
            console.warn('[STUD] Failed to compute model bounds:', e);
        }

        const gridMap = new Map();
        const layerTotals = new Map();
        const pos = new THREE.Vector3();
        const plateHeight = 8;
        modelRoot.traverse(obj => {
            if (!obj.isMesh || !obj.geometry || !obj.geometry.attributes || !obj.geometry.attributes.position) {
                return;
            }
            obj.updateWorldMatrix(true, false);
            const position = obj.geometry.attributes.position;
            const lineNum = obj.userData && typeof obj.userData.lineNum === 'number' ? obj.userData.lineNum : null;
            for (let i = 0; i < position.count; i++) {
                pos.fromBufferAttribute(position, i);
                pos.applyMatrix4(obj.matrixWorld);
                const gx = Math.round(pos.x / 20);
                const gz = Math.round(pos.z / 20);
                const gridKey = gx + ',' + gz;
                let col = gridMap.get(gridKey);
                if (!col) {
                    col = { gx, gz, layers: new Map() };
                    gridMap.set(gridKey, col);
                }
                const layerIndex = Math.round(pos.y / plateHeight);
                let layer = col.layers.get(layerIndex);
                if (!layer) {
                    layer = { sumX: 0, sumY: 0, sumZ: 0, count: 0, lineNums: new Set() };
                    col.layers.set(layerIndex, layer);
                }
                layer.sumX += pos.x;
                layer.sumY += pos.y;
                layer.sumZ += pos.z;
                layer.count++;
                if (lineNum !== null) {
                    layer.lineNums.add(lineNum);
                }

                const prevTotal = layerTotals.get(layerIndex) || 0;
                layerTotals.set(layerIndex, prevTotal + 1);
            }
        });

        let baseGridLayer = null;
        let baseGridLayerCount = 0;
        layerTotals.forEach((count, layerIndex) => {
            if (count > baseGridLayerCount) {
                baseGridLayerCount = count;
                baseGridLayer = layerIndex;
            }
        });
        STATE.baseGridLayer = baseGridLayer;
        if (baseGridLayer !== null) {
            console.log('[STUD] Base grid layer estimated as', baseGridLayer, 'with', baseGridLayerCount, 'samples');
        }

        const studs = [];
        const minVotes = 6;
        let baseGridYSum = 0;
        let baseGridYCount = 0;
        gridMap.forEach(col => {
            col.layers.forEach((layer, layerIndex) => {
                if (layer.count < minVotes) return;
                const cx = layer.sumX / layer.count;
                const cy = layer.sumY / layer.count;
                const cz = layer.sumZ / layer.count;
                let partLine = null;
                if (layer.lineNums && layer.lineNums.size > 0) {
                    layer.lineNums.forEach(v => {
                        if (partLine === null || v < partLine) partLine = v;
                    });
                }
                if (baseGridLayer !== null && layerIndex === baseGridLayer) {
                    baseGridYSum += cy;
                    baseGridYCount++;
                }
                studs.push({
                    kind: 'stud',
                    gridX: col.gx,
                    gridZ: col.gz,
                    layer: layerIndex,
                    worldPos: { x: cx, y: cy, z: cz },
                    lineNum: partLine
                });
            });
        });

        if (baseGridYCount > 0) {
            STATE.baseGridY = baseGridYSum / baseGridYCount;
            console.log('[STUD] Base grid Y estimated as', STATE.baseGridY);
        }

        STATE.studSkeleton = studs;
        console.log('[STUD] Computed stud skeleton nodes:', studs.length);

        const groundViolations = [];
        const baseLayer = typeof STATE.baseGridLayer === 'number' ? STATE.baseGridLayer : null;
        const baseY = typeof STATE.baseGridY === 'number' ? STATE.baseGridY : null;

        if (baseLayer !== null && baseY !== null) {
            studs.forEach(node => {
                if (!node || typeof node.layer !== 'number') return;
                if (node.layer >= baseLayer) return;
                if (!node.worldPos) return;
                const fromY = node.worldPos.y;
                const toY = baseY;
                const deltaY = toY - fromY;
                const violation = {
                    gridX: node.gridX,
                    gridZ: node.gridZ,
                    layer: node.layer,
                    baseGridLayer: baseLayer,
                    from: { x: node.worldPos.x, y: fromY, z: node.worldPos.z },
                    to: { x: node.worldPos.x, y: toY, z: node.worldPos.z },
                    deltaY,
                    meshLineNum: typeof node.lineNum === 'number' ? node.lineNum : null,
                    lineNum: null
                };
                groundViolations.push(violation);
            });

            if (typeof assignViolationOwnersFromMPD === 'function') {
                assignViolationOwnersFromMPD(groundViolations);
            }

            const summaryByLine = new Map();
            groundViolations.forEach(v => {
                if (!v || typeof v.lineNum !== 'number') return;
                const key = v.lineNum;
                const fromY = v.from && typeof v.from.y === 'number' ? v.from.y : null;
                const deltaY = typeof v.deltaY === 'number' ? v.deltaY : null;
                if (fromY === null || deltaY === null) return;
                let entry = summaryByLine.get(key);
                if (!entry) {
                    entry = {
                        lineNum: key,
                        count: 0,
                        minY: fromY,
                        maxY: fromY,
                        maxDeltaY: deltaY
                    };
                    summaryByLine.set(key, entry);
                }
                entry.count++;
                if (fromY < entry.minY) entry.minY = fromY;
                if (fromY > entry.maxY) entry.maxY = fromY;
                if (deltaY > entry.maxDeltaY) entry.maxDeltaY = deltaY;
            });

            STATE.groundViolations = groundViolations;
            const summaryArray = Array.from(summaryByLine.values()).sort((a, b) => b.maxDeltaY - a.maxDeltaY);
            STATE.groundViolationSummary = summaryArray;

            if (groundViolations.length > 0) {
                console.log('[STUD] Ground violations:', groundViolations.length);
                if (typeof printGroundViolationTable === 'function') {
                    printGroundViolationTable(32);
                }
            } else {
                console.log('[STUD] No ground violations detected');
            }
        } else {
            STATE.groundViolations = [];
            STATE.groundViolationSummary = [];
            console.log('[STUD] Ground violation analysis skipped: base grid not available');
        }

        drawStudSkeletonOverlay();
        if (typeof buildPartControlSkeleton === 'function' && typeof drawPartControlOverlay === 'function') {
            buildPartControlSkeleton();
            drawPartControlOverlay();
        }
    }
    
    async function debugExtractPartSkeleton(partId) {
        if (!STATE || !STATE.viewer || !window.THREE) {
            console.warn('[STUD-DEBUG] Viewer or THREE missing; cannot extract part skeleton');
            return null;
        }
        const id = (partId || '').trim();
        if (!id) {
            console.warn('[STUD-DEBUG] Provide a partId like "3001.dat"');
            return null;
        }

        const header = [
            '0 FILE debug_' + id,
            '0 Name: Debug single-part skeleton',
            '0 !LDRAW_ORG Model',
            '0 BFC CERTIFY CCW'
        ].join('\n');
        const body = '1 1 0 0 0  1 0 0  0 1 0  0 0 1  ' + id;
        const text = header + '\n' + body + '\n';

        const prevFilter = STATE.partControlFilterPartId;
        STATE.partControlFilterPartId = id;

        let targetPath = null;
        try {
            let loaded = false;

            if (STATE.libraryFileMap && Object.keys(STATE.libraryFileMap).length) {
                const mapped = lookupLibraryPath(id, id);
                if (mapped) {
                    let rel = normalizeRelativePath(mapped);
                    const lowerRel = rel.toLowerCase();
                    if (lowerRel.startsWith('ldraw/')) {
                        rel = rel.substring('ldraw/'.length);
                    }
                    targetPath = rel;
                }
            }

            if (targetPath && typeof STATE.viewer.loadPath === 'function') {
                console.log('[STUD-DEBUG] Loading part for skeleton via path', id, '‚Üí', targetPath);
                await STATE.viewer.loadPath(targetPath, {
                    filename: id,
                    name: 'debug-part-' + id,
                    origin: 'DebugSkeleton(part)'
                });
                loaded = true;
            } else if (STATE.viewer && typeof STATE.viewer.loadText === 'function') {
                console.log('[STUD-DEBUG] Loading part for skeleton via tiny MPD text', id);
                await STATE.viewer.loadText(text, {
                    filename: id,
                    name: 'debug-' + id,
                    origin: 'DebugSkeleton(text)'
                });
                loaded = true;
            }

            if (!loaded) {
                console.warn('[STUD-DEBUG] Could not load part for skeleton extraction:', id);
                return null;
            }

            computeStudSkeletonAndPlanes();
            const studs = Array.isArray(STATE.studSkeleton) ? STATE.studSkeleton : [];
            const payload = {
                partId: id,
                studs: studs.filter(node => node && node.worldPos).map(node => ({
                    x: node.worldPos.x,
                    y: node.worldPos.y,
                    z: node.worldPos.z,
                    role: node.kind || 'stud'
                }))
            };

            console.log('[STUD-DEBUG] Part skeleton', payload);

            if (typeof window !== 'undefined') {
                if (!window.partSkeletonDebug || typeof window.partSkeletonDebug !== 'object') {
                    window.partSkeletonDebug = {};
                }
                window.partSkeletonDebug[id.toLowerCase()] = payload;
            }

            if (!STATE.partSkeletonLibrary || typeof STATE.partSkeletonLibrary !== 'object') {
                STATE.partSkeletonLibrary = {};
            }
            STATE.partSkeletonLibrary[id.toLowerCase()] = {
                partId: id,
                studs: payload.studs.map(s => ({
                    x: s.x,
                    y: s.y,
                    z: s.z,
                    role: s.role || 'stud'
                }))
            };

            return payload;
        } catch (err) {
            console.error('[STUD-DEBUG] Failed to extract skeleton for', id, 'targetPath:', targetPath || '(text)', err);
            return null;
        } finally {
            STATE.partControlFilterPartId = prevFilter;
        }
    }
    
    function debugDrawSceneFromPartSkeletons() {
        if (!STATE || !STATE.viewer || !STATE.viewer.scene || !window.THREE) {
            console.warn('[STUD-DEBUG] Viewer/scene missing; cannot draw scene from part skeletons');
            return;
        }
        if (!Array.isArray(editorLines) || !editorLines.length) {
            console.warn('[STUD-DEBUG] No editor lines available for scene reconstruction');
            return;
        }
        const lib = STATE.partSkeletonLibrary || {};
        const scene = STATE.viewer.scene;
        if (STATE.templateStudGroup && STATE.templateStudGroup.parent) {
            STATE.templateStudGroup.parent.remove(STATE.templateStudGroup);
        }
        const group = new THREE.Group();
        group.name = 'TemplateStudOverlay';
        const radius = 3;
        const segments = 8;
        const geometry = new THREE.SphereGeometry(radius, segments, segments);
        const material = new THREE.MeshBasicMaterial({
            color: 0xff00ff,
            transparent: true,
            opacity: 0.8,
            depthTest: true,
            depthWrite: false
        });
        const plateHeight = 8;
        let count = 0;
        for (let idx = 0; idx < editorLines.length; idx++) {
            const line = editorLines[idx];
            const trimmed = line && line.trim();
            if (!trimmed || !trimmed.startsWith('1 ')) continue;
            const parsed = parseType1Line(line);
            if (!parsed || !parsed.partId) continue;
            const key = parsed.partId.toLowerCase();
            const entry = lib[key];
            if (!entry || !Array.isArray(entry.studs) || !entry.studs.length) continue;
            const a = parsed.a, b = parsed.b, c = parsed.c;
            const d = parsed.d, e = parsed.e, f = parsed.f;
            const g = parsed.g, h = parsed.h, i = parsed.i;
            const tx = parsed.x, ty = parsed.y, tz = parsed.z;
            entry.studs.forEach(s => {
                const lx = s.x || 0;
                const ly = s.y || 0;
                const lz = s.z || 0;
                const wx = a * lx + b * ly + c * lz + tx;
                const wy = d * lx + e * ly + f * lz + ty;
                const wz = g * lx + h * ly + i * lz + tz;
                const marker = new THREE.Mesh(geometry, material);
                marker.position.set(wx, wy, wz);
                marker.userData = marker.userData || {};
                marker.userData.lineNum = idx;
                marker.userData.partId = parsed.partId;
                group.add(marker);
                count++;
            });
        }
        scene.add(group);
        STATE.templateStudGroup = group;
        console.log('[STUD-DEBUG] Template-based scene studs drawn:', count);
    }
    
    function drawStudSkeletonOverlay() {
        if (!STATE || !STATE.viewer || !STATE.viewer.scene || !window.THREE) {
            console.warn('[STUD] Viewer/scene missing; cannot draw stud skeleton overlay');
            return;
        }

        const scene = STATE.viewer.scene;
        if (STATE.studSkeletonGroup && STATE.studSkeletonGroup.parent) {
            STATE.studSkeletonGroup.parent.remove(STATE.studSkeletonGroup);
        }

        const studs = STATE.studSkeleton || [];
        if (!studs.length) {
            console.log('[STUD] No stud skeleton nodes to draw');
            STATE.studSkeletonGroup = null;
            return;
        }

        const group = new THREE.Group();
        group.name = 'StudSkeletonOverlay';

        const radius = 4;
        const segments = 8;
        const geometry = new THREE.SphereGeometry(radius, segments, segments);
        const normalMaterial = new THREE.MeshBasicMaterial({
            color: 0x00ffff,
            transparent: true,
            opacity: 0.7,
            depthTest: true,
            depthWrite: false
        });
        const problemMaterial = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.85,
            depthTest: true,
            depthWrite: false
        });

        const ghostMaterial = new THREE.MeshBasicMaterial({
            color: 0x00ff00,
            wireframe: true,
            transparent: true,
            opacity: 0.9,
            depthTest: true,
            depthWrite: false
        });

        const baseGridLayer = typeof STATE.baseGridLayer === 'number' ? STATE.baseGridLayer : null;
        const baseGridY = typeof STATE.baseGridY === 'number' ? STATE.baseGridY : null;
        const diag = STATE.diagnostics || {};
        const showNormal = diag.studNormal !== false;
        const showProblem = diag.studProblem !== false;
        const showGhost = diag.studGhost !== false;
        let belowCount = 0;
        let normalCount = 0;
        let ghostCount = 0;

        studs.forEach(node => {
            if (!node || !node.worldPos) return;
            const isBelow = baseGridLayer !== null && typeof node.layer === 'number' && node.layer < baseGridLayer;
            if (isBelow) {
                if (showProblem) {
                    const marker = new THREE.Mesh(geometry, problemMaterial);
                    marker.position.set(node.worldPos.x, node.worldPos.y, node.worldPos.z);
                    group.add(marker);
                    belowCount++;
                }
                if (baseGridY !== null && showGhost) {
                    const ghostMarker = new THREE.Mesh(geometry, ghostMaterial);
                    ghostMarker.position.set(node.worldPos.x, baseGridY, node.worldPos.z);
                    group.add(ghostMarker);
                    ghostCount++;
                }
            } else if (showNormal) {
                const marker = new THREE.Mesh(geometry, normalMaterial);
                marker.position.set(node.worldPos.x, node.worldPos.y, node.worldPos.z);
                group.add(marker);
                normalCount++;
            }
        });

        scene.add(group);
        STATE.studSkeletonGroup = group;
        console.log('[STUD] Stud skeleton overlay drawn:', studs.length, '(normal:', normalCount + ',', 'below base grid:', belowCount + ',', 'ghost targets:', ghostCount + ')');
    }

    function buildPartControlSkeleton() {
        if (!Array.isArray(editorLines) || !editorLines.length) {
            STATE.partControlSkeleton = [];
            return;
        }
        const filterId = (STATE && STATE.partControlFilterPartId)
            ? String(STATE.partControlFilterPartId).trim().toLowerCase()
            : '';
        const nodes = [];
        for (let idx = 0; idx < editorLines.length; idx++) {
            const line = editorLines[idx];
            const trimmed = line && line.trim();
            if (!trimmed || !trimmed.startsWith('1 ')) continue;
            const parsed = parseType1Line(line);
            if (!parsed) continue;
            if (filterId && parsed.partId && parsed.partId.toLowerCase() !== filterId) continue;
            nodes.push({
                kind: 'part',
                lineNum: idx,
                partId: parsed.partId,
                color: parsed.color,
                worldPos: { x: parsed.x, y: parsed.y, z: parsed.z }
            });
        }
        STATE.partControlSkeleton = nodes;
        console.log('[PART] Built part control skeleton nodes:', nodes.length, filterId ? `(filtered by ${filterId})` : '');
    }

    function drawPartControlOverlay() {
        if (!STATE || !STATE.viewer || !STATE.viewer.scene || !window.THREE) {
            console.warn('[PART] Viewer/scene missing; cannot draw part control overlay');
            return;
        }
        const scene = STATE.viewer.scene;
        if (STATE.partControlGroup && STATE.partControlGroup.parent) {
            STATE.partControlGroup.parent.remove(STATE.partControlGroup);
        }
        const nodes = STATE.partControlSkeleton || [];
        if (!nodes.length) {
            console.log('[PART] No part control nodes to draw');
            STATE.partControlGroup = null;
            return;
        }
        const group = new THREE.Group();
        group.name = 'PartControlOverlay';
        const radius = 5;
        const segments = 8;
        const geometry = new THREE.SphereGeometry(radius, segments, segments);
        const material = new THREE.MeshBasicMaterial({
            color: 0xffff00,
            transparent: true,
            opacity: 0.9,
            depthTest: true,
            depthWrite: false
        });
        nodes.forEach(node => {
            if (!node.worldPos) return;
            const marker = new THREE.Mesh(geometry, material);
            marker.position.set(node.worldPos.x, node.worldPos.y, node.worldPos.z);
            marker.userData = marker.userData || {};
            marker.userData.lineNum = node.lineNum;
            marker.userData.partId = node.partId;
            group.add(marker);
        });
        scene.add(group);
        STATE.partControlGroup = group;
        console.log('[PART] Part control overlay drawn:', nodes.length);
    }

    function highlightMPDLine(lineIdx) {
        // Clear previous highlights
        document.querySelectorAll('.line-wrapper').forEach(el => {
            el.style.background = '';
            el.style.borderLeft = '';
        });
        
        // Highlight the clicked line
        const lineDiv = document.querySelector(`[data-line-idx="${lineIdx}"]`);
        if (lineDiv) {
            lineDiv.style.background = 'rgba(255, 215, 0, 0.3)'; // Gold highlight
            lineDiv.style.borderLeft = '3px solid var(--accent)';
            lineDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = `‚ú® Line ${lineIdx + 1} selected`;
                setTimeout(() => statusText.textContent = 'Ready', 2000);
            }
            
            console.log('[HIGHLIGHT] MPD line', lineIdx, 'highlighted');
        } else {
            console.warn('[HIGHLIGHT] Could not find line element for index', lineIdx);
        }
    }

    async function loadManifest() {
        try {
            const response = await fetch('./root-models-manifest.json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const manifest = await response.json();
            WAG.manifest = manifest;
            const files = manifest.files || [];
            const included = [];
            const quarantined = [];
            files.forEach(file => {
                if (!shouldIncludeModel(file)) return;
                if (isQuarantined(file)) {
                    quarantined.push(file);
                } else {
                    included.push(file);
                }
            });
            WAG.models = included.sort((a, b) => (a.filename || '').localeCompare(b.filename || '', undefined, { sensitivity: 'base' }));
            WAG.quarantinedFiles = quarantined;
            WAG.filtered = [...WAG.models];
            updateStats();
            if (!WAG.models.length) {
                document.getElementById('model-list').innerHTML = '<div class="empty-state">No models found. Run <code>node generate-root-models-manifest.js</code>.</div>';
            }
        } catch (err) {
            console.error('Failed to load manifest', err);
            document.getElementById('stats').textContent = 'Manifest missing - run generator script';
            document.getElementById('model-list').innerHTML = '<div class="empty-state">Cannot fetch root-models-manifest.json</div>';
        }
    }

    async function loadLibraryCatalog() {
        const libStatus = document.getElementById('lib-status');
        const loadingEl = document.getElementById('loading');
        const loadingText = loadingEl?.querySelector('.loading-text');
        const loadingSubtext = loadingEl?.querySelector('.loading-subtext');
        
        try {
            libStatus.textContent = 'Library: Loading...';
            
            if (loadingEl) {
                loadingEl.classList.add('active');
                if (loadingText) loadingText.textContent = 'Loading LDraw Library...';
                if (loadingSubtext) loadingSubtext.textContent = 'Fetching part catalog...';
            }
            
            const response = await fetch('./ldraw-parts-manifest.json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const manifest = await response.json();
            
            if (loadingSubtext) loadingSubtext.textContent = 'Building library index...';
            
            // Process manifest (buildLibraryFileMap is already fast)
            STATE.libraryFileMap = buildLibraryFileMap(manifest);
            
            if (STATE.viewer && STATE.libraryFileMap) {
                STATE.viewer.setFileMap(STATE.libraryFileMap);
            }
            
            const variantCount = Object.keys(STATE.libraryFileMap || {}).length;
            libStatus.textContent = `Library: ${variantCount.toLocaleString()} variants`;
            console.log('‚úì Library catalog loaded:', variantCount, 'path variants');
            
            if (loadingEl) loadingEl.classList.remove('active');
        } catch (err) {
            console.warn('Unable to preload library manifest', err);
            libStatus.textContent = 'Library: Failed';
            if (loadingEl) loadingEl.classList.remove('active');
        }
    }

    async function loadQuarantineList() {
        try {
            const response = await fetch('./quarantine-section.json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const set = new Set();
            (data.files || []).forEach(entry => {
                if (!entry || !entry.filename) return;
                set.add(entry.filename.trim().toLowerCase());
            });
            WAG.quarantineSet = set;
        } catch (err) {
            console.warn('[WAG] Quarantine list missing or invalid; proceeding without exclusions.', err);
            WAG.quarantineSet = new Set();
        }
    }

    function buildLibraryFileMap(manifest) {
        const map = {};
        if (!manifest || !manifest.categories) return map;
        manifest.categories.forEach(category => {
            const basePath = category.path || '';
            (category.files || []).forEach(file => {
                const filename = file.filename || '';
                if (!filename) return;
                const relPathRaw = file.relativePath || file.path || `${basePath}/${filename}`;
                const relPath = normalizeRelativePath(relPathRaw);
                const normalized = normalizeLibraryTarget(relPath);
                registerPathVariants(map, relPath, normalized);
            });
        });
        return map;
    }

    function normalizeRelativePath(path) {
        if (!path) return '';
        return path.replace(/\\/g, '/').replace(/^(\.\/|\.\\)/, '').replace(/^\/+/, '');
    }

    function normalizeLibraryTarget(path) {
        if (!path) return '';
        return path
            .replace(/\\/g, '/')
            .replace(/^(\.\/)+/, '')
            .replace(/^ldraw\//, '')
            .replace(/\/{2,}/g, '/');
    }

    function registerPathVariants(map, relPath, normalizedPath) {
        if (!normalizedPath) return;
        const keys = new Set();
        const clean = relPath;
        const lower = clean.toLowerCase();
        const normalizedLower = normalizedPath.toLowerCase();
        keys.add(clean);
        keys.add(lower);
        keys.add(normalizedPath);
        keys.add(normalizedLower);
        if (clean.startsWith('ldraw/')) {
            const withoutPrefix = clean.replace(/^ldraw\//, '');
            keys.add(withoutPrefix);
            keys.add(withoutPrefix.toLowerCase());
        } else {
            keys.add(`ldraw/${clean}`);
            keys.add(`ldraw/${clean}`.toLowerCase());
        }
        keys.add(`./${clean}`);
        keys.add(`./${clean}`.toLowerCase());
        keys.add(`../${clean}`);
        keys.add(`../${clean}`.toLowerCase());
        if (clean.startsWith('parts/')) {
            const withoutParts = clean.substring(6);
            keys.add(withoutParts);
            keys.add(withoutParts.toLowerCase());
            keys.add(`./${withoutParts}`);
            keys.add(`./${withoutParts}`.toLowerCase());
            keys.add(`../${withoutParts}`);
            keys.add(`../${withoutParts}`.toLowerCase());
            keys.add(`ldraw/${withoutParts}`);
            keys.add(`ldraw/${withoutParts}`.toLowerCase());
        }
        if (clean.startsWith('p/')) {
            const withoutPrimitive = clean.substring(2);
            keys.add(withoutPrimitive);
            keys.add(withoutPrimitive.toLowerCase());
            keys.add(`./${withoutPrimitive}`);
            keys.add(`./${withoutPrimitive}`.toLowerCase());
            keys.add(`../${withoutPrimitive}`);
            keys.add(`../${withoutPrimitive}`.toLowerCase());
            keys.add(`ldraw/${withoutPrimitive}`);
            keys.add(`ldraw/${withoutPrimitive}`.toLowerCase());
        }
        const basename = clean.substring(clean.lastIndexOf('/') + 1);
        keys.add(basename);
        keys.add(basename.toLowerCase());
        keys.forEach(key => {
            if (!key) return;
            const normalizedKey = key.replace(/\\/g, '/').replace(/\/{2,}/g, '/');
            if (normalizedKey && !map[normalizedKey]) {
                map[normalizedKey] = normalizedPath;
            }
        });
    }

    function lookupLibraryPath(rawPath, filename) {
        if (!STATE.libraryFileMap) return null;
        const attempts = [rawPath, rawPath?.toLowerCase(), filename, filename?.toLowerCase()];
        for (const key of attempts) {
            if (key && STATE.libraryFileMap[key]) {
                return STATE.libraryFileMap[key];
            }
        }
        return null;
    }

    function buildCandidatePaths(model) {
        const set = new Set();
        const raw = normalizeRelativePath(model.path || model.filename || '');
        const libraryMatch = lookupLibraryPath(raw, model.filename);
        const add = path => {
            if (!path) return;
            const normalized = normalizeRelativePath(path);
            if (normalized) set.add(normalized);
        };
        const addRoot = path => {
            if (!path) return;
            add(`${ROOT_PREFIX_FROM_LIBRARY}${normalizeRelativePath(path)}`);
        };
        if (libraryMatch) add(libraryMatch);
        add(model.path);
        add(raw);
        if (model.filename) add(model.filename);
        addRoot(model.path);
        addRoot(raw);
        if (model.filename) addRoot(model.filename);
        return Array.from(set).filter(Boolean);
    }

    function shouldIncludeModel(file) {
        const filename = (file.filename || '').trim().toLowerCase();
        const extension = filename.includes('.') ? filename.substring(filename.lastIndexOf('.')) : '';
        if (AI_FILE_PATTERN.test(filename)) return true;
        if (extension === '.mpd') return true;
        const name = (file.name || '').toLowerCase();
        if (name.startsWith('ai ') || name.includes('generated')) return true;
        const description = (file.description || '').toLowerCase();
        return description.includes('ai ') || description.includes('generated');
    }

    function isQuarantined(file) {
        if (!file || !file.filename || !WAG.quarantineSet) return false;
        return WAG.quarantineSet.has(file.filename.trim().toLowerCase());
    }

    function setupUI() {
        window.addEventListener('resize', () => {
            if (STATE.viewer) STATE.viewer.updateRendererSize();
        });
        
        // No redundant controls - WAGY bar handles everything
        
        // New Scene button (footer corner +)
        document.getElementById('new-scene-btn').addEventListener('click', () => {
            const newScene = createScene(`Scene ${STATE.scenes.length + 1}`);
            STATE.scenes.push(newScene);
            switchScene(STATE.scenes.length - 1);
        });
        
        // üíö SCENE SELECTOR - Load MPD files from dropdown
        document.getElementById('scene-selector').addEventListener('change', async (e) => {
            const mpdPath = e.target.value;
            if (!mpdPath) return; // Empty = current scene
            
            console.log(`üíö Grace: Loading MPD from selector: ${mpdPath}`);
            document.getElementById('status-text').textContent = `Loading ${mpdPath.split('/').pop()}...`;
            
            try {
                // Fetch the MPD file
                const response = await fetch(mpdPath);
                if (!response.ok) {
                    throw new Error(`Failed to load ${mpdPath}: ${response.statusText}`);
                }
                
                const mpdContent = await response.text();
                console.log(`üíö Grace: Fetched ${mpdContent.split('\n').length} lines`);
                
                // Replace editor content with loaded MPD
                editorLines.length = 0;
                editorLines.push(...mpdContent.split('\n'));
                
                // Update current scene
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                STATE.scenes[STATE.activeSceneIdx].name = mpdPath.split('/').pop().replace(/\.(mpd|ldr)$/, '');
                
                // Render editor and compile
                renderEditor(editorLines);
                document.getElementById('file-name').textContent = STATE.scenes[STATE.activeSceneIdx].name;
                
                // Auto-compile
                setTimeout(() => compile(), 300);
                
                console.log(`üíö Grace: Loaded ${mpdPath.split('/').pop()} successfully!`);
                document.getElementById('status-text').textContent = `üíö Loaded ${mpdPath.split('/').pop()}`;
                
                // Reset selector to "Current Scene"
                setTimeout(() => e.target.value = '', 500);
                
            } catch (err) {
                console.error(`üíö Grace: Failed to load MPD:`, err);
                document.getElementById('status-text').textContent = `‚ùå Failed to load: ${err.message}`;
                alert(`Failed to load ${mpdPath.split('/').pop()}:\n${err.message}`);
                e.target.value = ''; // Reset selector
            }
        });
        
        // Help button with fullscreen mode
        document.getElementById('help-btn').addEventListener('click', () => {
            const helpMenu = document.createElement('div');
            helpMenu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-secondary);
                border: 2px solid var(--accent);
                border-radius: 8px;
                padding: 20px;
                max-width: 400px;
                z-index: 10000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.8);
                color: var(--text-primary);
            `;
            
            helpMenu.innerHTML = `
                <h3 style="color: var(--accent); margin: 0 0 12px 0;">üíö GRACE EDITOR</h3>
                <div style="font-size: 12px; line-height: 1.6; margin-bottom: 16px; max-height: 60vh; overflow-y: auto;">
                    <strong style="color: var(--accent);">SELECTION:</strong><br>
                    Cmd+Click - Multi-select lines<br>
                    Cmd+A - Select all lines<br>
                    Esc - Deselect all<br>
                    Cmd+I - Invert selection<br>
                    Click selected (when many) ‚Üí Deselect all<br>
                    <br>
                    <strong style="color: var(--accent);">PASTE & EDIT:</strong><br>
                    üìã COPY ALL - Copy entire MPD to clipboard<br>
                    Ctrl+V - Paste anywhere (10+ lines = new file)<br>
                    Delete/Backspace - Delete selected lines<br>
                    <br>
                    <strong style="color: var(--accent);">BATCH EDIT:</strong><br>
                    Cmd+E - Replace numbers in selection<br>
                    Cmd+/ - Toggle sections ON/OFF (comment)<br>
                    Great for coordinates, colors, sizes<br>
                    Example: Change all "120" to "240"<br>
                    <br>
                    <strong style="color: var(--accent);">SHORTCUTS:</strong><br>
                    Cmd+S - Compile/Render scene<br>
                    Cmd+C - Copy selected lines<br>
                    Cmd+Z - Undo | Cmd+Shift+Z - Redo<br>
                    ‚Ü∂ ‚Ü∑ buttons also work<br>
                    Right-click line - Actions menu<br>
                    <br>
                    <strong style="color: var(--accent);">GRACEFUL ERRORS:</strong><br>
                    üíî Pink lines = Missing parts<br>
                    Click error panel to jump to line<br>
                    Scene renders with pink placeholders<br>
                    Copy error report to fix issues<br>
                    <br>
                    <strong style="color: var(--accent);">VIEWER:</strong><br>
                    W - Wireframe | A - Axes | G - Grid<br>
                    S - Spin | Y - Flip Y<br>
                    IMG - Screenshot (4:3 + JSON)<br>
                </div>
                <button id="fullscreen-btn" style="
                    background: var(--accent);
                    color: var(--bg-main);
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: 700;
                    margin-right: 8px;
                ">FULLSCREEN</button>
                <button id="close-help-btn" style="
                    background: var(--bg-main);
                    color: var(--text-primary);
                    border: 1px solid var(--border-primary);
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                ">CLOSE</button>
            `;
            
            document.body.appendChild(helpMenu);
            
            // Fullscreen button
            helpMenu.querySelector('#fullscreen-btn').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        alert('Fullscreen not available: ' + err.message);
                    });
                } else {
                    document.exitFullscreen();
                }
                document.body.removeChild(helpMenu);
            });
            
            // Close button
            helpMenu.querySelector('#close-help-btn').addEventListener('click', () => {
                document.body.removeChild(helpMenu);
            });
            
            // Click outside to close
            setTimeout(() => {
                const closeOnOutside = (e) => {
                    if (!helpMenu.contains(e.target)) {
                        document.body.removeChild(helpMenu);
                        document.removeEventListener('click', closeOnOutside);
                    }
                };
                document.addEventListener('click', closeOnOutside);
            }, 100);
        });
        
        // Theme toggle button
        document.getElementById('theme-btn').addEventListener('click', () => {
            const root = document.documentElement;
            const btn = document.getElementById('theme-btn');
            const currentTheme = root.getAttribute('data-theme') || 'dark';
            
            const themes = ['dark', 'light', 'green'];
            const icons = { dark: 'üåô', light: '‚òÄÔ∏è', green: 'üåø' };
            const labels = { dark: 'Dark', light: 'Light', green: 'Green' };
            
            const currentIdx = themes.indexOf(currentTheme);
            const nextIdx = (currentIdx + 1) % themes.length;
            const nextTheme = themes[nextIdx];
            
            root.setAttribute('data-theme', nextTheme);
            btn.textContent = icons[nextTheme];
            btn.title = `Theme: ${labels[nextTheme]}`;
            
            const statusText = document.getElementById('status-text');
            if (statusText) statusText.textContent = `Theme: ${labels[nextTheme]}`;
        });
        
        // (Color picker removed - was a zombie button with no control authority)
        
        // WAGY bar - complete control center
        const wagyMap = {
            'wire-quick': 'wireframe',
            'axes-quick': 'axes',
            'grid-quick': 'grid',
            'flipy-quick': 'flipY',
            'skeleton-quick': 'skeletonOnly',
            'stud-normal-quick': 'studNormal',
            'stud-problem-quick': 'studProblem',
            'stud-ghost-quick': 'studGhost'
        };
        Object.entries(wagyMap).forEach(([btnId, diagKey]) => {
            const btn = document.getElementById(btnId);
            if (btn) {
                setToggleButtonState(btn, !!STATE.diagnostics[diagKey]);
                btn.addEventListener('click', () => {
                    STATE.diagnostics[diagKey] = !STATE.diagnostics[diagKey];
                    setToggleButtonState(btn, STATE.diagnostics[diagKey]);
                    if (STATE.viewer) STATE.viewer.setDiagnostics(STATE.diagnostics);
                    if (diagKey === 'studNormal' || diagKey === 'studProblem' || diagKey === 'studGhost') {
                        drawStudSkeletonOverlay();
                    }
                });
            }
        });

        const groundBtn = document.getElementById('ground-toggle-btn');
        if (groundBtn) {
            setToggleButtonState(groundBtn, !!STATE.groundActive);
            groundBtn.addEventListener('click', () => {
                const active = toggleGroundCorrections();
                setToggleButtonState(groundBtn, active);
            });
        }
        
        // Spin button
        const spinBtn = document.getElementById('spin-quick');
        if (spinBtn) {
            setToggleButtonState(spinBtn, STATE.autoSpin);
            spinBtn.addEventListener('click', () => {
                STATE.autoSpin = !STATE.autoSpin;
                setToggleButtonState(spinBtn, STATE.autoSpin);
                if (STATE.viewer) STATE.viewer.setAutoSpin(STATE.autoSpin);
            });
        }
        
        // Reset view button
        const resetBtn = document.getElementById('reset-quick');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                if (STATE.viewer) {
                    if (STATE.viewer.snapFrankTopView) {
                        STATE.viewer.snapFrankTopView();
                    } else {
                        STATE.viewer.fitToCurrent();
                    }
                }
            });
        }
        
        // Import/Export button (footer corner)
        document.getElementById('import-export-btn').addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.mpd,.ldr,.dat';
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const text = await file.text();
                    editorLines = text.split('\n');
                    STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                    STATE.scenes[STATE.activeSceneIdx].name = file.name.replace(/\.(mpd|ldr|dat)$/, '');
                    renderEditor(editorLines);
                    updateSceneSelector();
                    renderSceneDots();
                    document.getElementById('status-text').textContent = `Imported ${file.name}`;
                }
            });
            fileInput.click();
        });
        
        // Catalog Browser button (‚≠ê)
        document.getElementById('catalog-browser-btn').addEventListener('click', openCatalogBrowser);

        const TAXO_PRIMITIVE_THRESHOLD = 30;

        const forEachTaxonomyPart = (node, cb) => {
            if (!node) return;
            if (Array.isArray(node)) {
                for (let i = 0; i < node.length; i++) {
                    const item = node[i];
                    if (item && typeof item === 'object') {
                        if (item.filename && item.description) cb(item);
                        forEachTaxonomyPart(item, cb);
                    }
                }
            } else if (typeof node === 'object') {
                const values = Object.values(node);
                for (let i = 0; i < values.length; i++) {
                    forEachTaxonomyPart(values[i], cb);
                }
            }
        };

        const extractTaxonomyHeadPhrase = (description) => {
            if (!description) return null;
            let desc = description.trim();
            if (!desc) return null;
            const firstChar = desc.charAt(0);
            if (firstChar === '~' || firstChar === '=') return null;
            desc = desc.toLowerCase();
            const m = desc.match(/^[^0-9,.;()]+/);
            if (!m) return null;
            let head = m[0].trim().replace(/\s+/g, ' ');
            if (!head) return null;
            return head;
        };

        const tagTaxonomyPrimitiveDomain = (head) => {
            if (!head) return 'misc';
            if (/wheel|tyre/.test(head)) return 'vehicle';
            if (/windscreen|windshield/.test(head)) return 'vehicle';
            if (/boat hull/.test(head)) return 'vehicle-ship';
            if (/train base|train /.test(head)) return 'vehicle-train';
            if (/fuselage|wing |propeller|jet engine|cockpit/.test(head)) return 'vehicle-air';
            if (/door |window |panel |wall |roof|arch /.test(head)) return 'architecture';
            if (/tree |plant |leaf |bush|palm /.test(head)) return 'environment';
            if (/technic|gear |axle |beam |liftarm|engine /.test(head)) return 'technic';
            return 'misc';
        };

        const analyzeTaxonomyPrimitives = (taxonomy) => {
            if (!taxonomy || !taxonomy.kingdoms) return;
            const freq = {};
            let total = 0;

            forEachTaxonomyPart(taxonomy.kingdoms, (part) => {
                const head = extractTaxonomyHeadPhrase(part.description);
                if (!head) return;
                freq[head] = (freq[head] || 0) + 1;
                total++;
            });

            const entries = Object.entries(freq)
                .map(([head, count]) => ({ head, count, domain: tagTaxonomyPrimitiveDomain(head) }))
                .sort((a, b) => b.count - a.count);

            const primitives = entries.filter(e => e.count >= TAXO_PRIMITIVE_THRESHOLD);

            const bucketSuggestions = primitives.reduce((acc, p) => {
                if (!acc[p.domain]) acc[p.domain] = [];
                acc[p.domain].push(p);
                return acc;
            }, {});

            Object.keys(bucketSuggestions).forEach(domain => {
                bucketSuggestions[domain] = bucketSuggestions[domain].slice(0, 12);
            });

            console.log('Grace taxonomy primitive analysis:', {
                totalPartsVisited: total,
                primitiveThreshold: TAXO_PRIMITIVE_THRESHOLD,
                topPrimitives: primitives.slice(0, 50)
            });
            console.log('Grace taxonomy suggested primitive buckets:', bucketSuggestions);
        };

        async function openCatalogBrowser() {
            // Load taxonomy, minifig library, and location library
            let taxonomy;
            let minifigLibrary = null;
            let locationLibrary = null;
            try {
                const [taxonomyResponse, minifigResponse, locationResponse] = await Promise.all([
                    fetch('parts-taxonomy.json'),
                    fetch('minifig-library.json').catch(() => null),
                    fetch('location-library.json').catch(() => null)
                ]);
                taxonomy = await taxonomyResponse.json();
                try {
                    analyzeTaxonomyPrimitives(taxonomy);
                } catch (analysisError) {
                    console.warn('Taxonomy primitive analysis failed', analysisError);
                }
                if (minifigResponse) {
                    try {
                        minifigLibrary = await minifigResponse.json();
                    } catch (minifigError) {
                        console.warn('Minifig library failed to load. Run: node build-minifig-library.js', minifigError);
                        minifigLibrary = null;
                    }
                }
                if (locationResponse) {
                    try {
                        locationLibrary = await locationResponse.json();
                    } catch (locationError) {
                        console.warn('Location library failed to load.', locationError);
                        locationLibrary = null;
                    }
                }
            } catch (err) {
                alert('Could not load parts taxonomy. Run: node build-part-taxonomy.js');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(4px);
            `;

            const isMobileCatalog = window.innerWidth <= 720;
            
            const content = document.createElement('div');
            if (isMobileCatalog) {
                content.style.cssText = `
                    background: var(--bg-secondary);
                    border: none;
                    border-radius: 0;
                    padding: 12px;
                    width: 100vw;
                    height: 100vh;
                    max-width: 100vw;
                    max-height: 100vh;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                `;
            } else {
                content.style.cssText = `
                    background: var(--bg-secondary);
                    border: 3px solid var(--accent);
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 8px 32px rgba(255,215,0,0.3);
                `;
            }
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 2px solid var(--accent);
            `;
            header.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        <div style="font-weight: 700; color: var(--accent); font-size: 16px;">‚òÖ Parts Catalog Browser</div>
                        <div style="font-size: 11px; color: #aaa; margin-top: 4px;">
                            ${taxonomy.totalParts.toLocaleString()} parts organized by taxonomy
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="mode-taxonomy-btn" style="
                            background: var(--accent);
                            border: none;
                            color: var(--bg-main);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 11px;
                        ">üî¨ TAXONOMY</button>
                        <button id="mode-folk-btn" style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-primary);
                            color: var(--text-primary);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 11px;
                        ">üåæ FOLK</button>
                        <button id="mode-minifig-btn" style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-primary);
                            color: var(--text-primary);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 11px;
                        ">üë§ MINIFIG</button>
                        <button id="mode-location-btn" style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-primary);
                            color: var(--text-primary);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 11px;
                        ">üé¨ LOCATION</button>
                        <button id="close-catalog" style="
                            background: none;
                            border: 2px solid var(--accent);
                            color: var(--accent);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                        ">‚úï CLOSE</button>
                    </div>
                </div>
            `;
            content.appendChild(header);
            
            // Search box
            const searchBox = document.createElement('input');
            searchBox.type = 'text';
            searchBox.placeholder = 'üîç Search parts... (e.g., "3001", "brick 1x2", "minifig head")';
            searchBox.style.cssText = `
                width: 100%;
                padding: ${isMobileCatalog ? '10px' : '12px'};
                font-size: ${isMobileCatalog ? '12px' : '14px'};
                border: 2px solid var(--border-primary);
                border-radius: 6px;
                background: var(--bg-main);
                color: var(--text-primary);
                margin-bottom: ${isMobileCatalog ? '12px' : '16px'};
            `;
            content.appendChild(searchBox);
            
            // Main content area
            const mainArea = document.createElement('div');
            mainArea.style.cssText = `
                display: flex;
                gap: ${isMobileCatalog ? '12px' : '16px'};
                flex: 1;
                overflow: hidden;
                flex-direction: ${isMobileCatalog ? 'column' : 'row'};
            `;
            
            // Left panel - Kingdom list
            const leftPanel = document.createElement('div');
            leftPanel.style.cssText = isMobileCatalog ? `
                width: 100%;
                background: var(--bg-main);
                border: 1px solid var(--border-primary);
                border-radius: 6px;
                padding: 8px;
                max-height: 140px;
                overflow-y: auto;
            ` : `
                width: 280px;
                background: var(--bg-main);
                border: 1px solid var(--border-primary);
                border-radius: 6px;
                padding: 12px;
                overflow-y: auto;
            `;
            
            const kingdomsList = document.createElement('div');
            kingdomsList.innerHTML = '<div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 13px;">KINGDOMS (Part Families)</div>';
            
            Object.entries(taxonomy.kingdoms).sort((a, b) => b[1].count - a[1].count).forEach(([kingdom, data]) => {
                const btn = document.createElement('button');
                btn.style.cssText = `
                    width: 100%;
                    padding: 10px;
                    margin-bottom: 6px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-primary);
                    border-radius: 4px;
                    cursor: pointer;
                    text-align: left;
                    color: var(--text-primary);
                    transition: all 0.2s;
                `;
                btn.innerHTML = `
                    <div style="font-weight: 700; color: var(--accent);">${kingdom}</div>
                    <div style="font-size: 11px; color: #888;">${data.count} parts in ${Object.keys(data.phyla).length} groups</div>
                `;
                btn.addEventListener('mouseenter', () => btn.style.background = 'var(--accent)');
                btn.addEventListener('mouseleave', () => btn.style.background = 'var(--bg-secondary)');
                btn.addEventListener('click', () => showPhyla(kingdom, data));
                kingdomsList.appendChild(btn);
            });
            
            leftPanel.appendChild(kingdomsList);
            mainArea.appendChild(leftPanel);
            
            // Right panel - Details
            const rightPanel = document.createElement('div');
            rightPanel.style.cssText = isMobileCatalog ? `
                flex: 1;
                background: var(--bg-main);
                border: 1px solid var(--border-primary);
                border-radius: 6px;
                padding: 10px;
                overflow-y: auto;
                min-height: 0;
            ` : `
                flex: 1;
                background: var(--bg-main);
                border: 1px solid var(--border-primary);
                border-radius: 6px;
                padding: 16px;
                overflow-y: auto;
            `;
            rightPanel.innerHTML = `
                <div style="color: #aaa; text-align: center; padding: 40px;">
                    Select a kingdom to explore parts ‚Üí
                </div>
            `;
            mainArea.appendChild(rightPanel);
            
            content.appendChild(mainArea);
            modal.appendChild(content);
            document.body.appendChild(modal);

            // LOCATION helpers
            const LOCATION_SLOTS = ['floor', 'wall', 'door', 'window', 'roof', 'tree', 'prop'];
            let currentLocationSelection = {};

            function buildLocationLines(location) {
                const lines = [];
                lines.push(`0 FILE ${location.id || location.title}.mpd`);
                lines.push(`0 Name: ${location.title}`);
                lines.push('0 Author: Grace Catalog Browser');
                lines.push('0 !LDRAW_ORG Model');
                lines.push('0 BFC CERTIFY CCW');
                lines.push('');
                lines.push('0 STEP');
                lines.push('');

                const parts = location.parts || [];
                parts.forEach((part, idx) => {
                    const label = part.label || 'PART';
                    let x = 0, y = 0, z = 0;
                    if (label === 'FLOOR') {
                        x = 0; y = 0; z = 0;
                    } else if (label === 'WALL') {
                        x = 0; y = 80; z = -120;
                    } else if (label === 'DOOR') {
                        x = 0; y = 40; z = -119;
                    } else if (label === 'WINDOW') {
                        x = 60; y = 60; z = -119;
                    } else if (label === 'ROOF') {
                        x = 0; y = 160; z = 0;
                    } else if (label === 'TREE') {
                        x = -160 + idx * 40; y = 0; z = 120;
                    } else if (label === 'PROP') {
                        x = -80 + idx * 40; y = 0; z = 40;
                    }
                    const color = part.colorCode ?? part.color ?? 16;
                    let filename = part.filename || part.path || '';
                    if (filename && !filename.startsWith('parts/')) {
                        filename = `parts/${filename}`;
                    }
                    lines.push(`0 // ${label} - ${part.description || filename}`);
                    lines.push(`1 ${color} ${x} ${y} ${z} 1 0 0 0 1 0 0 0 1 ${filename}`);
                    lines.push('');
                });

                lines.push('0 STEP');
                return lines;
            }

            function loadLocation(lines, name, replace = true) {
                if (replace) {
                    editorLines = [...lines];
                } else {
                    const insertIdx = editorLines.lastIndexOf('0 STEP');
                    const offsetZ = (() => {
                        const matches = editorLines.filter((line) => line.startsWith('1 '));
                        let maxZ = 0;
                        matches.forEach((line) => {
                            const parts = line.trim().split(/\s+/);
                            const z = parseFloat(parts[5]);
                            if (!Number.isNaN(z)) {
                                maxZ = Math.max(maxZ, z);
                            }
                        });
                        return maxZ + 320;
                    })();
                    const shifted = lines.map((line) => {
                        if (!line.startsWith('1 ')) return line;
                        const segments = line.trim().split(/\s+/);
                        const z = parseFloat(segments[5]);
                        if (!Number.isNaN(z)) {
                            segments[5] = (z + offsetZ).toString();
                            return segments.join(' ');
                        }
                        return line;
                    });
                    if (insertIdx >= 0) {
                        editorLines.splice(insertIdx, 0, `0 // Added Location ${name}`, ...shifted, '');
                    } else {
                        editorLines.push(`0 // Added Location ${name}`, ...shifted, '');
                    }
                }

                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                STATE.scenes[STATE.activeSceneIdx].name = name;
                renderEditor(editorLines);
                updateSceneSelector();
                document.getElementById('status-text').textContent = `${replace ? 'Loaded' : '‚ûï Added'} ${name}`;

                if (replace) {
                    document.body.removeChild(modal);
                }

                setTimeout(() => compileCurrentMPD(), 500);
            }

            function showLocationMode() {
                leftPanel.innerHTML = `
                    <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 13px; border-bottom: 2px solid var(--border-primary); padding-bottom: 8px;">
                        üé¨ LOCATION / PRODUCTION DESIGNER
                    </div>
                    <div style="font-size: 11px; color: #aaa; line-height: 1.6;">
                        Use the search box to find environment parts (floors, walls, doors, windows, trees, props) and assign them to slots in the Location Builder.
                    </div>
                `;

                rightPanel.innerHTML = '';

                const builder = document.createElement('div');
                builder.style.cssText = `
                    border: 1px solid var(--border-primary);
                    border-radius: 6px;
                    padding: 12px;
                    background: var(--bg-secondary);
                `;
                builder.innerHTML = `
                    <div style="font-weight: 700; color: var(--accent); font-size: 13px; margin-bottom: 8px;">Location Builder</div>
                    <div style="font-size: 10px; color: #aaa; margin-bottom: 12px;">Assign environment parts to slots below, then LOAD or ADD the assembled location.</div>
                    <div id="location-slots"></div>
                    <div style="margin-top: 8px; margin-bottom: 8px; padding: 8px; border-radius: 4px; background: rgba(0,0,0,0.25); font-size: 10px; color: #ccc;">
                        <div style="font-weight: 700; color: var(--accent); margin-bottom: 4px;">Current Location (preview only)</div>
                        <div id="location-summary">No parts selected.</div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button id="location-load" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--accent); background: var(--bg-main); color: var(--accent); font-size: 11px; cursor: pointer;">üíö LOAD LOCATION</button>
                        <button id="location-add" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--accent); background: var(--accent); color: var(--bg-main); font-size: 11px; cursor: pointer;">‚ûï ADD LOCATION</button>
                    </div>
                `;

                rightPanel.appendChild(builder);

                // Dedicated area for LOCATION search results so the builder
                // stays visible while you browse parts.
                const locationResults = document.createElement('div');
                locationResults.id = 'location-search-results';
                locationResults.style.cssText = 'margin-top: 16px;';
                rightPanel.appendChild(locationResults);

                const slotsContainer = builder.querySelector('#location-slots');
                slotsContainer.innerHTML = '';
                LOCATION_SLOTS.forEach((slotKey) => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 11px;';
                    const label = slotKey.toUpperCase();
                    row.innerHTML = `
                        <div style="font-weight: 700; color: var(--accent); width: 80px;">${label}</div>
                        <div id="location-slot-label-${slotKey}" style="flex: 1; color: #ccc; font-size: 10px;">(empty)</div>
                        <button data-slot="${slotKey}" class="location-clear" style="margin-left: 8px; padding: 4px 6px; border-radius: 4px; border: 1px solid var(--border-primary); background: var(--bg-main); color: #aaa; font-size: 9px; cursor: pointer;">Clear</button>
                    `;
                    slotsContainer.appendChild(row);
                });

                function renderLocationSummary() {
                    const summaryEl = builder.querySelector('#location-summary');
                    if (!summaryEl) return;
                    const rows = [];
                    LOCATION_SLOTS.forEach((slotKey) => {
                        const part = currentLocationSelection[slotKey];
                        if (!part) return;
                        rows.push(`<tr><td style="padding:2px 4px;">${slotKey.toUpperCase()}</td><td style="padding:2px 4px;">${part.filename}</td><td style="padding:2px 4px;">${part.description || ''}</td></tr>`);
                    });
                    if (!rows.length) {
                        summaryEl.textContent = 'No parts selected.';
                    } else {
                        summaryEl.innerHTML = `<table style="width:100%; border-collapse:collapse;"><tbody>${rows.join('')}</tbody></table>`;
                    }
                }

                function updateSlotLabels() {
                    LOCATION_SLOTS.forEach((slotKey) => {
                        const labelEl = builder.querySelector(`#location-slot-label-${slotKey}`);
                        if (!labelEl) return;
                        const part = currentLocationSelection[slotKey];
                        if (!part) {
                            labelEl.textContent = '(empty)';
                        } else {
                            labelEl.textContent = `${part.filename} ‚Äì ${part.description || ''}`;
                        }
                    });
                    renderLocationSummary();
                }

                builder.querySelectorAll('.location-clear').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const slotKey = btn.dataset.slot;
                        delete currentLocationSelection[slotKey];
                        updateSlotLabels();
                    });
                });

                const handleLocation = (replace) => {
                    const parts = [];
                    LOCATION_SLOTS.forEach((slotKey) => {
                        const part = currentLocationSelection[slotKey];
                        if (!part) return;
                        const label = slotKey.toUpperCase();
                        parts.push({ label, filename: part.filename, description: part.description });
                    });
                    if (!parts.length) {
                        alert('Select at least one environment part to build a location.');
                        return;
                    }
                    const location = {
                        id: `location-${Date.now()}`,
                        title: 'Custom Location',
                        parts
                    };
                    const lines = buildLocationLines(location);
                    loadLocation(lines, location.title, replace);
                };

                builder.querySelector('#location-load').addEventListener('click', () => handleLocation(true));
                builder.querySelector('#location-add').addEventListener('click', () => handleLocation(false));

                updateSlotLabels();
            }
            
            // Show paginated parts with load options
            function showPaginatedParts(parts, name, parentElement) {
                const BATCH_SIZE = isMobileCatalog ? 24 : 50;
                let currentPage = 0;
                
                function renderPage() {
                    const start = currentPage * BATCH_SIZE;
                    const end = Math.min(start + BATCH_SIZE, parts.length);
                    const batch = parts.slice(start, end);
                    
                    parentElement.innerHTML = `
                        <div style="color: var(--accent); font-weight: 700; font-size: 14px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border-primary);">
                            ${name} ‚Üí Showing ${start + 1}-${end} of ${parts.length} parts
                        </div>
                    `;
                    
                    // Pagination controls at TOP
                    if (parts.length > BATCH_SIZE) {
                        const paginationTop = document.createElement('div');
                        paginationTop.style.cssText = `
                            display: flex;
                            gap: 8px;
                            margin-bottom: 12px;
                            justify-content: center;
                            align-items: center;
                        `;
                        
                        if (currentPage > 0) {
                            const prevBtn = document.createElement('button');
                            prevBtn.textContent = '‚Üê';
                            prevBtn.style.cssText = `
                                padding: 8px 12px;
                                background: var(--accent);
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                color: var(--bg-main);
                                font-weight: 700;
                            `;
                            prevBtn.addEventListener('click', () => {
                                currentPage--;
                                renderPage();
                            });
                            paginationTop.appendChild(prevBtn);
                        }
                        
                        const pageInfo = document.createElement('div');
                        pageInfo.style.cssText = `
                            padding: 8px 16px;
                            color: var(--text-primary);
                            font-weight: 700;
                        `;
                        pageInfo.textContent = `Page ${currentPage + 1} / ${Math.ceil(parts.length / BATCH_SIZE)}`;
                        paginationTop.appendChild(pageInfo);
                        
                        if (end < parts.length) {
                            const nextBtn = document.createElement('button');
                            nextBtn.textContent = '‚Üí';
                            nextBtn.style.cssText = `
                                padding: 8px 12px;
                                background: var(--accent);
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                color: var(--bg-main);
                                font-weight: 700;
                            `;
                            nextBtn.addEventListener('click', () => {
                                currentPage++;
                                renderPage();
                            });
                            paginationTop.appendChild(nextBtn);
                        }
                        
                        parentElement.appendChild(paginationTop);
                    }
                    
                    // Load batch buttons
                    const loadControls = document.createElement('div');
                    loadControls.style.cssText = `
                        display: flex;
                        gap: 8px;
                        margin-bottom: ${isMobileCatalog ? '8px' : '12px'};
                    `;
                    loadControls.innerHTML = `
                        <button id="load-batch-replace" style="
                            flex: 1;
                            background: var(--accent);
                            color: var(--bg-main);
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 11px;
                        ">üíö LOAD THESE ${batch.length}</button>
                        <button id="load-batch-add" style="
                            flex: 1;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border: 1px solid var(--border-primary);
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 11px;
                        ">‚ûï ADD TO SCENE</button>
                    `;
                    parentElement.appendChild(loadControls);
                    
                    // Parts list with previews
                    batch.forEach(part => {
                        const partDiv = document.createElement('div');
                        partDiv.style.cssText = `
                            padding: ${isMobileCatalog ? '6px' : '8px'};
                            margin-bottom: 4px;
                            background: var(--bg-secondary);
                            border-radius: 4px;
                            font-size: ${isMobileCatalog ? '10px' : '11px'};
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            gap: ${isMobileCatalog ? '8px' : '12px'};
                        `;
                        partDiv.innerHTML = `
                            <div class="part-preview" style="
                                width: ${isMobileCatalog ? '48px' : '60px'};
                                height: ${isMobileCatalog ? '48px' : '60px'};
                                background: var(--bg-main);
                                border: 1px solid var(--border-primary);
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: var(--accent);
                                font-size: ${isMobileCatalog ? '8px' : '9px'};
                                text-align: center;
                                flex-shrink: 0;
                            ">
                                <div style="padding: 4px;">
                                    üì¶<br>${part.filename.split('.')[0].substring(0, 6)}
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--accent);">${part.filename}</div>
                                <div style="color: #aaa; font-size: ${isMobileCatalog ? '9px' : '10px'};">${part.description || part.name}</div>
                            </div>
                            <button class="add-single-part" style="
                                background: var(--accent);
                                border: none;
                                padding: ${isMobileCatalog ? '3px 6px' : '4px 8px'};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: ${isMobileCatalog ? '9px' : '10px'};
                                color: var(--bg-main);
                                flex-shrink: 0;
                            ">‚ûï</button>
                        `;
                        partDiv.querySelector('.add-single-part').addEventListener('click', (e) => {
                            e.stopPropagation();
                            addPartToScene([part], part.filename);
                        });
                        partDiv.addEventListener('click', () => {
                            navigator.clipboard.writeText(part.path);
                            document.getElementById('status-text').textContent = `üìã Copied: ${part.path}`;
                        });
                        parentElement.appendChild(partDiv);
                    });
                    
                    // Pagination controls
                    if (parts.length > BATCH_SIZE) {
                        const pagination = document.createElement('div');
                        pagination.style.cssText = `
                            display: flex;
                            gap: 8px;
                            margin-top: 12px;
                            justify-content: center;
                        `;
                        
                        if (currentPage > 0) {
                            const prevBtn = document.createElement('button');
                            prevBtn.textContent = '‚Üê Previous';
                            prevBtn.style.cssText = `
                                padding: 8px 16px;
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-primary);
                                border-radius: 4px;
                                cursor: pointer;
                                color: var(--text-primary);
                            `;
                            prevBtn.addEventListener('click', () => {
                                currentPage--;
                                renderPage();
                            });
                            pagination.appendChild(prevBtn);
                        }
                        
                        const pageInfo = document.createElement('div');
                        pageInfo.style.cssText = `
                            padding: 8px 16px;
                            color: var(--text-primary);
                            display: flex;
                            align-items: center;
                        `;
                        pageInfo.textContent = `Page ${currentPage + 1} of ${Math.ceil(parts.length / BATCH_SIZE)}`;
                        pagination.appendChild(pageInfo);
                        
                        if (end < parts.length) {
                            const nextBtn = document.createElement('button');
                            nextBtn.textContent = 'Next ‚Üí';
                            nextBtn.style.cssText = `
                                padding: 8px 16px;
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-primary);
                                border-radius: 4px;
                                cursor: pointer;
                                color: var(--text-primary);
                            `;
                            nextBtn.addEventListener('click', () => {
                                currentPage++;
                                renderPage();
                            });
                            pagination.appendChild(nextBtn);
                        }
                        
                        parentElement.appendChild(pagination);
                    }
                    
                    // Wire up batch load buttons
                    document.getElementById('load-batch-replace').addEventListener('click', () => {
                        loadPartsToScene(batch, `${name} (${start + 1}-${end})`, true);
                    });
                    
                    document.getElementById('load-batch-add').addEventListener('click', () => {
                        addPartToScene(batch, `${name} (${start + 1}-${end})`);
                    });
                }
                
                renderPage();
            }
            
            // Add parts to existing scene
            function addPartToScene(parts, name) {
                const GRID_SPACING = 200;
                const COLUMNS = 6;
                const Y_OFFSET = -50;
                
                // Find next available Z position
                const currentLines = editorLines.join('\n');
                const lineMatches = currentLines.match(/1\s+\d+\s+[\d\-\.]+\s+[\d\-\.]+\s+([\d\-\.]+)/g);
                let maxZ = 0;
                if (lineMatches) {
                    lineMatches.forEach(line => {
                        const z = parseFloat(line.split(/\s+/)[5]);
                        if (!isNaN(z) && z > maxZ) maxZ = z;
                    });
                }
                const startZ = maxZ + GRID_SPACING * 2;
                
                // Generate new part lines
                const newLines = [];
                newLines.push(`0 // Added from ${name}`);
                
                parts.forEach((part, idx) => {
                    const col = idx % COLUMNS;
                    const row = Math.floor(idx / COLUMNS);
                    const x = col * GRID_SPACING - ((COLUMNS - 1) * GRID_SPACING / 2);
                    const y = Y_OFFSET;
                    const z = startZ + (row * GRID_SPACING);
                    const color = ((idx % 15) + 1);
                    
                    // Use filename only for LDraw (e.g., "3001.dat" not "parts/3001.dat")
                    const partRef = part.filename || part.path;
                    
                    newLines.push(`0 // ${part.description || part.name}`);
                    newLines.push(`1 ${color} ${x} ${y} ${z} 1 0 0 0 1 0 0 0 1 ${partRef}`);
                });
                
                // Insert before final STEP
                const stepIdx = editorLines.lastIndexOf('0 STEP');
                if (stepIdx > 0) {
                    editorLines.splice(stepIdx, 0, ...newLines, '');
                } else {
                    editorLines.push(...newLines);
                }
                
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = `‚ûï Added ${parts.length} parts to scene`;
                
                // Auto-compile
                setTimeout(() => compileCurrentMPD(), 500);
            }
            
            // Generate MPD from parts and load to scene
            function loadPartsToScene(parts, name, replace = true) {
                const GRID_SPACING = 200;
                const COLUMNS = 6;
                const Y_OFFSET = -50;
                
                let mpd = `0 FILE ${name.replace(/\s+/g, '_')}.mpd\n`;
                mpd += `0 Name: ${name}\n`;
                mpd += `0 Author: Grace Catalog Browser\n`;
                mpd += `0 !LDRAW_ORG Model\n`;
                mpd += `0 BFC CERTIFY CCW\n\n`;
                mpd += `0 STEP\n\n`;
                
                parts.forEach((part, idx) => {
                    const col = idx % COLUMNS;
                    const row = Math.floor(idx / COLUMNS);
                    const x = col * GRID_SPACING - ((COLUMNS - 1) * GRID_SPACING / 2);
                    const y = Y_OFFSET;
                    const z = row * GRID_SPACING;
                    const color = ((idx % 15) + 1);
                    
                    // Use filename only for LDraw (e.g., "3001.dat" not "parts/3001.dat")
                    const partRef = part.filename || part.path;
                    
                    mpd += `0 // ${idx + 1}. ${part.description || part.name}\n`;
                    mpd += `1 ${color} ${x} ${y} ${z} 1 0 0 0 1 0 0 0 1 ${partRef}\n\n`;
                });
                
                mpd += `0 STEP\n`;
                
                // Load into editor
                editorLines = mpd.split('\n');
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                STATE.scenes[STATE.activeSceneIdx].name = name;
                renderEditor(editorLines);
                updateSceneSelector();
                document.getElementById('status-text').textContent = `Loaded ${parts.length} parts from ${name}`;
                
                // Close modal if replace
                if (replace) {
                    document.body.removeChild(modal);
                }
                
                // Auto-compile
                setTimeout(() => compileCurrentMPD(), 500);
            }
            
            // Show phyla for a kingdom
            function showPhyla(kingdom, kingdomData) {
                rightPanel.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 2px solid var(--border-primary); padding-bottom: 8px;">
                        <div style="color: var(--accent); font-weight: 700; font-size: 16px;">
                            ${kingdom} ‚Üí ${kingdomData.count} parts
                        </div>
                        <button id="load-kingdom-btn" style="
                            background: var(--accent);
                            color: var(--bg-main);
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 12px;
                        ">üíö LOAD ALL</button>
                    </div>
                `;
                
                // Load kingdom button - show paginated view
                setTimeout(() => {
                    document.getElementById('load-kingdom-btn').addEventListener('click', () => {
                        const allParts = [];
                        Object.values(kingdomData.phyla).forEach(phylumData => {
                            Object.values(phylumData.classes).forEach(classData => {
                                Object.values(classData.orders).forEach(orderData => {
                                    Object.values(orderData.families).forEach(familyData => {
                                        allParts.push(...familyData.parts);
                                    });
                                });
                            });
                        });
                        showPaginatedParts(allParts, `${kingdom} Kingdom`, rightPanel);
                    });
                }, 0);
                
                Object.entries(kingdomData.phyla).sort((a, b) => b[1].count - a[1].count).forEach(([phylum, phylumData]) => {
                    const section = document.createElement('div');
                    section.style.cssText = `
                        margin-bottom: 12px;
                        border: 1px solid var(--border-primary);
                        border-radius: 4px;
                        overflow: hidden;
                    `;
                    
                    const phylumHeader = document.createElement('div');
                    phylumHeader.style.cssText = `
                        width: 100%;
                        padding: 12px;
                        background: var(--bg-secondary);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        gap: 8px;
                    `;
                    
                    const phylumInfo = document.createElement('div');
                    phylumInfo.style.cssText = `
                        flex: 1;
                        cursor: pointer;
                    `;
                    phylumInfo.innerHTML = `
                        <div style="font-weight: 700; color: var(--accent);">${phylum}</div>
                        <div style="font-size: 11px; color: #888;">${phylumData.count} parts</div>
                    `;
                    
                    const phylumActions = document.createElement('div');
                    phylumActions.style.cssText = `
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    `;
                    
                    const loadBtn = document.createElement('button');
                    loadBtn.textContent = 'üíö';
                    loadBtn.title = 'Load to scene';
                    loadBtn.style.cssText = `
                        background: var(--accent);
                        border: none;
                        padding: 4px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 14px;
                    `;
                    loadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const parts = [];
                        Object.values(phylumData.classes).forEach(classData => {
                            Object.values(classData.orders).forEach(orderData => {
                                Object.values(orderData.families).forEach(familyData => {
                                    parts.push(...familyData.parts);
                                });
                            });
                        });
                        showPaginatedParts(parts, `${kingdom} ‚Üí ${phylum}`, rightPanel);
                    });
                    
                    const expandBtn = document.createElement('div');
                    expandBtn.textContent = '‚ñ∂';
                    expandBtn.style.cssText = `
                        color: var(--accent);
                        font-size: 18px;
                        cursor: pointer;
                    `;
                    
                    phylumActions.appendChild(loadBtn);
                    phylumActions.appendChild(expandBtn);
                    phylumHeader.appendChild(phylumInfo);
                    phylumHeader.appendChild(phylumActions);
                    
                    const phylumContent = document.createElement('div');
                    phylumContent.style.cssText = `
                        display: none;
                        padding: 12px;
                        background: var(--bg-main);
                        max-height: 300px;
                        overflow-y: auto;
                    `;
                    
                    // Expand button click (same as phylumInfo)
                    expandBtn.addEventListener('click', () => {
                        phylumInfo.click();
                    });
                    
                    phylumInfo.addEventListener('click', () => {
                        const isOpen = phylumContent.style.display === 'block';
                        phylumContent.style.display = isOpen ? 'none' : 'block';
                        expandBtn.textContent = isOpen ? '‚ñ∂' : '‚ñº';
                        
                        if (!isOpen && phylumContent.children.length === 0) {
                            // Load parts lazily
                            Object.entries(phylumData.classes).forEach(([klass, classData]) => {
                                Object.entries(classData.orders).forEach(([order, orderData]) => {
                                    Object.entries(orderData.families).forEach(([family, familyData]) => {
                                        familyData.parts.forEach(part => {
                                            const partDiv = document.createElement('div');
                                            partDiv.style.cssText = `
                                                padding: 8px;
                                                margin-bottom: 4px;
                                                background: var(--bg-secondary);
                                                border-radius: 4px;
                                                font-size: 11px;
                                                cursor: pointer;
                                                transition: all 0.2s;
                                            `;
                                            partDiv.innerHTML = `
                                                <div style="font-weight: 700; color: var(--accent);">${part.filename}</div>
                                                <div style="color: #aaa;">${part.description || part.name}</div>
                                            `;
                                            partDiv.addEventListener('mouseenter', () => partDiv.style.background = 'var(--accent)');
                                            partDiv.addEventListener('mouseleave', () => partDiv.style.background = 'var(--bg-secondary)');
                                            partDiv.addEventListener('click', () => {
                                                navigator.clipboard.writeText(part.path);
                                                document.getElementById('status-text').textContent = `üìã Copied: ${part.path}`;
                                            });
                                            phylumContent.appendChild(partDiv);
                                        });
                                    });
                                });
                            });
                        }
                    });
                    
                    section.appendChild(phylumHeader);
                    section.appendChild(phylumContent);
                    rightPanel.appendChild(section);
                });
            }
            
            // Track which mode is currently active for search behavior
            let currentCatalogMode = 'taxonomy'; // 'taxonomy' | 'folk' | 'minifig' | 'location'

            // Search functionality
            searchBox.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 2) return;

                if (currentCatalogMode !== 'location') {
                    // Default: search across all parts and show copyable paths
                    rightPanel.innerHTML = `
                        <div style="color: var(--accent); font-weight: 700; font-size: 16px; margin-bottom: 16px; border-bottom: 2px solid var(--border-primary); padding-bottom: 8px;">
                            üîç Search Results for "${query}"
                        </div>
                    `;

                    let count = 0;
                    Object.values(taxonomy.kingdoms).forEach(kingdomData => {
                        Object.values(kingdomData.phyla).forEach(phylumData => {
                            Object.values(phylumData.classes).forEach(classData => {
                                Object.values(classData.orders).forEach(orderData => {
                                    Object.values(orderData.families).forEach(familyData => {
                                        familyData.parts.forEach(part => {
                                            const text = `${part.filename} ${part.name} ${part.description}`.toLowerCase();
                                            if (text.includes(query) && count < 100) {
                                                const partDiv = document.createElement('div');
                                                partDiv.style.cssText = `
                                                    padding: 8px;
                                                    margin-bottom: 4px;
                                                    background: var(--bg-secondary);
                                                    border-radius: 4px;
                                                    font-size: 11px;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                `;
                                                partDiv.innerHTML = `
                                                    <div style="font-weight: 700; color: var(--accent);">${part.filename}</div>
                                                    <div style="color: #aaa;">${part.description || part.name}</div>
                                                `;
                                                partDiv.addEventListener('mouseenter', () => partDiv.style.background = 'var(--accent)');
                                                partDiv.addEventListener('mouseleave', () => partDiv.style.background = 'var(--bg-secondary)');
                                                partDiv.addEventListener('click', () => {
                                                    navigator.clipboard.writeText(part.path);
                                                    document.getElementById('status-text').textContent = `üìã Copied: ${part.path}`;
                                                });
                                                resultsHost.appendChild(partDiv);
                                                count++;
                                            }
                                        });
                                    });
                                });
                            });
                        });
                    });

                    if (count === 0) {
                        rightPanel.innerHTML += `<div style="color: #888; text-align: center; padding: 20px;">No parts found</div>`;
                    } else if (count === 100) {
                        rightPanel.innerHTML += `<div style="color: var(--accent); text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 4px; margin-top: 12px;">Showing first 100 results. Refine search for more.</div>`;
                    }
                    return;
                }

                // LOCATION mode search: present environment parts and allow assigning to slots
                const resultsHost = document.getElementById('location-search-results') || rightPanel;
                resultsHost.innerHTML = `
                    <div style="color: var(--accent); font-weight: 700; font-size: 16px; margin-bottom: 16px; border-bottom: 2px solid var(--border-primary); padding-bottom: 8px;">
                        üé¨ Location Search for "${query}"
                    </div>
                `;

                const slotKeys = ['floor', 'wall', 'door', 'window', 'roof', 'tree', 'prop'];
                const slotBuckets = (locationLibrary && locationLibrary.slotBuckets) || null;

                const getAllowedSlotsForKingdom = (kingdomName) => {
                    if (!slotBuckets) return slotKeys;
                    const allowed = slotKeys.filter((slotKey) => {
                        const cfg = slotBuckets[slotKey.toUpperCase()];
                        return cfg && Array.isArray(cfg.kingdoms) && cfg.kingdoms.includes(kingdomName);
                    });
                    return allowed.length ? allowed : slotKeys;
                };

                let count = 0;
                Object.entries(taxonomy.kingdoms).forEach(([kingdomName, kingdomData]) => {
                    Object.values(kingdomData.phyla).forEach((phylumData) => {
                        Object.values(phylumData.classes).forEach((classData) => {
                            Object.values(classData.orders).forEach((orderData) => {
                                Object.values(orderData.families).forEach((familyData) => {
                                    familyData.parts.forEach((part) => {
                                        const text = `${part.filename} ${part.name} ${part.description}`.toLowerCase();
                                        if (!text.includes(query) || count >= 100) return;

                                        const allowedSlots = getAllowedSlotsForKingdom(kingdomName);
                                        if (!allowedSlots.length) return;

                                        const partDiv = document.createElement('div');
                                        partDiv.style.cssText = `
                                            padding: 8px;
                                            margin-bottom: 6px;
                                            background: var(--bg-secondary);
                                            border-radius: 4px;
                                            font-size: 11px;
                                            display: flex;
                                            flex-direction: column;
                                            gap: 4px;
                                        `;
                                        const titleHtml = `
                                            <div style="font-weight: 700; color: var(--accent);">${part.filename}</div>
                                            <div style="color: #aaa;">${part.description || part.name}</div>
                                            <div style="color: #666; font-size: 9px;">${kingdomName}</div>
                                        `;
                                        const buttonsHtml = allowedSlots.map((slotKey) => `<button data-slot="${slotKey}" class="location-assign" style="padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-primary); background: var(--bg-main); color: var(--text-primary); font-size: 9px; cursor: pointer; margin-right: 4px;">${slotKey.toUpperCase()}</button>`).join('');
                                        partDiv.innerHTML = `
                                            ${titleHtml}
                                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 2px;">${buttonsHtml}</div>
                                        `;

                                        partDiv.querySelectorAll('.location-assign').forEach((btn) => {
                                            btn.addEventListener('click', () => {
                                                const slotKey = btn.dataset.slot;
                                                currentLocationSelection[slotKey] = {
                                                    filename: part.filename,
                                                    description: part.description || part.name
                                                };
                                                // Update labels/summary inside the Location Builder if present
                                                const slotLabel = document.querySelector(`#location-slot-label-${slotKey}`);
                                                if (slotLabel) {
                                                    slotLabel.textContent = `${part.filename} ‚Äì ${part.description || part.name}`;
                                                }
                                                const summaryEl = document.querySelector('#location-summary');
                                                if (summaryEl) {
                                                    // Trigger a synthetic update by calling showLocationMode's helpers indirectly is complex;
                                                    // instead, rebuild summary here.
                                                    const rows = [];
                                                    slotKeys.forEach((key) => {
                                                        const p = currentLocationSelection[key];
                                                        if (!p) return;
                                                        rows.push(`<tr><td style="padding:2px 4px;">${key.toUpperCase()}</td><td style="padding:2px 4px;">${p.filename}</td><td style="padding:2px 4px;">${p.description || ''}</td></tr>`);
                                                    });
                                                    if (!rows.length) {
                                                        summaryEl.textContent = 'No parts selected.';
                                                    } else {
                                                        summaryEl.innerHTML = `<table style="width:100%; border-collapse:collapse;"><tbody>${rows.join('')}</tbody></table>`;
                                                    }
                                                }
                                            });
                                        });

                                        rightPanel.appendChild(partDiv);
                                        count++;
                                    });
                                });
                            });
                        });
                    });
                });

                if (count === 0) {
                    resultsHost.innerHTML += `<div style="color: #888; text-align: center; padding: 20px;">No environment parts found</div>`;
                } else if (count === 100) {
                    resultsHost.innerHTML += `<div style="color: var(--accent); text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 4px; margin-top: 12px;">Showing first 100 results. Refine search for more.</div>`;
                }
            });
            
            // Helpers for minifig handling
            const MINIFIG_HEIGHTS = {
                HEAD: { x: 0, y: -84, z: 0 },
                HEADGEAR: { x: 0, y: -84, z: 0 },
                TORSO: { x: 0, y: -60, z: 0 },
                'LEFT ARM': { x: -15.552, y: -51, z: 0 },
                'RIGHT ARM': { x: 15.552, y: -51, z: 0 },
                HIPS: { x: 0, y: -28, z: 0 },
                'LEFT LEG': { x: -6, y: -16, z: 0 },
                'RIGHT LEG': { x: 6, y: -16, z: 0 }
            };

            function buildMinifigLines(character) {
                const lines = [];
                lines.push(`0 FILE ${character.id || character.title}.mpd`);
                lines.push(`0 Name: ${character.title}`);
                lines.push('0 Author: Grace Catalog Browser');
                lines.push('0 !LDRAW_ORG Model');
                lines.push('0 BFC CERTIFY CCW');
                lines.push('');
                if (character.metadata) {
                    character.metadata.split('\n').forEach((entry) => lines.push(entry));
                }
                lines.push('0 STEP');
                lines.push('');

                (character.parts || []).forEach((part) => {
                    const position = MINIFIG_HEIGHTS[part.label] || { x: 0, y: -50, z: 0 };
                    const dy = part.dy || 0;
                    const color = part.colorCode ?? part.color ?? 16;
                    let filename = part.filename || part.path || '';
                    if (filename && !filename.startsWith('parts/')) {
                        filename = `parts/${filename}`;
                    }
                    lines.push(`0 // ${part.label} - ${part.description || filename}`);
                    lines.push(`1 ${color} ${position.x} ${position.y + dy} ${position.z} 1 0 0 0 1 0 0 0 1 ${filename}`);
                    lines.push('');
                });

                lines.push('0 STEP');
                return lines;
            }

            function buildMinifigFromHeadPart(headPart) {
                const label = headPart.description || headPart.name || headPart.filename;
                const color = 16;
                const parts = [];

                // Decide whether this selection is a true head or a headgear piece.
                const role = headPart.headRole || 'standard';
                let baseHead = headPart;
                let headgear = null;

                if (role === 'headdress') {
                    const allHeads = (minifigLibrary && minifigLibrary.parts && minifigLibrary.parts.heads) || [];
                    const viableBaseHeads = allHeads.filter(
                        (h) => h.viableStandardHead && h.canonicalHead && h.primary !== false && h.isHalf !== true
                    );
                    if (viableBaseHeads.length) {
                        baseHead = viableBaseHeads[0];
                    }
                    headgear = headPart;
                }

                const baseHeadLabel = baseHead.description || baseHead.name || baseHead.filename;
                const baseRole = baseHead.headRole || role;
                // Only apply a vertical offset to obviously sculpted heads
                // (character or animal roles). Standard heads, even if they
                // use non-3626 filenames, stay at canonical height.
                const needsSculptedOffset = baseRole === 'character' || baseRole === 'animal';
                const baseDy = needsSculptedOffset ? 20 : 0;
                parts.push({ label: 'HEAD', filename: baseHead.filename, description: baseHeadLabel, color, dy: baseDy });

                if (headgear) {
                    // Place chosen headdress as a separate part sitting at head height.
                    parts.push({ label: 'HEADGEAR', filename: headgear.filename, description: label, color, dy: baseDy });
                }

                // Use torso shortcut with built-in arms and hands so the
                // default auto-assembled minifig has hands without needing
                // separate arm/hand parts, and avoids double-arming.
                parts.push({ label: 'TORSO', filename: '973c01.dat', description: 'Torso with arms and hands', color });
                parts.push({ label: 'HIPS', filename: '3815.dat', description: 'Hip joint', color });
                parts.push({ label: 'LEFT LEG', filename: '3816.dat', description: 'Left leg', color });
                parts.push({ label: 'RIGHT LEG', filename: '3817.dat', description: 'Right leg', color });
                return {
                    id: `minifig-from-${(headPart.filename || 'head').replace(/[^a-z0-9]/gi, '_')}`,
                    title: label,
                    parts
                };
            }

            function loadMinifig(lines, name, replace = true) {
                if (replace) {
                    editorLines = [...lines];
                } else {
                    const insertIdx = editorLines.lastIndexOf('0 STEP');
                    const offsetZ = (() => {
                        const matches = editorLines.filter((line) => line.startsWith('1 '));
                        let maxZ = 0;
                        matches.forEach((line) => {
                            const parts = line.trim().split(/\s+/);
                            const z = parseFloat(parts[5]);
                            if (!Number.isNaN(z)) {
                                maxZ = Math.max(maxZ, z);
                            }
                        });
                        return maxZ + 220;
                    })();
                    const shifted = lines.map((line) => {
                        if (!line.startsWith('1 ')) return line;
                        const segments = line.trim().split(/\s+/);
                        const z = parseFloat(segments[5]);
                        if (!Number.isNaN(z)) {
                            segments[5] = (z + offsetZ).toString();
                            return segments.join(' ');
                        }
                        return line;
                    });
                    if (insertIdx >= 0) {
                        editorLines.splice(insertIdx, 0, `0 // Added Minifig ${name}`, ...shifted, '');
                    } else {
                        editorLines.push(`0 // Added Minifig ${name}`, ...shifted, '');
                    }
                }

                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                STATE.scenes[STATE.activeSceneIdx].name = name;
                renderEditor(editorLines);
                updateSceneSelector();
                document.getElementById('status-text').textContent = `${replace ? 'Loaded' : '‚ûï Added'} ${name}`;

                if (replace) {
                    document.body.removeChild(modal);
                }

                setTimeout(() => compileCurrentMPD(), 500);
            }

            function renderCuratedMinifig(character) {
                const card = document.createElement('div');
                card.style.cssText = `
                    border: 1px solid var(--border-primary);
                    border-radius: 6px;
                    padding: 12px;
                    margin-bottom: 12px;
                    background: var(--bg-secondary);
                `;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 700; color: var(--accent); font-size: 14px;">${character.title}</div>
                            <div style="font-size: 11px; color: #888;">${character.personality || ''}</div>
                            <div style="font-size: 10px; color: #aaa;">${character.archetype || ''}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="minifig-action-load" style="padding: 6px 10px; border-radius: 4px; border: 1px solid var(--accent); background: var(--bg-main); color: var(--accent); font-size: 10px; cursor: pointer;">üíö LOAD</button>
                            <button class="minifig-action-add" style="padding: 6px 10px; border-radius: 4px; border: 1px solid var(--accent); background: var(--accent); color: var(--bg-main); font-size: 10px; cursor: pointer;">‚ûï ADD</button>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: var(--text-primary); line-height: 1.4;">${character.metadata || 'Fully assembled minifig archetype'}</div>
                    <div style="margin-top: 8px; font-size: 10px; color: #aaa;">Parts: ${(character.parts || []).map((p) => `${p.label}: ${p.filename}`).join(', ')}</div>
                `;

                card.querySelector('.minifig-action-load').addEventListener('click', () => {
                    const lines = buildMinifigLines(character);
                    loadMinifig(lines, character.title, true);
                });
                card.querySelector('.minifig-action-add').addEventListener('click', () => {
                    const lines = buildMinifigLines(character);
                    loadMinifig(lines, character.title, false);
                });

                return card;
            }

            function renderMinifigBuilder() {
                if (!minifigLibrary?.parts) return null;
                const buckets = minifigLibrary.parts;
                const builder = document.createElement('div');
                builder.style.cssText = `
                    border: 1px solid var(--border-primary);
                    border-radius: 6px;
                    padding: 12px;
                    margin-top: 24px;
                    background: var(--bg-secondary);
                `;
                builder.innerHTML = `
                    <div style="font-weight: 700; color: var(--accent); font-size: 13px; margin-bottom: 8px;">Custom Minifig Builder</div>
                    <div style="font-size: 10px; color: #aaa; margin-bottom: 12px;">Pick individual parts to assemble a custom minifig. Leave Head empty to build body-only templates.</div>
                `;

                const filterWrapper = document.createElement('div');
                filterWrapper.style.cssText = 'margin-bottom: 12px;';
                filterWrapper.innerHTML = `
                    <input id="minifig-builder-filter" type="text" placeholder="Filter by keyword across parts (e.g., &quot;yoda&quot;, &quot;simpsons&quot;)" style="width: 100%; padding: 6px 8px; font-size: 11px; border-radius: 4px; border: 1px solid var(--border-primary); background: var(--bg-main); color: var(--text-primary);" />
                `;
                builder.appendChild(filterWrapper);

                const selects = [];
                const createSelect = (label, key, options) => {
                    const wrapper = document.createElement('div');
                    wrapper.style.marginBottom = '12px';
                    wrapper.innerHTML = `<div style="font-weight: 700; color: var(--accent); font-size: 11px; margin-bottom: 4px;">${label}</div>`;
                    const select = document.createElement('select');
                    select.dataset.key = key;
                    select.style.cssText = `
                        width: 100%;
                        padding: 8px;
                        background: var(--bg-main);
                        color: var(--text-primary);
                        border: 1px solid var(--border-primary);
                        border-radius: 4px;
                        font-size: 11px;
                    `;
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = `Select ${label}`;
                    select.appendChild(placeholder);
                    options.forEach((item) => {
                        const option = document.createElement('option');
                        option.value = item.filename;
                        option.dataset.description = item.description || '';

                        const tags = [];
                        if (key === 'torso') {
                            if (item.upperComplete) tags.push('upperComplete');
                            else if (item.includesArms || item.includesHands) tags.push('arms attached');
                        } else if (key === 'hips' || key === 'legs') {
                            if (item.lowerComplete) tags.push('lowerComplete');
                            if (item.includesHips) tags.push('+hips');
                            if (item.includesLegs) tags.push('+legs');
                            if (item.side) tags.push(`side: ${item.side}`);
                        } else if (key === 'head') {
                            const role = item.headRole || 'standard';
                            if (role === 'headdress') {
                                tags.push(item.headgearType ? `headgear: ${item.headgearType}` : 'headgear');
                            } else if (role && role !== 'standard') {
                                tags.push(role);
                            }
                            if (item.viableStandardHead) tags.push('viable');
                        }

                        const meta = tags.length ? ` [${tags.join(', ')}]` : '';
                        option.textContent = `${item.filename}${meta} ‚Äì ${item.description || 'No description'}`;
                        select.appendChild(option);
                    });
                    wrapper.appendChild(select);
                    builder.appendChild(wrapper);
                    selects.push(select);
                };

                if (buckets.heads?.length) {
                    const allHeads = buckets.heads;
                    const headOptions = allHeads.filter((h) => h.headRole !== 'artifact' && h.headRole !== 'headdress');
                    const hatOptions = allHeads.filter((h) => h.headRole === 'headdress');
                    // Hat/Headgear sits visually above the head in the builder.
                    if (hatOptions.length) createSelect('Hat / Headgear', 'hat', hatOptions);
                    if (headOptions.length) createSelect('Head', 'head', headOptions);
                }
                if (buckets.torsos?.length) createSelect('Torso', 'torso', buckets.torsos);
                if (buckets.arms?.length) createSelect('Arms (pair)', 'arms', buckets.arms);
                if (buckets.hips?.length) createSelect('Hips', 'hips', buckets.hips);
                if (buckets.legs?.length) createSelect('Legs (pair)', 'legs', buckets.legs);

                const findSelect = (key) => selects.find((s) => s.dataset.key === key) || null;

                const applyInterlocks = () => {
                    const selection = getSelection();

                    const torsoSelect = findSelect('torso');
                    const armsSelect = findSelect('arms');
                    const hipsSelect = findSelect('hips');
                    const legsSelect = findSelect('legs');

                    const torsoHasUpper = selection.torso && (selection.torso.upperComplete || selection.torso.includesArms || selection.torso.includesHands);

                    if (armsSelect) {
                        if (torsoHasUpper) {
                            armsSelect.value = '';
                            armsSelect.disabled = true;
                        } else {
                            armsSelect.disabled = false;
                        }
                    }

                    const hipsHasLegs = selection.hips && (selection.hips.lowerComplete || selection.hips.includesLegs);
                    const legsHasHips = selection.legs && (selection.legs.lowerComplete || selection.legs.includesHips);

                    if (hipsSelect) {
                        if (legsHasHips) {
                            hipsSelect.value = '';
                            hipsSelect.disabled = true;
                        } else {
                            hipsSelect.disabled = false;
                        }
                    }

                    if (legsSelect) {
                        if (hipsHasLegs) {
                            legsSelect.value = '';
                            legsSelect.disabled = true;
                        } else {
                            legsSelect.disabled = false;
                        }
                    }
                };

                // Placeholder; will hook after we define getSelection/renderCurrentBuild
                let renderCurrentBuild = null;

                const filterInput = builder.querySelector('#minifig-builder-filter');
                if (filterInput) {
                    const applyFilter = () => {
                        const term = filterInput.value.trim().toLowerCase();
                        selects.forEach((select) => {
                            Array.from(select.options).forEach((opt) => {
                                if (!opt.value) return; // placeholder
                                const text = opt.textContent.toLowerCase();
                                opt.hidden = !!term && !text.includes(term);
                            });
                        });
                    };
                    filterInput.addEventListener('input', applyFilter);
                }

                const currentBuild = document.createElement('div');
                currentBuild.style.cssText = 'margin-top: 8px; margin-bottom: 8px; padding: 8px; border-radius: 4px; background: rgba(0,0,0,0.25); font-size: 10px; color: #ccc;';
                currentBuild.innerHTML = '<div style="font-weight: 700; color: var(--accent); margin-bottom: 4px;">Current Build (preview only)</div><div id="minifig-builder-summary">No parts selected.</div>';
                builder.appendChild(currentBuild);

                const actions = document.createElement('div');
                actions.style.cssText = 'display: flex; gap: 8px; margin-top: 12px;';
                actions.innerHTML = `
                    <button id="minifig-builder-load" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--accent); background: var(--bg-main); color: var(--accent); font-size: 11px; cursor: pointer;">üíö LOAD CUSTOM</button>
                    <button id="minifig-builder-add" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--accent); background: var(--accent); color: var(--bg-main); font-size: 11px; cursor: pointer;">‚ûï ADD CUSTOM</button>
                `;
                builder.appendChild(actions);

                const getSelection = () => {
                    const selection = {};
                    selects.forEach((select) => {
                        if (!select.value) return;
                        const bucketKey = select.dataset.key;
                        const options = buckets[bucketKey] || buckets[`${bucketKey}s`] || [];
                        const match = options.find((item) => item.filename === select.value);
                        selection[bucketKey] = match || {
                            filename: select.value,
                            description: select.options[select.selectedIndex].dataset.description
                        };
                    });
                    return selection;
                };

                const constructCustomCharacter = () => {
                    const selection = getSelection();
                    const parts = [];

                    // Head + Hat/Headgear layer
                    if (selection.head) {
                        const role = selection.head.headRole || 'standard';
                        const needsOffset = role === 'character' || role === 'animal';
                        const dy = needsOffset ? 20 : 0;
                        parts.push({ label: 'HEAD', filename: selection.head.filename, description: selection.head.description, dy });
                        if (selection.hat) {
                            parts.push({ label: 'HEADGEAR', filename: selection.hat.filename, description: selection.hat.description, dy });
                        }
                    } else if (selection.hat) {
                        // Some headdress parts are composite "Minifig Head ..." pieces
                        // that already include the underlying head. Detect those by
                        // description and treat them as full HEADs instead of pure
                        // HEADGEAR so composition stays smart.
                        const desc = (selection.hat.description || selection.hat.name || '').toLowerCase();
                        const compositeHead = /^minifig (baby )?head\b/.test(desc);
                        if (compositeHead) {
                            const role = selection.hat.headRole || 'standard';
                            const needsOffset = role === 'character' || role === 'animal';
                            const dy = needsOffset ? 20 : 0;
                            parts.push({ label: 'HEAD', filename: selection.hat.filename, description: selection.hat.description, dy });
                        } else {
                            parts.push({ label: 'HEADGEAR', filename: selection.hat.filename, description: selection.hat.description });
                        }
                    }

                    const torsoHasUpper = selection.torso && (selection.torso.upperComplete || selection.torso.includesArms || selection.torso.includesHands);
                    if (selection.torso) {
                        parts.push({ label: 'TORSO', filename: selection.torso.filename, description: selection.torso.description });
                    }
                    if (selection.arms && !torsoHasUpper) {
                        parts.push({ label: 'LEFT ARM', filename: selection.arms.filename, description: selection.arms.description });
                        parts.push({ label: 'RIGHT ARM', filename: selection.arms.filename, description: selection.arms.description });
                    }

                    const hipsHasLegs = selection.hips && (selection.hips.lowerComplete || selection.hips.includesLegs);
                    const legsHasHips = selection.legs && (selection.legs.lowerComplete || selection.legs.includesHips);

                    if (selection.hips && !legsHasHips) {
                        parts.push({ label: 'HIPS', filename: selection.hips.filename, description: selection.hips.description });
                    }
                    if (selection.legs && !hipsHasLegs) {
                        parts.push({ label: 'LEFT LEG', filename: selection.legs.filename, description: selection.legs.description });
                        parts.push({ label: 'RIGHT LEG', filename: selection.legs.filename, description: selection.legs.description });
                    }
                    return {
                        id: `custom-minifig-${Date.now()}`,
                        title: 'Custom Minifig',
                        parts
                    };
                };

                renderCurrentBuild = () => {
                    const selection = getSelection();
                    const summaryEl = builder.querySelector('#minifig-builder-summary');
                    if (!summaryEl) return;

                    const rows = [];
                    if (selection.hat) rows.push(`<tr><td style="padding:2px 4px;">HAT / HEADGEAR</td><td style="padding:2px 4px;">${selection.hat.filename}</td><td style="padding:2px 4px;">${selection.hat.description || ''}</td></tr>`);
                    if (selection.head) rows.push(`<tr><td style="padding:2px 4px;">HEAD</td><td style="padding:2px 4px;">${selection.head.filename}</td><td style="padding:2px 4px;">${selection.head.description || ''}</td></tr>`);
                    if (selection.torso) rows.push(`<tr><td style="padding:2px 4px;">TORSO</td><td style="padding:2px 4px;">${selection.torso.filename}</td><td style="padding:2px 4px;">${selection.torso.description || ''}</td></tr>`);
                    if (selection.arms) rows.push(`<tr><td style="padding:2px 4px;">ARMS</td><td style="padding:2px 4px;">${selection.arms.filename}</td><td style="padding:2px 4px;">${selection.arms.description || ''}</td></tr>`);
                    if (selection.hips) rows.push(`<tr><td style="padding:2px 4px;">HIPS</td><td style="padding:2px 4px;">${selection.hips.filename}</td><td style="padding:2px 4px;">${selection.hips.description || ''}</td></tr>`);
                    if (selection.legs) rows.push(`<tr><td style="padding:2px 4px;">LEGS</td><td style="padding:2px 4px;">${selection.legs.filename}</td><td style="padding:2px 4px;">${selection.legs.description || ''}</td></tr>`);

                    if (!rows.length) {
                        summaryEl.textContent = 'No parts selected.';
                    } else {
                        summaryEl.innerHTML = `<table style="width:100%; border-collapse:collapse;"><tbody>${rows.join('')}</tbody></table>`;
                    }
                };

                // Wire up interlocks + summary updates whenever a dropdown changes.
                selects.forEach((select) => {
                    select.addEventListener('change', () => {
                        applyInterlocks();
                        if (renderCurrentBuild) renderCurrentBuild();
                    });
                });

                const handleCustom = (replace) => {
                    const character = constructCustomCharacter();
                    if (!character.parts.length) {
                        alert('Select at least one minifig part to build.');
                        return;
                    }
                    const lines = buildMinifigLines(character);
                    loadMinifig(lines, character.title, replace);
                };

                actions.querySelector('#minifig-builder-load').addEventListener('click', () => handleCustom(true));
                actions.querySelector('#minifig-builder-add').addEventListener('click', () => handleCustom(false));

                return builder;
            }

            function showMinifigMode() {
                leftPanel.innerHTML = `
                    <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 13px; border-bottom: 2px solid var(--border-primary); padding-bottom: 8px;">
                        üë§ MINIFIG MODE
                    </div>
                    <div style="font-size: 11px; color: #aaa; line-height: 1.6;">
                        Pick a head from the gallery to auto-assemble a complete minifig body using safe default parts.
                    </div>
                `;

                rightPanel.innerHTML = '';

                if (!minifigLibrary || !minifigLibrary.parts || !minifigLibrary.parts.heads || !minifigLibrary.parts.heads.length) {
                    rightPanel.innerHTML = '<div style="color: #888; text-align: center; padding: 40px;">Run <code>node build-minifig-library.js</code> to generate the minifig library.</div>';
                    return;
                }

                const headsAll = minifigLibrary.parts.heads || [];
                const viableHeads = headsAll.filter((h) => h.viableStandardHead && h.canonicalHead && h.primary !== false && h.isHalf !== true);
                let showAllHeads = false;

                const header = document.createElement('div');
                header.style.cssText = 'margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center;';
                header.innerHTML = `
                    <div>
                        <div style="color: var(--accent); font-weight: 700; font-size: 14px;">Head Gallery</div>
                        <div id="minifig-head-count" style="font-size: 11px; color: #888;"></div>
                    </div>
                    <div>
                        <button id="minifig-head-toggle" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-primary); background: var(--bg-main); color: var(--text-primary); font-size: 10px; cursor: pointer;">Show all heads</button>
                    </div>
                `;
                rightPanel.appendChild(header);

                const gallery = document.createElement('div');
                gallery.style.cssText = 'display: flex; overflow-x: auto; gap: 8px; padding: 4px 0 8px;';
                rightPanel.appendChild(gallery);

                const headCountEl = header.querySelector('#minifig-head-count');
                const toggleBtn = header.querySelector('#minifig-head-toggle');

                const updateToggleLabel = () => {
                    if (!toggleBtn) return;
                    toggleBtn.textContent = showAllHeads ? 'Show viable only' : 'Show all heads';
                };

                const renderHeadGallery = () => {
                    const base = (showAllHeads || !viableHeads.length) ? headsAll : viableHeads;
                    const heads = base
                        .filter((h) => {
                            // Never show artifact-role parts (pencil tops, biscuits,
                            // shields, book covers, etc.) in the head gallery, even
                            // if they contain the phrase "Minifig Head" in their
                            // description.
                            if (h.headRole === 'artifact') return false;
                            const text = (h.description || h.name || '');
                            return h.canonicalHead || /minifig head/i.test(text);
                        })
                        .slice(0, 120);

                    gallery.innerHTML = '';

                    if (headCountEl) {
                        const viableCount = viableHeads.length;
                        const totalCount = headsAll.length;
                        if (viableCount && !showAllHeads) {
                            headCountEl.textContent = `${heads.length} viable heads shown (of ${viableCount} viable, ${totalCount} total)`;
                        } else {
                            headCountEl.textContent = `${heads.length} heads shown (of ${totalCount} total)`;
                        }
                    }

                    if (!heads.length) {
                        const empty = document.createElement('div');
                        empty.style.cssText = 'color: #888; text-align: center; padding: 24px;';
                        empty.textContent = 'No minifig heads detected yet. Try regenerating the library.';
                        gallery.appendChild(empty);
                        return;
                    }

                    heads.forEach((head) => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            min-width: 160px;
                            max-width: 200px;
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-primary);
                            border-radius: 6px;
                            padding: 8px;
                            display: flex;
                            flex-direction: column;
                            gap: 4px;
                            font-size: 10px;
                        `;
                        card.innerHTML = `
                            <div style="font-weight: 700; color: var(--accent); font-size: 11px;">${head.filename}</div>
                            <div style="color: #aaa; max-height: 48px; overflow: hidden;">${head.description || head.name || ''}</div>
                            <div class="minifig-head-meta" style="font-size: 9px; color: #888; margin-top: 2px;"></div>
                            <div style="display: flex; gap: 4px; margin-top: 4px;">
                                <button class="minifig-head-load" style="flex: 1; padding: 4px 6px; border-radius: 4px; border: 1px solid var(--accent); background: var(--bg-main); color: var(--accent); font-size: 10px; cursor: pointer;">üíö LOAD</button>
                                <button class="minifig-head-add" style="flex: 1; padding: 4px 6px; border-radius: 4px; border: 1px solid var(--accent); background: var(--accent); color: var(--bg-main); font-size: 10px; cursor: pointer;">‚ûï ADD</button>
                            </div>
                        `;

                        const meta = card.querySelector('.minifig-head-meta');
                        if (meta) {
                            const role = head.headRole || 'standard';
                            let roleText;
                            if (role === 'headdress') {
                                roleText = head.headgearType ? `headgear ¬∑ ${head.headgearType}` : 'headgear';
                            } else if (role === 'artifact') {
                                roleText = 'artifact / non-head';
                            } else if (role === 'standard') {
                                roleText = 'standard head';
                            } else {
                                roleText = role;
                            }
                            const tags = [];
                            if (head.viableStandardHead) tags.push('viable');
                            if (head.canonicalHead) tags.push('canonical');
                            if (head.isHalf) tags.push('half');
                            meta.textContent = `${roleText}${tags.length ? ' ¬∑ ' + tags.join(' ¬∑ ') : ''}`;
                        }

                        card.querySelector('.minifig-head-load').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const character = buildMinifigFromHeadPart(head);
                            const lines = buildMinifigLines(character);
                            loadMinifig(lines, character.title, true);
                        });

                        card.querySelector('.minifig-head-add').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const character = buildMinifigFromHeadPart(head);
                            const lines = buildMinifigLines(character);
                            loadMinifig(lines, character.title, false);
                        });

                        gallery.appendChild(card);
                    });
                };

                if (toggleBtn) {
                    updateToggleLabel();
                    toggleBtn.addEventListener('click', () => {
                        showAllHeads = !showAllHeads;
                        updateToggleLabel();
                        renderHeadGallery();
                    });
                }

                renderHeadGallery();

                // Attach the improved Custom Minifig Builder beneath the head gallery
                const masterBuilder = renderMinifigBuilder();
                if (masterBuilder) {
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'margin-top: 24px;';
                    wrapper.appendChild(masterBuilder);
                    rightPanel.appendChild(wrapper);
                }
            }

            // FOLK mode - TRACTOR FOLKOLOGICUS + Themes + Minifig Library
            function showFolkMode() {
                const ecologies = {
                    '1‚óØ CIRCLE': { parts: [], desc: 'Boundaries & Containers ¬∑ What defines Us vs Them', icon: '‚óØ' },
                    '2‚áÑ TRADE': { parts: [], desc: 'Movement & Exchange ¬∑ Vehicles that cross boundaries', icon: '‚áÑ' },
                    '3‚ô• HEART': { parts: [], desc: 'Life & Care ¬∑ Living things that need tending', icon: '‚ô•' },
                    '4‚öò SEED': { parts: [], desc: 'Foundation & Building ¬∑ Basic elements that grow', icon: '‚öò' },
                    '5‚ñ≥ CHOICE': { parts: [], desc: 'Connection & Articulation ¬∑ Joints between gestures', icon: '‚ñ≥' },
                    '6‚óà PATTERN': { parts: [], desc: 'Order & Decoration ¬∑ The unseen structure', icon: '‚óà' },
                    '7‚àÖ ZERO': { parts: [], desc: 'Mechanism & Unseen ¬∑ Technical truth beneath', icon: '‚àÖ' }
                };
                
                // Classify parts into TRACTOR FOLKOLOGICUS modules
                Object.values(taxonomy.kingdoms).forEach(kingdomData => {
                    Object.values(kingdomData.phyla).forEach(phylumData => {
                        Object.values(phylumData.classes).forEach(classData => {
                            Object.values(classData.orders).forEach(orderData => {
                                Object.values(orderData.families).forEach(familyData => {
                                    familyData.parts.forEach(part => {
                                        const text = `${part.description} ${part.name}`.toLowerCase();
                                        
                                        // 1. CIRCLE - Boundaries, structures, containers
                                        if (text.match(/baseplate|wall|fence|gate|door|window|panel|container|box|border|frame/i)) {
                                            ecologies['1‚óØ CIRCLE'].parts.push(part);
                                        }
                                        // 2. TRADE - Movement, vehicles, transportation
                                        else if (text.match(/wheel|tire|car|truck|boat|ship|train|vehicle|propeller|wing|engine/i)) {
                                            ecologies['2‚áÑ TRADE'].parts.push(part);
                                        }
                                        // 3. HEART - Life, minifigs, living things
                                        else if (text.match(/minifig|head|torso|leg|arm|animal|plant|tree|flower|face/i)) {
                                            ecologies['3‚ô• HEART'].parts.push(part);
                                        }
                                        // 4. SEED - Foundation, basic building blocks
                                        else if (text.match(/brick|plate|tile|slope|wedge|cylinder|cone/i)) {
                                            ecologies['4‚öò SEED'].parts.push(part);
                                        }
                                        // 5. CHOICE - Connectors, hinges, articulation
                                        else if (text.match(/hinge|axle|connector|joint|turntable|ball|socket|pin|clip/i)) {
                                            ecologies['5‚ñ≥ CHOICE'].parts.push(part);
                                        }
                                        // 6. PATTERN - Decorative, printed, stickers
                                        else if (text.match(/sticker|print|pattern|decorated|emblem|logo|flag|sign/i)) {
                                            ecologies['6‚óà PATTERN'].parts.push(part);
                                        }
                                        // 7. ZERO - Technical, electric, mechanisms
                                        else if (text.match(/technic|electric|motor|sensor|gear|chain|cable|magnet|rotor/i)) {
                                            ecologies['7‚àÖ ZERO'].parts.push(part);
                                        }
                                        // Default to SEED if unclear
                                        else {
                                            ecologies['4‚öò SEED'].parts.push(part);
                                        }
                                    });
                                });
                            });
                        });
                    });
                });
                
                // Also collect theme-based ecologies
                const themes = {
                    '‚öîÔ∏è Star Wars': [],
                    'üè∞ Castle': [],
                    'üöÄ Space': [],
                    'üèôÔ∏è City': [],
                    'üè¥‚Äç‚ò†Ô∏è Pirates': [],
                    'üöÇ Train': [],
                    'ü§ñ Bionicle': [],
                    '‚ö° Harry Potter': [],
                    '‚öôÔ∏è Technic': []
                };
                
                Object.values(taxonomy.kingdoms).forEach(kingdomData => {
                    Object.values(kingdomData.phyla).forEach(phylumData => {
                        Object.values(phylumData.classes).forEach(classData => {
                            Object.values(classData.orders).forEach(orderData => {
                                Object.values(orderData.families).forEach(familyData => {
                                    familyData.parts.forEach(part => {
                                        const text = `${part.description} ${part.name}`.toLowerCase();
                                        
                                        // Theme detection
                                        if (text.match(/star wars|sw|r2-d2|c-3po|vader|stormtrooper|x-wing|death star/i)) {
                                            themes['‚öîÔ∏è Star Wars'].push(part);
                                        }
                                        if (text.match(/castle|knight|dragon|medieval|sword|shield|horse|crown/i)) {
                                            themes['üè∞ Castle'].push(part);
                                        }
                                        if (text.match(/space|rocket|astronaut|satellite|moon/i)) {
                                            themes['üöÄ Space'].push(part);
                                        }
                                        if (text.match(/city|police|fire|car|truck|building|road/i)) {
                                            themes['üèôÔ∏è City'].push(part);
                                        }
                                        if (text.match(/pirate|ship|treasure|skull|cannon/i)) {
                                            themes['üè¥‚Äç‚ò†Ô∏è Pirates'].push(part);
                                        }
                                        if (text.match(/train|railway|track|locomotive|wagon/i)) {
                                            themes['üöÇ Train'].push(part);
                                        }
                                        if (text.match(/bionicle|toa|mata/i)) {
                                            themes['ü§ñ Bionicle'].push(part);
                                        }
                                        if (text.match(/harry potter|hogwarts|wizard/i)) {
                                            themes['‚ö° Harry Potter'].push(part);
                                        }
                                        if (text.match(/technic/i)) {
                                            themes['‚öôÔ∏è Technic'].push(part);
                                        }
                                    });
                                });
                            });
                        });
                    });
                });
                
                // Show folk categories in left panel
                leftPanel.innerHTML = `
                    <div style="color: var(--accent); font-weight: 700; margin-bottom: 16px; font-size: 14px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">
                        FOLK CATEGORIES<br>
                        <span style="font-size: 11px; font-weight: 400; color: #aaa;">Two ways to organize</span>
                    </div>
                `;
                
                // Add PLAN section
                const planSection = document.createElement('div');
                planSection.style.cssText = 'margin-bottom: 24px;';
                planSection.innerHTML = `
                    <div style="color: var(--text-primary); font-weight: 700; font-size: 12px; margin-bottom: 8px; padding: 8px; background: var(--bg-main); border-radius: 4px;">
                        PLAN v1.1 ¬∑ TRACTOR FOLKOLOGICUS
                    </div>
                `;
                leftPanel.appendChild(planSection);
                
                Object.entries(ecologies).forEach(([moduleName, moduleData]) => {
                    const btn = document.createElement('button');
                    btn.style.cssText = `
                        width: 100%;
                        padding: 10px;
                        margin-bottom: 6px;
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-primary);
                        border-radius: 4px;
                        cursor: pointer;
                        text-align: left;
                        color: var(--text-primary);
                        transition: all 0.2s;
                    `;
                    btn.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-size: 14px;">${moduleData.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--accent); font-size: 11px;">${moduleName}</div>
                                <div style="font-size: 9px; color: #666;">${moduleData.parts.length.toLocaleString()} parts</div>
                            </div>
                            <div style="color: var(--accent);">‚ñ∂</div>
                        </div>
                    `;
                    btn.addEventListener('mouseenter', () => btn.style.background = 'var(--accent)');
                    btn.addEventListener('mouseleave', () => btn.style.background = 'var(--bg-secondary)');
                    btn.addEventListener('click', () => {
                        showNestedView(moduleName, moduleData.parts, moduleData.desc);
                    });
                    leftPanel.appendChild(btn);
                });
                
                // Add Ecology/Themes section
                const themesSection = document.createElement('div');
                themesSection.style.cssText = 'margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-primary);';
                themesSection.innerHTML = `
                    <div style="color: var(--text-primary); font-weight: 700; font-size: 12px; margin-bottom: 8px; padding: 8px; background: var(--bg-main); border-radius: 4px;">
                        üåç ECOLOGY ¬∑ Themes by Setting
                    </div>
                `;
                leftPanel.appendChild(themesSection);
                
                Object.entries(themes).filter(([_, parts]) => parts.length > 0).forEach(([themeName, themeParts]) => {
                    const btn = document.createElement('button');
                    btn.style.cssText = `
                        width: 100%;
                        padding: 10px;
                        margin-bottom: 6px;
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-primary);
                        border-radius: 4px;
                        cursor: pointer;
                        text-align: left;
                        color: var(--text-primary);
                        transition: all 0.2s;
                    `;
                    btn.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--accent); font-size: 11px;">${themeName}</div>
                                <div style="font-size: 9px; color: #666;">${themeParts.length.toLocaleString()} parts</div>
                            </div>
                            <div style="color: var(--accent);">‚ñ∂</div>
                        </div>
                    `;
                    btn.addEventListener('mouseenter', () => btn.style.background = 'var(--accent)');
                    btn.addEventListener('mouseleave', () => btn.style.background = 'var(--bg-secondary)');
                    btn.addEventListener('click', () => {
                        showNestedView(themeName, themeParts, `Parts from the ${themeName} theme`);
                    });
                    leftPanel.appendChild(btn);
                });
                
                // Minifig library section
                if (minifigLibrary) {
                    const minifigSection = document.createElement('div');
                    minifigSection.style.cssText = 'margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-primary);';
                    minifigSection.innerHTML = `
                        <div style="color: var(--text-primary); font-weight: 700; font-size: 12px; margin-bottom: 8px; padding: 8px; background: var(--bg-main); border-radius: 4px; display: flex; justify-content: space-between;">
                            <span>üë§ MINIFIG LIBRARY ¬∑ Fully Assembled Characters</span>
                            <span style="font-size: 10px; color: #aaa;">${minifigLibrary.stats.curatedCount} curated ¬∑ ${minifigLibrary.stats.partBuckets.heads} heads</span>
                        </div>
                    `;

                    const curatedList = document.createElement('div');
                    curatedList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
                    (minifigLibrary.curated || []).forEach((character) => {
                        const entryBtn = document.createElement('button');
                        entryBtn.style.cssText = `
                            width: 100%;
                            padding: 10px;
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-primary);
                            border-radius: 4px;
                            cursor: pointer;
                            text-align: left;
                            color: var(--text-primary);
                            transition: all 0.2s;
                        `;
                        entryBtn.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 700; color: var(--accent); font-size: 12px;">${character.title}</div>
                                    <div style="font-size: 10px; color: #888;">${character.personality || ''}</div>
                                </div>
                                <div style="color: var(--accent); font-size: 12px;">VIEW ‚Üí</div>
                            </div>
                        `;
                        entryBtn.addEventListener('mouseenter', () => entryBtn.style.background = 'var(--accent)');
                        entryBtn.addEventListener('mouseleave', () => entryBtn.style.background = 'var(--bg-secondary)');
                        entryBtn.addEventListener('click', () => showMinifigDetail(character));
                        curatedList.appendChild(entryBtn);
                    });
                    minifigSection.appendChild(curatedList);

                    const builder = renderMinifigBuilder();
                    if (builder) {
                        minifigSection.appendChild(builder);
                    }

                    leftPanel.appendChild(minifigSection);
                }

                // Nested view function - shows subcategories
                function showNestedView(categoryName, parts, description) {
                    // Group parts by kingdom for nested organization
                    const subcategories = {};
                    parts.forEach(part => {
                        const kingdom = extractKingdom(part.description, part.name);
                        if (!subcategories[kingdom]) subcategories[kingdom] = [];
                        subcategories[kingdom].push(part);
                    });
                    
                    rightPanel.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--accent);">
                            <div>
                                <div style="color: var(--accent); font-weight: 700; font-size: 16px;">${categoryName}</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">${description}</div>
                            </div>
                            <button id="back-to-folk" style="
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-primary);
                                color: var(--text-primary);
                                padding: 6px 12px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                            ">‚Üê BACK</button>
                        </div>
                        <div style="color: var(--text-primary); font-size: 11px; font-weight: 600; margin-bottom: 12px;">
                            ${parts.length.toLocaleString()} parts organized into ${Object.keys(subcategories).length} subcategories
                        </div>
                    `;
                    
                    // Back button
                    setTimeout(() => {
                        document.getElementById('back-to-folk').addEventListener('click', showFolkMode);
                    }, 0);
                    
                    // Show subcategories
                    Object.entries(subcategories).sort((a, b) => b[1].length - a[1].length).forEach(([subcat, subparts]) => {
                        const subcatDiv = document.createElement('div');
                        subcatDiv.style.cssText = `
                            padding: 12px;
                            margin-bottom: 8px;
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-primary);
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        `;
                        subcatDiv.innerHTML = `
                            <div>
                                <div style="font-weight: 700; color: var(--accent); font-size: 13px;">${subcat}</div>
                                <div style="font-size: 10px; color: #888; margin-top: 2px;">${subparts.length} parts</div>
                            </div>
                            <div style="color: var(--accent); font-size: 12px;">VIEW ‚Üí</div>
                        `;
                        subcatDiv.addEventListener('mouseenter', () => subcatDiv.style.background = 'var(--accent)');
                        subcatDiv.addEventListener('mouseleave', () => subcatDiv.style.background = 'var(--bg-secondary)');
                        subcatDiv.addEventListener('click', () => {
                            showPaginatedParts(subparts, `${categoryName} ‚Üí ${subcat}`, rightPanel);
                        });
                        rightPanel.appendChild(subcatDiv);
                    });
                }
                
                // Helper to extract kingdom
                function extractKingdom(desc, name) {
                    const text = (desc || name || '').toLowerCase();
                    if (text.includes('minifig')) return 'MINIFIG';
                    if (text.includes('brick')) return 'BRICK';
                    if (text.includes('plate')) return 'PLATE';
                    if (text.includes('tile')) return 'TILE';
                    if (text.includes('slope')) return 'SLOPE';
                    if (text.includes('wheel') || text.includes('tire')) return 'WHEEL';
                    if (text.includes('window')) return 'WINDOW';
                    if (text.includes('door')) return 'DOOR';
                    if (text.includes('technic')) return 'TECHNIC';
                    if (text.includes('panel')) return 'PANEL';
                    return 'OTHER';
                }
                
                rightPanel.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: #aaa;">
                        <div style="font-size: 36px; margin-bottom: 16px;">üåæ</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 12px;">
                            Folk Categories
                        </div>
                        <div style="font-size: 12px; line-height: 1.8; max-width: 400px; margin: 0 auto;">
                            Two ways to organize the same parts:<br><br>
                            <strong style="color: var(--text-primary);">PLAN v1.1</strong><br>
                            Parts by their <em>role</em> in the system<br>
                            (Circle, Trade, Heart, Seed...)<br><br>
                            <strong style="color: var(--text-primary);">üåç ECOLOGY</strong><br>
                            Parts by their <em>theme</em> or setting<br>
                            (Star Wars, Castle, Space...)<br><br>
                            <strong style="color: var(--text-primary);">üë§ MINIFIG LIBRARY</strong><br>
                            Fully assembled characters + custom builder<br>
                            (Drag archetypes or assemble your own)<br><br>
                            Click any category to explore nested subcategories ‚Üí
                        </div>
                    </div>
                `;
            }
            
            // Mode switching
            content.querySelector('#mode-taxonomy-btn').addEventListener('click', () => {
                currentCatalogMode = 'taxonomy';
                content.querySelector('#mode-taxonomy-btn').style.background = 'var(--accent)';
                content.querySelector('#mode-taxonomy-btn').style.color = 'var(--bg-main)';
                content.querySelector('#mode-folk-btn').style.background = 'var(--bg-secondary)';
                content.querySelector('#mode-folk-btn').style.border = '1px solid var(--border-primary)';
                content.querySelector('#mode-folk-btn').style.color = 'var(--text-primary)';
                const minifigBtn = content.querySelector('#mode-minifig-btn');
                if (minifigBtn) {
                    minifigBtn.style.background = 'var(--bg-secondary)';
                    minifigBtn.style.border = '1px solid var(--border-primary)';
                    minifigBtn.style.color = 'var(--text-primary)';
                }
                
                // Restore taxonomy view
                leftPanel.innerHTML = '';
                const kingdomsList = document.createElement('div');
                kingdomsList.innerHTML = '<div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 13px;">KINGDOMS (Part Families)</div>';
                
                Object.entries(taxonomy.kingdoms).sort((a, b) => b[1].count - a[1].count).forEach(([kingdom, data]) => {
                    const btn = document.createElement('button');
                    btn.style.cssText = `
                        width: 100%;
                        padding: 10px;
                        margin-bottom: 6px;
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-primary);
                        border-radius: 4px;
                        cursor: pointer;
                        text-align: left;
                        color: var(--text-primary);
                        transition: all 0.2s;
                    `;
                    btn.innerHTML = `
                        <div style="font-weight: 700; color: var(--accent);">${kingdom}</div>
                        <div style="font-size: 11px; color: #888;">${data.count} parts in ${Object.keys(data.phyla).length} groups</div>
                    `;
                    btn.addEventListener('mouseenter', () => btn.style.background = 'var(--accent)');
                    btn.addEventListener('mouseleave', () => btn.style.background = 'var(--bg-secondary)');
                    btn.addEventListener('click', () => showPhyla(kingdom, data));
                    kingdomsList.appendChild(btn);
                });
                
                leftPanel.appendChild(kingdomsList);
                rightPanel.innerHTML = `
                    <div style="color: #aaa; text-align: center; padding: 40px;">
                        Select a kingdom to explore parts ‚Üí
                    </div>
                `;
            });
            
            content.querySelector('#mode-folk-btn').addEventListener('click', () => {
                currentCatalogMode = 'folk';
                content.querySelector('#mode-folk-btn').style.background = 'var(--accent)';
                content.querySelector('#mode-folk-btn').style.color = 'var(--bg-main)';
                content.querySelector('#mode-taxonomy-btn').style.background = 'var(--bg-secondary)';
                content.querySelector('#mode-taxonomy-btn').style.border = '1px solid var(--border-primary)';
                content.querySelector('#mode-taxonomy-btn').style.color = 'var(--text-primary)';
                
                showFolkMode();
            });
            
            const minifigModeBtn = content.querySelector('#mode-minifig-btn');
            if (minifigModeBtn) {
                minifigModeBtn.addEventListener('click', () => {
                    currentCatalogMode = 'minifig';
                    minifigModeBtn.style.background = 'var(--accent)';
                    minifigModeBtn.style.color = 'var(--bg-main)';
                    content.querySelector('#mode-taxonomy-btn').style.background = 'var(--bg-secondary)';
                    content.querySelector('#mode-taxonomy-btn').style.border = '1px solid var(--border-primary)';
                    content.querySelector('#mode-taxonomy-btn').style.color = 'var(--text-primary)';
                    content.querySelector('#mode-folk-btn').style.background = 'var(--bg-secondary)';
                    content.querySelector('#mode-folk-btn').style.border = '1px solid var(--border-primary)';
                    content.querySelector('#mode-folk-btn').style.color = 'var(--text-primary)';

                    showMinifigMode();
                });
            }

            const locationModeBtn = content.querySelector('#mode-location-btn');
            if (locationModeBtn) {
                locationModeBtn.addEventListener('click', () => {
                    currentCatalogMode = 'location';
                    locationModeBtn.style.background = 'var(--accent)';
                    locationModeBtn.style.color = 'var(--bg-main)';
                    content.querySelector('#mode-taxonomy-btn').style.background = 'var(--bg-secondary)';
                    content.querySelector('#mode-taxonomy-btn').style.border = '1px solid var(--border-primary)';
                    content.querySelector('#mode-taxonomy-btn').style.color = 'var(--text-primary)';
                    content.querySelector('#mode-folk-btn').style.background = 'var(--bg-secondary)';
                    content.querySelector('#mode-folk-btn').style.border = '1px solid var(--border-primary)';
                    content.querySelector('#mode-folk-btn').style.color = 'var(--text-primary)';
                    if (minifigModeBtn) {
                        minifigModeBtn.style.background = 'var(--bg-secondary)';
                        minifigModeBtn.style.border = '1px solid var(--border-primary)';
                        minifigModeBtn.style.color = 'var(--text-primary)';
                    }

                    showLocationMode();
                });
            }
            
            // Close button
            content.querySelector('#close-catalog').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // ESC to close
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                }
            });
            
            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // Focus search box
            setTimeout(() => searchBox.focus(), 100);
        }
        
        // Minimap toggle
        const minimapToggle = document.getElementById('minimap-toggle');
        const minimap = document.getElementById('minimap');
        if (minimapToggle && minimap) {
            minimapToggle.addEventListener('click', () => {
                const isVisible = minimap.style.display !== 'none';
                minimap.style.display = isVisible ? 'none' : 'block';
                minimapToggle.classList.toggle('active', !isVisible);
            });
        }
        
        // 3D/2D mode toggle
        document.getElementById('mode-3d-tab').addEventListener('click', () => {
            document.getElementById('viewer').style.display = 'block';
            document.getElementById('grid-2d').style.display = 'none';
            document.getElementById('mode-3d-tab').classList.add('active');
            document.getElementById('mode-2d-tab').classList.remove('active');
            
            // Force render after switching back to 3D
            if (STATE.viewer && STATE.viewer.render) {
                setTimeout(() => {
                    STATE.viewer.render();
                    console.log('[3D MODE] Render triggered after display');
                }, 50);
            }
        });
        
        document.getElementById('mode-2d-tab').addEventListener('click', () => {
            const viewer = document.getElementById('viewer');
            const grid2d = document.getElementById('grid-2d');
            const mode3d = document.getElementById('mode-3d-tab');
            const mode2d = document.getElementById('mode-2d-tab');
            
            if (viewer) viewer.style.display = 'none';
            if (grid2d) grid2d.style.display = 'grid';
            if (mode3d) mode3d.classList.remove('active');
            if (mode2d) mode2d.classList.add('active');
            render2DGrid();
        });

        if (STATE.viewer) {
            STATE.viewer.setDiagnostics(STATE.diagnostics);
            STATE.viewer.setAutoSpin(STATE.autoSpin);
        }

        setupPanelButtons();
        // Scene management moved to scene dots - dropdown is for loading MPD files
        setupPasteZone();
    }
    
    function setupPasteZone() {
        const pasteZone = document.getElementById('paste-zone');
        const pasteTextarea = document.getElementById('paste-textarea');
        const pasteLoadBtn = document.getElementById('paste-load-btn');
        const pasteCancelBtn = document.getElementById('paste-cancel-btn');
        
        function showPasteZone() {
            pasteZone.classList.add('active');
            pasteTextarea.value = '';
            setTimeout(() => pasteTextarea.focus(), 100);
        }
        
        function hidePasteZone() {
            pasteZone.classList.remove('active');
        }
        
        // Load button - ELEGANT! Just create new file from scratch
        pasteLoadBtn.addEventListener('click', () => {
            const text = pasteTextarea.value.trim();
            if (!text) return;
            
            // Parse to lines
            const lines = text.split(/\r?\n|\r/);
            
            // Replace entire editor with pasted content
            editorLines.length = 0;
            editorLines.push(...lines);
            
            STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
            renderEditor(editorLines);
            hidePasteZone();
            
            console.log(`üíö Grace: Created new file with ${lines.length} lines from paste`);
            document.getElementById('status-text').textContent = `üíö New file: ${lines.length} lines loaded`;
            
            // Auto-compile if it looks like MPD
            if (text.includes('0 FILE') || text.includes('parts/')) {
                setTimeout(() => compile(), 500);
            }
        });
        
        // Cancel button
        pasteCancelBtn.addEventListener('click', hidePasteZone);
        
        // ESC to close
        pasteTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hidePasteZone();
            }
        });
        
        // Global paste handler (Ctrl+V anywhere)
        document.addEventListener('paste', (e) => {
            // If pasting in line content, let it handle naturally
            if (e.target.classList.contains('line-content')) return;
            
            // If pasting in paste zone, let it happen
            if (e.target.id === 'paste-textarea') return;
            
            // Otherwise, show paste zone
            e.preventDefault();
            showPasteZone();
            
            // Get clipboard data and put in textarea
            const text = e.clipboardData.getData('text/plain');
            if (text) {
                pasteTextarea.value = text;
            }
        });
        
        // Global keyboard shortcut Ctrl+V
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'v') {
                // If already focused in line editor, let it handle
                if (e.target.classList.contains('line-content')) return;
                if (e.target.id === 'paste-textarea') return;
                
                // Otherwise show paste zone
                e.preventDefault();
                showPasteZone();
            }
        });
    }

document.getElementById('mode-2d-tab').addEventListener('click', () => {
    const viewer = document.getElementById('viewer');
    const grid2d = document.getElementById('grid-2d');
    const mode3d = document.getElementById('mode-3d-tab');
    const mode2d = document.getElementById('mode-2d-tab');
    
    if (viewer) viewer.style.display = 'none';
    if (grid2d) grid2d.style.display = 'grid';
    if (mode3d) mode3d.classList.remove('active');
    if (mode2d) mode2d.classList.add('active');
    render2DGrid();
});

if (STATE.viewer) {
    STATE.viewer.setDiagnostics(STATE.diagnostics);
    STATE.viewer.setAutoSpin(STATE.autoSpin);
}

setupPanelButtons();
// Scene management moved to scene dots - dropdown is for loading MPD files
setupPasteZone();

const FRANK_GRID_CONFIG = {
    lduPerStud: 20,
    cellSizeLDU: 160,   // 8 studs per Frank cell
    halfCells: 4        // 9√ó9 grid ‚Üí offsets -4..4 around center
};

function initializeGrids() {
    // Initialize 2D grid as a 9√ó9 FRANK-aligned grid (one cell per Frank cell)
    const grid2d = document.getElementById('grid-2d');
    if (grid2d) {
        grid2d.innerHTML = '';
        grid2d.style.cssText = `
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 3px;
            background: var(--bg-main);
            width: 100%;
            height: 100%;
            padding: 12px;
            box-sizing: border-box;
        `;

        // Frank cell offsets from center: -4..4 (matching wag-frank 9√ó9 layout)
        for (let rowOffset = -FRANK_GRID_CONFIG.halfCells; rowOffset <= FRANK_GRID_CONFIG.halfCells; rowOffset++) {
            for (let colOffset = -FRANK_GRID_CONFIG.halfCells; colOffset <= FRANK_GRID_CONFIG.halfCells; colOffset++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.gridX = String(colOffset);   // Frank col offset
                cell.dataset.gridY = String(rowOffset);   // Frank row offset

                // Map offsets to Frank-style labels (A1‚ÄìI9)
                const rowIndex = rowOffset + FRANK_GRID_CONFIG.halfCells; // -4..4 ‚Üí 0..8
                const colIndex = colOffset + FRANK_GRID_CONFIG.halfCells; // -4..4 ‚Üí 0..8
                const rowLetter = String.fromCharCode(65 + rowIndex);     // 65 = 'A'
                const colNumber = colIndex + 1;
                const label = `${rowLetter}${colNumber}`;
                cell.dataset.label = label;
                cell.title = `FRANK cell ${label} (Œîx=${colOffset}, Œîz=${rowOffset})`;
                cell.style.cssText = `
                    background: var(--bg-main);
                    border: 1px solid var(--border-primary);
                    cursor: pointer;
                `;

                // Mark top-left Frank cell with a corner indicator for orientation
                if (rowOffset === -FRANK_GRID_CONFIG.halfCells && colOffset === -FRANK_GRID_CONFIG.halfCells) {
                    cell.classList.add('corner-marker');
                }
                cell.addEventListener('click', () => highlightLinesAtGridPosition(colOffset, rowOffset));
                grid2d.appendChild(cell);
            }
        }
    }

    // Initialize 9√ó9 minimap cells (one per Frank cell)
    const minimapGrid = document.getElementById('minimap-grid');
    if (minimapGrid) {
        minimapGrid.innerHTML = '';
        for (let rowIndex = 0; rowIndex < 9; rowIndex++) {
            for (let colIndex = 0; colIndex < 9; colIndex++) {
                const cell = document.createElement('div');
                cell.className = 'minimap-cell';

                const rowOffset = rowIndex - FRANK_GRID_CONFIG.halfCells; // -4..4
                const colOffset = colIndex - FRANK_GRID_CONFIG.halfCells; // -4..4
                cell.dataset.gridX = String(colOffset);
                cell.dataset.gridY = String(rowOffset);

                // Mark top-left Frank cell on minimap for orientation
                if (rowOffset === -FRANK_GRID_CONFIG.halfCells && colOffset === -FRANK_GRID_CONFIG.halfCells) {
                    cell.classList.add('corner-marker');
                }

                minimapGrid.appendChild(cell);
            }
        }
    }
}

// LDraw color code to CSS color mapping
function getLDrawColor(colorCode) {
    const colors = {
        '0': '#05131D',      // Black
        '1': '#0055BF',      // Blue
        '2': '#237841',      // Green
        '3': '#008F9B',      // Dark Cyan
        '4': '#C91A09',      // Red
        '5': '#C870A0',      // Pink
        '6': '#583927',      // Brown
        '7': '#9BA19D',      // Light Gray
        '8': '#6D6E5C',      // Dark Gray
        '9': '#B4D2E3',      // Light Blue
        '10': '#4B9F4A',     // Bright Green
        '11': '#55A5AF',     // Cyan
        '12': '#D67240',     // Light Orange
        '13': '#F58624',     // Bright Orange
        '14': '#F3CF50',     // Yellow
        '15': '#FFFFFF',     // White
        '16': '#7BB3D9',     // Default (Main Color)
        '17': '#C2DAB8',     // Trans Green
        '18': '#FCE639',     // Trans Yellow
        '19': '#E4ADC8',     // Trans Pink
        '20': '#C9CAE2',     // Trans Clear
        '21': '#E0C0A0',     // Chrome Gold
        '22': '#81007B',     // Purple
        '23': '#2032B0',     // Dark Blue
        '24': '#FE8E01',     // Trans Orange
        '25': '#D05098',     // Trans Magenta
        '71': '#A0A5A9',     // Light Stone Gray
        '72': '#6C6E68'      // Dark Stone Gray
    };

    // Return color or default cyan if not found
    return colors[colorCode] || '#2AC1FF';
}

function render2DGrid() {
    // Parse ALL editor lines and map them into Frank 9√ó9 cells (one bucket per Frank cell)
    const occupiedCells = new Map(); // key: "colOffset,rowOffset" -> { color, count }

    console.log('[2D GRID] Rendering from', editorLines.length, 'lines');

    editorLines.forEach((line, idx) => {
        const trimmed = line.trim();
        if (!trimmed.startsWith('1 ')) return;

        const tokens = trimmed.split(/\s+/);
        if (tokens.length < 15) return;

        try {
            const colorCode = tokens[1];
            const xLdu = parseFloat(tokens[2]);
            const zLdu = parseFloat(tokens[4]);
            if (Number.isNaN(xLdu) || Number.isNaN(zLdu)) return;

            // Map LDraw coordinates into Frank cell offsets (Œîx, Œîz) using 160 LDU spacing
            const colOffset = Math.round(xLdu / FRANK_GRID_CONFIG.cellSizeLDU);
            const rowOffset = Math.round(zLdu / FRANK_GRID_CONFIG.cellSizeLDU);

            // Clamp to visible 9√ó9 Frank grid (-4..4) so far-away parts don't break the view
            if (Math.abs(colOffset) > FRANK_GRID_CONFIG.halfCells || Math.abs(rowOffset) > FRANK_GRID_CONFIG.halfCells) {
                return;
            }

            const key = `${colOffset},${rowOffset}`;
            if (!occupiedCells.has(key)) {
                occupiedCells.set(key, { color: colorCode, count: 1 });
            } else {
                occupiedCells.get(key).count++;
            }
        } catch (e) {
            console.warn('[2D GRID] Parse error on line', idx, e);
        }
    });

    console.log('[2D GRID] Occupied Frank cells:', occupiedCells.size);

    // Update 9√ó9 grid cells
    const cells = document.querySelectorAll('.grid-cell');
    cells.forEach(cell => {
        const x = parseInt(cell.dataset.gridX, 10); // Frank col offset
        const y = parseInt(cell.dataset.gridY, 10); // Frank row offset
        const key = `${x},${y}`;

        if (occupiedCells.has(key)) {
            const data = occupiedCells.get(key);
            const color = getLDrawColor(data.color);
            cell.style.background = color;
            cell.style.border = `1px solid ${color}`;
            cell.classList.add('occupied');
            cell.textContent = data.count > 1 ? String(data.count) : '';
        } else {
            cell.style.background = '';
            cell.style.border = '1px solid var(--border-primary)';
            cell.classList.remove('occupied');
            cell.textContent = '';
        }
    });

    // Update minimap with Frank-aligned 2D grid data
    render2DMinimap(occupiedCells);
}

function render2DMinimap(occupiedCells) {
    const minimapGrid = document.getElementById('minimap-grid');
    if (!minimapGrid) return;

    const cells = minimapGrid.querySelectorAll('.minimap-cell');
    if (!cells.length) return;

    // 9√ó9 minimap, same Frank cell offsets (-4..4) as the main 2D grid
    cells.forEach((cell, idx) => {
        const rowIndex = Math.floor(idx / 9); // 0..8
        const colIndex = idx % 9;            // 0..8
        const rowOffset = rowIndex - FRANK_GRID_CONFIG.halfCells; // -4..4
        const colOffset = colIndex - FRANK_GRID_CONFIG.halfCells; // -4..4
        const key = `${colOffset},${rowOffset}`;

        if (occupiedCells.has(key)) {
            const data = occupiedCells.get(key);
            const color = getLDrawColor(data.color);
            cell.style.background = color;
            cell.classList.add('occupied');
        } else {
            cell.style.background = 'rgba(42, 193, 255, 0.03)';
            cell.classList.remove('occupied');
        }
    });

    console.log('[2D MINIMAP] Rendered', occupiedCells.size, 'occupied Frank cells');
}

function highlightLinesAtGridPosition(gridX, gridY) {
    // gridX/gridY are Frank cell offsets (Œîx, Œîz) in cell units
    const matchingIndices = [];

    editorLines.forEach((line, idx) => {
        const trimmed = line.trim();
        if (!trimmed.startsWith('1 ')) return;

        const tokens = trimmed.split(/\s+/);
        if (tokens.length < 15) return;

        try {
            const xLdu = parseFloat(tokens[2]);
            const zLdu = parseFloat(tokens[4]);
            if (Number.isNaN(xLdu) || Number.isNaN(zLdu)) return;

            const colOffset = Math.round(xLdu / FRANK_GRID_CONFIG.cellSizeLDU);
            const rowOffset = Math.round(zLdu / FRANK_GRID_CONFIG.cellSizeLDU);

            if (colOffset === gridX && rowOffset === gridY) {
                matchingIndices.push(idx);
            }
        } catch (e) {
            // Skip invalid lines
        }
    });

    if (matchingIndices.length === 0) {
        const statusEl = document.getElementById('status-text');
        if (statusEl) {
            statusEl.textContent = 'No parts at Frank cell (Œîx=' + gridX + ', Œîz=' + gridY + ')';
        }
        return;
    }

    // Highlight all matching lines in editor
    const editorLines2 = editorContainer.querySelectorAll('.editor-line');
    editorLines2.forEach((lineEl, idx) => {
        if (matchingIndices.includes(idx)) {
            lineEl.classList.add('highlighted');
            setTimeout(() => lineEl.classList.remove('highlighted'), 2000);
        }
    });

    // Scroll to first matching line
    const firstLine = editorContainer.children[matchingIndices[0]];
    if (firstLine) {
        firstLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    const statusEl = document.getElementById('status-text');
    if (statusEl) {
        statusEl.textContent = matchingIndices.length + ' part(s) at Frank cell (Œîx=' + gridX + ', Œîz=' + gridY + ')';
    }
}

    function copySelection() {
        if (selectedLines.size === 0) {
            document.getElementById('status-text').textContent = 'No selection to copy';
            return;
        }
        
        const sortedIndices = Array.from(selectedLines).sort((a, b) => a - b);
        const copiedText = sortedIndices.map(idx => editorLines[idx]).join('\n');
        
        navigator.clipboard.writeText(copiedText).then(() => {
            document.getElementById('status-text').textContent = `‚úì Copied selection (${selectedLines.size} line${selectedLines.size > 1 ? 's' : ''})`;
            console.log(`[COPY] ${selectedLines.size} lines copied`);
        }).catch(err => {
            document.getElementById('status-text').textContent = `‚úó Copy failed: ${err.message}`;
        });
    }
    
    function cutSelection() {
        if (selectedLines.size === 0) {
            document.getElementById('status-text').textContent = 'No selection to cut';
            return;
        }

        const sortedIndices = Array.from(selectedLines).sort((a, b) => b - a);
        // First copy the selection
        copySelection();

        // Then delete each line (highest index first so indices stay valid)
        sortedIndices.forEach((idx) => {
            deleteLine(idx);
        });

        selectedLines.clear();
        document.getElementById('status-text').textContent = `‚úì Cut selection (${sortedIndices.length} line${sortedIndices.length > 1 ? 's' : ''})`;
    }

    function deleteSelection() {
        if (selectedLines.size === 0) {
            document.getElementById('status-text').textContent = 'No selection to delete';
            return;
        }

        const sortedIndices = Array.from(selectedLines).sort((a, b) => b - a);

        sortedIndices.forEach((idx) => {
            deleteLine(idx);
        });

        selectedLines.clear();
        document.getElementById('status-text').textContent = `‚úì Deleted selection (${sortedIndices.length} line${sortedIndices.length > 1 ? 's' : ''})`;
    }

    function selectSection(startIdx) {
        // Clear multi-selection when doing section select
        selectedLines.clear();
        
        // Find section boundaries
        let sectionStart = startIdx;
        let sectionEnd = startIdx;
        
        // Look backwards for previous comment
        for (let i = startIdx - 1; i >= 0; i--) {
            const trimmed = editorLines[i].trim();
            if (trimmed.startsWith('0 //') || trimmed.startsWith('0 ‚ïê‚ïê‚ïê')) {
                sectionStart = i;
                break;
            }
            if (trimmed.startsWith('1 ')) {
                sectionStart = i;
            }
        }
        
        // Look forwards to next comment or STEP
        for (let i = startIdx + 1; i < editorLines.length; i++) {
            const trimmed = editorLines[i].trim();
            if (trimmed.startsWith('0 //') || trimmed.startsWith('0 ‚ïê‚ïê‚ïê') || 
                trimmed === '0 STEP' || trimmed === '0 NOFILE') {
                sectionEnd = i - 1;
                break;
            }
            if (trimmed.startsWith('1 ')) {
                sectionEnd = i;
            }
        }
        
        // Clear previous selections
        document.querySelectorAll('.editor-line.selected').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.grid-cell.selected').forEach(el => el.classList.remove('selected'));
        
        // Highlight selected section
        const partIndices = [];
        for (let i = sectionStart; i <= sectionEnd; i++) {
            const lineEl = editorContainer.children[i];
            if (lineEl) {
                lineEl.classList.add('selected');
                selectedLines.add(i); // Add to multi-selection set
                if (editorLines[i].trim().startsWith('1 ')) {
                    partIndices.push(i);
                }
            }
        }
        
        selectedSection = { start: sectionStart, end: sectionEnd, lines: partIndices };
        
        // Scroll to section start
        const firstLine = editorContainer.children[sectionStart];
        if (firstLine) {
            firstLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Highlight on 2D grid
        partIndices.forEach(idx => {
            const trimmed = editorLines[idx].trim();
            const tokens = trimmed.split(/\s+/);
            if (tokens.length >= 15) {
                try {
                    const x = Math.round(parseFloat(tokens[2]) / 20);
                    const z = Math.round(parseFloat(tokens[4]) / 20);
                    
                    const cells = document.querySelectorAll('.grid-cell');
                    cells.forEach(cell => {
                        if (parseInt(cell.dataset.gridX) === x && parseInt(cell.dataset.gridY) === z) {
                            cell.classList.add('selected');
                        }
                    });
                } catch (e) {}
            }
        });
        
        // Draw 3D bounding boxes
        draw3DBoundingBoxes(partIndices);
        
        document.getElementById('status-text').textContent = `Selected section: ${partIndices.length} parts (lines ${sectionStart + 1}-${sectionEnd + 1})`;
        console.log(`[SELECT SECTION] Lines ${sectionStart + 1}-${sectionEnd + 1}, ${partIndices.length} parts`);
    }
    
    function draw3DBoundingBoxes(partIndices) {
        // BetaPrime: viewer is the engine; use viewer.scene directly
        if (!STATE.viewer || !STATE.viewer.scene) return;
        
        const scene = STATE.viewer.scene;
        
        // Clear previous bounding boxes
        if (selectionBoundingBox) {
            scene.remove(selectionBoundingBox);
            selectionBoundingBox = null;
        }
        
        // Get meshes for selected parts
        // partIndices and mesh.userData.lineNum are both 0-based editor indices.
        const selectedMeshes = [];
        const lineIndexSet = new Set(partIndices);

        scene.traverse((obj) => {
            if (!obj.userData) return;
            const lineNum = obj.userData.lineNum;
            if (typeof lineNum === 'number' && lineIndexSet.has(lineNum)) {
                selectedMeshes.push(obj);
            }
        });
        
        if (selectedMeshes.length === 0) {
            console.log('[BOUNDING BOX] No meshes found for selected parts');
            return;
        }
        
        console.log(`[BOUNDING BOX] Drawing boxes for ${selectedMeshes.length} meshes`);
        
        // Create bounding box group
        const boxGroup = new THREE.Group();
        boxGroup.name = 'selection-bounding-boxes';
        
        selectedMeshes.forEach((mesh, idx) => {
            // Create edges geometry for wireframe effect around this mesh
            const edges = new THREE.EdgesGeometry(mesh.geometry);
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0x00ff00, 
                linewidth: 2,
                transparent: true,
                opacity: 0.8
            });
            const wireframe = new THREE.LineSegments(edges, lineMaterial);

            // Copy mesh transform to wireframe
            wireframe.position.copy(mesh.position);
            wireframe.rotation.copy(mesh.rotation);
            wireframe.scale.copy(mesh.scale);

            // Apply parent transforms if needed
            if (mesh.parent) {
                wireframe.applyMatrix4(mesh.parent.matrixWorld);
            }

            boxGroup.add(wireframe);

            // Add a small axes helper at the mesh origin to show control point
            const axes = new THREE.AxesHelper(40);
            axes.position.copy(mesh.position);
            axes.rotation.copy(mesh.rotation);
            if (mesh.parent) {
                axes.applyMatrix4(mesh.parent.matrixWorld);
            }
            boxGroup.add(axes);
        });
        
        selectionBoundingBox = boxGroup;
        scene.add(boxGroup);
    }
    
    function highlightLineOn2DGrid(lineIdx) {
        const line = editorLines[lineIdx];
        if (!line) return;
        
        const trimmed = line.trim();
        
        // Clear previous selections
        selectedLines.clear();
        document.querySelectorAll('.editor-line.selected').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.grid-cell.selected').forEach(el => el.classList.remove('selected'));
        
        // Clear bounding boxes
        if (selectionBoundingBox && STATE.viewer && STATE.viewer.scene) {
            STATE.viewer.scene.remove(selectionBoundingBox);
            selectionBoundingBox = null;
        }
        
        // Add single line to selection
        selectedLines.add(lineIdx);
        
        // Highlight selected line in editor
        const lineEl = editorContainer.children[lineIdx];
        if (lineEl) {
            lineEl.classList.add('selected');
            lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // If it's a Type 1 line, highlight on 2D grid
        if (!trimmed.startsWith('1 ')) {
            document.getElementById('status-text').textContent = `Selected: ${trimmed.substring(0, 50)}...`;
            return;
        }
        
        const tokens = trimmed.split(/\s+/);
        if (tokens.length < 15) return;
        
        try {
            const color = parseInt(tokens[1]);
            const x = Math.round(parseFloat(tokens[2]) / 20);
            const z = Math.round(parseFloat(tokens[4]) / 20);
            
            // Find and highlight grid cell
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(cell => {
                const cellX = parseInt(cell.dataset.gridX);
                const cellY = parseInt(cell.dataset.gridY);
                
                if (cellX === x && cellY === z) {
                    cell.classList.add('selected');
                }
            });
            
            // Update status
            const partName = tokens[tokens.length - 1];
            document.getElementById('status-text').textContent = `Selected: ${partName} at (${x}, ${z}) - Line ${lineIdx + 1}`;
            
            console.log(`[SELECT] Line ${lineIdx + 1} ‚Üí Grid (${x}, ${z})`);
        } catch (e) {
            console.warn('[SELECT] Invalid line format:', e.message);
        }
    }
    
    function highlightMissingParts(missing404Parts) {
        // Highlight lines that reference missing parts
        editorLines.forEach((line, idx) => {
            const trimmed = line.trim();
            if (!trimmed.startsWith('1 ')) return;
            
            const tokens = trimmed.split(/\s+/);
            if (tokens.length < 15) return;
            
            const partName = tokens[tokens.length - 1];
            
            // Check if this part is in the 404 list
            for (const missingPart of missing404Parts) {
                if (missingPart.includes(partName) || partName.includes(missingPart.replace(/^.*\//, ''))) {
                    const lineEl = editorContainer.children[idx];
                    if (lineEl) {
                        lineEl.classList.add('missing-part');
                        lineEl.title = `Missing part: ${missingPart}`;
                    }
                    break;
                }
            }
        });
        
        document.getElementById('status-text').textContent = `‚ö† ${missing404Parts.size} missing part(s) - check red lines`;
    }
    
    function renderSceneDots() {
        const dotsContainer = document.getElementById('scene-dots-vertical');
        if (!dotsContainer) return;
        
        dotsContainer.innerHTML = '';
        
        STATE.scenes.forEach((scene, idx) => {
            const dot = document.createElement('div');
            dot.style.cssText = `
                width: 14px;
                height: 14px;
                border-radius: 50%;
                background: ${idx === STATE.activeSceneIdx ? 'var(--accent)' : 'rgba(255,255,255,0.3)'};
                border: 2px solid ${idx === STATE.activeSceneIdx ? 'var(--accent)' : 'rgba(255,255,255,0.5)'};
                cursor: pointer;
                transition: all 0.2s;
            `;
            dot.title = scene.name;
            dot.addEventListener('click', () => switchScene(idx));
            dot.addEventListener('mouseenter', () => {
                if (idx !== STATE.activeSceneIdx) {
                    dot.style.background = 'rgba(255,215,0,0.5)';
                }
            });
            dot.addEventListener('mouseleave', () => {
                if (idx !== STATE.activeSceneIdx) {
                    dot.style.background = 'rgba(255,255,255,0.3)';
                }
            });
            dotsContainer.appendChild(dot);
        });
        
        // Add divider
        const divider = document.createElement('div');
        divider.style.cssText = `
            width: 20px;
            height: 1px;
            background: var(--border-primary);
        `;
        dotsContainer.appendChild(divider);
        
        // Add new scene button
        const newBtn = document.createElement('div');
        newBtn.textContent = '+';
        newBtn.style.cssText = `
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.2s;
        `;
        newBtn.title = 'New Scene (Session)';
        newBtn.addEventListener('click', () => {
            const newScene = createScene(`Scene ${STATE.scenes.length + 1}`);
            STATE.scenes.push(newScene);
            switchScene(STATE.scenes.length - 1);
        });
        newBtn.addEventListener('mouseenter', () => {
            newBtn.style.background = 'var(--accent)';
            newBtn.style.borderColor = 'var(--accent)';
        });
        newBtn.addEventListener('mouseleave', () => {
            newBtn.style.background = 'rgba(255,255,255,0.2)';
            newBtn.style.borderColor = 'rgba(255,255,255,0.5)';
        });
        dotsContainer.appendChild(newBtn);
    }

    function parseType1Line(line) {
        if (!line || typeof line !== 'string') return null;
        const match = line.match(/^\s*1\s+(\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(-?\d*\.?\d+)\s+(\S+)/);
        if (!match) return null;
        const color = parseInt(match[1], 10);
        const x = parseFloat(match[2]);
        const y = parseFloat(match[3]);
        const z = parseFloat(match[4]);
        const a = parseFloat(match[5]);
        const b = parseFloat(match[6]);
        const c = parseFloat(match[7]);
        const d = parseFloat(match[8]);
        const e = parseFloat(match[9]);
        const f = parseFloat(match[10]);
        const g = parseFloat(match[11]);
        const h = parseFloat(match[12]);
        const i = parseFloat(match[13]);
        const partId = match[14];
        if (![x, y, z, a, b, c, d, e, f, g, h, i].every(v => isFinite(v))) return null;
        return { color, x, y, z, a, b, c, d, e, f, g, h, i, partId };
    }

    function assignViolationOwnersFromMPD(violations) {
        if (!Array.isArray(violations) || !violations.length) return;
        const transforms = [];
        for (let idx = 0; idx < editorLines.length; idx++) {
            const line = editorLines[idx];
            const trimmed = line && line.trim();
            if (!trimmed || !trimmed.startsWith('1 ')) continue;
            const parsed = parseType1Line(line);
            if (!parsed) continue;
            transforms.push({
                lineNum: idx,
                partId: parsed.partId,
                color: parsed.color,
                x: parsed.x,
                y: parsed.y,
                z: parsed.z
            });
        }
        if (!transforms.length) return;

        const thresholdXZ = 60;
        const thresholdY = 40;

        violations.forEach(v => {
            if (!v || !v.from) return;
            const vx = v.from.x;
            const vy = v.from.y;
            const vz = v.from.z;
            if (!isFinite(vx) || !isFinite(vy) || !isFinite(vz)) return;
            let bestIdx = -1;
            let bestScore = Infinity;
            for (let i = 0; i < transforms.length; i++) {
                const t = transforms[i];
                const dx = vx - t.x;
                const dz = vz - t.z;
                const dXZ2 = dx * dx + dz * dz;
                if (dXZ2 > thresholdXZ * thresholdXZ) continue;
                const dy = vy - t.y;
                if (Math.abs(dy) > thresholdY) continue;
                const score = dXZ2 + dy * dy;
                if (score < bestScore) {
                    bestScore = score;
                    bestIdx = i;
                }
            }
            if (bestIdx >= 0) {
                const owner = transforms[bestIdx];
                v.lineNum = owner.lineNum;
            }
        });
    }

    function computeGroundLineOffsets() {
        const summary = STATE.groundViolationSummary;
        const offsets = new Map();
        const transforms = [];
        if (!summary || !summary.length) {
            STATE.groundTransforms = [];
            return offsets;
        }
        const plateHeight = 8;
        const epsilon = 0.001;
        summary.forEach(entry => {
            const idx = entry && typeof entry.lineNum === 'number' ? entry.lineNum : null;
            if (idx === null || idx < 0 || idx >= editorLines.length) return;
            let delta = entry.maxDeltaY;
            if (!isFinite(delta)) return;
            const snapped = Math.round(delta / plateHeight) * plateHeight;
            if (Math.abs(snapped) < epsilon) return;
            const existing = offsets.get(idx);
            if (existing === undefined || Math.abs(snapped) > Math.abs(existing)) {
                offsets.set(idx, snapped);
            }
        });

        offsets.forEach((deltaY, idx) => {
            const line = editorLines[idx];
            const parsed = parseType1Line(line);
            if (!parsed) return;
            const yBefore = parsed.y;
            const yAfter = yBefore + deltaY;
            const matrixBefore = [
                parsed.a, parsed.b, parsed.c, parsed.x,
                parsed.d, parsed.e, parsed.f, parsed.y,
                parsed.g, parsed.h, parsed.i, parsed.z,
                0, 0, 0, 1
            ];
            const matrixAfter = [
                parsed.a, parsed.b, parsed.c, parsed.x,
                parsed.d, parsed.e, parsed.f, yAfter,
                parsed.g, parsed.h, parsed.i, parsed.z,
                0, 0, 0, 1
            ];
            transforms.push({
                lineNum: idx,
                partId: parsed.partId,
                color: parsed.color,
                deltaY,
                translationBefore: { x: parsed.x, y: parsed.y, z: parsed.z },
                translationAfter: { x: parsed.x, y: yAfter, z: parsed.z },
                matrixBefore,
                matrixAfter
            });
        });

        STATE.groundTransforms = transforms;
        if (transforms.length) {
            console.log('[STUD] Ground correction transforms prepared for', transforms.length, 'lines');
        }
        return offsets;
    }

    function formatLDrawNumber(value) {
        if (!isFinite(value)) return '0';
        return Number.isInteger(value) ? String(value) : value.toFixed(3).replace(/\.0+$/, '').replace(/\.0$/, '');
    }

    function adjustType1LineY(line, deltaY) {
        if (!line || typeof line !== 'string') return line;
        // Preserve original leading whitespace
        const leadingMatch = line.match(/^\s*/);
        const leading = leadingMatch ? leadingMatch[0] : '';
        const core = line.slice(leading.length);
        // Only adjust type-1 lines
        if (!core.startsWith('1 ')) return line;
        const parts = core.split(/\s+/);
        // Expect at least: 1 color x y
        if (parts.length < 4) return line;
        const oldY = parseFloat(parts[3]);
        if (!isFinite(oldY)) return line;
        // NOTE: In Courage MPDs, "up" is more negative Y. deltaY is computed in world space
        // as (baseY - fromY), which is positive for studs below the base grid. To move those
        // studs upward toward the base grid we must SUBTRACT deltaY from the MPD Y value.
        const newY = oldY - deltaY;
        parts[3] = formatLDrawNumber(newY);
        const rebuilt = parts.join(' ');
        return leading + rebuilt;
    }

    function buildGroundCorrectedLines() {
        const offsets = computeGroundLineOffsets();
        if (!offsets.size) {
            console.log('[STUD] No ground corrections to apply; returning original lines');
            return [...editorLines];
        }
        const lines = editorLines.map((line, idx) => {
            const delta = offsets.get(idx);
            if (delta === undefined) return line;
            return adjustType1LineY(line, delta);
        });
        return lines;
    }

    function buildGroundCorrectedMPD() {
        const lines = buildGroundCorrectedLines();
        return lines.join('\n');
    }

    function applyGroundCorrectionsToEditor() {
        const lines = buildGroundCorrectedLines();
        editorLines = lines;
        STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
        renderEditor(editorLines);
        const statusText = document.getElementById('status-text');
        if (statusText) {
            statusText.textContent = 'Ground corrections applied';
        }
    }

    function toggleGroundCorrections() {
        const statusText = document.getElementById('status-text');
        if (!STATE.groundActive) {
            const originalText = Array.isArray(editorLines) ? editorLines.join('\n') : '';
            const correctedLines = buildGroundCorrectedLines();
            const correctedText = correctedLines.join('\n');
            if (correctedText === originalText) {
                if (statusText) statusText.textContent = 'No ground corrections to apply';
                return false;
            }

            STATE.groundOriginalLines = Array.isArray(editorLines) ? [...editorLines] : [];
            editorLines = correctedLines;
            if (STATE.scenes[STATE.activeSceneIdx]) {
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
            }
            renderEditor(editorLines);
            if (statusText) statusText.textContent = 'Ground corrections applied';
            STATE.groundActive = true;
        } else {
            if (Array.isArray(STATE.groundOriginalLines) && STATE.groundOriginalLines.length) {
                editorLines = [...STATE.groundOriginalLines];
                if (STATE.scenes[STATE.activeSceneIdx]) {
                    STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                }
                renderEditor(editorLines);
                if (statusText) statusText.textContent = 'Ground corrections reverted';
            } else if (statusText) {
                statusText.textContent = 'No original scene to restore';
            }
            STATE.groundActive = false;
        }

        setTimeout(() => compile(), 200);
        return STATE.groundActive;
    }

    function buildStudSkeletonMPD() {
        const studs = STATE.studSkeleton || [];
        if (!studs.length) {
            console.log('[STUD] No stud skeleton available for export');
            return '';
        }
        const lines = [];
        lines.push('0 FILE wag_courage_stud_skeleton.mpd');
        lines.push('0 Name: WAG-Courage Stud Skeleton Export');
        lines.push('0 Author: Courage Tooling');
        lines.push('0 !LDRAW_ORG Model');
        lines.push('0 BFC CERTIFY CCW');
        lines.push('');

        const baseLayer = typeof STATE.baseGridLayer === 'number' ? STATE.baseGridLayer : null;
        const plateHeight = 8;

        studs.forEach((node, idx) => {
            if (!node || !node.worldPos) return;
            const x = formatLDrawNumber(node.worldPos.x);
            const y = formatLDrawNumber(node.worldPos.y);
            const z = formatLDrawNumber(node.worldPos.z);
            const gx = typeof node.gridX === 'number' ? node.gridX : null;
            const gz = typeof node.gridZ === 'number' ? node.gridZ : null;
            const layer = typeof node.layer === 'number' ? node.layer : null;
            const isBelow = baseLayer !== null && layer !== null && layer < baseLayer;
            const color = isBelow ? 4 : 1;
            const lineNum = typeof node.lineNum === 'number' ? node.lineNum : null;
            const studIndex = idx;
            const layerY = layer !== null ? formatLDrawNumber(layer * plateHeight) : null;

            if (lineNum !== null || gx !== null || gz !== null || layerY !== null) {
                const parts = [];
                if (lineNum !== null) parts.push('line ' + lineNum);
                if (gx !== null && gz !== null) parts.push('grid ' + gx + ',' + gz);
                if (layerY !== null) parts.push('layerY ' + layerY);
                parts.push('stud ' + studIndex);
                lines.push('0 ' + parts.join(' '));
            }

            lines.push(
                '1 ' + color + ' ' + x + ' ' + y + ' ' + z +
                '  1 0 0  0 1 0  0 0 1  3003.dat'
            );
        });

        return lines.join('\n');
    }

    function copyStudSkeletonMPD() {
        const text = buildStudSkeletonMPD();
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = 'üìã Copied stud skeleton MPD';
            }
        }).catch(err => {
            console.warn('[STUD] Failed to copy stud skeleton MPD', err);
        });
    }

    function printGroundViolationTable(limit = 50) {
        const violations = STATE.groundViolations || [];
        if (!violations.length) {
            console.log('[STUD] No ground violations to print');
            return [];
        }

        if (typeof computeGroundLineOffsets === 'function') {
            computeGroundLineOffsets();
        }

        const transformsArray = STATE.groundTransforms || [];
        const transformsByLine = new Map();
        transformsArray.forEach(t => {
            if (t && typeof t.lineNum === 'number') {
                transformsByLine.set(t.lineNum, t);
            }
        });

        const rows = [];
        const partCache = new Map();
        const max = Math.min(limit, violations.length);
        for (let idx = 0; idx < max; idx++) {
            const v = violations[idx];
            const lineNum = typeof v.lineNum === 'number' ? v.lineNum : null;
            const transform = lineNum !== null ? transformsByLine.get(lineNum) : null;

            let partId = transform && transform.partId ? transform.partId : null;
            let lineText = null;
            if (lineNum !== null && lineNum >= 0 && lineNum < editorLines.length) {
                lineText = editorLines[lineNum];
                if (!partId) {
                    if (partCache.has(lineNum)) {
                        partId = partCache.get(lineNum);
                    } else {
                        const parsed = parseType1Line(editorLines[lineNum]);
                        partId = parsed ? parsed.partId : null;
                        partCache.set(lineNum, partId);
                    }
                }
            }
            rows.push({
                idx,
                lineNum,
                partId,
                lineText,
                gridX: v.gridX,
                gridZ: v.gridZ,
                layer: v.layer,
                worldX: v.from && typeof v.from.x === 'number' ? v.from.x : null,
                worldY: v.from && typeof v.from.y === 'number' ? v.from.y : null,
                worldZ: v.from && typeof v.from.z === 'number' ? v.from.z : null,
                baseY: v.to && typeof v.to.y === 'number' ? v.to.y : null,
                deltaY: v.deltaY,
                proposedDeltaY: transform && typeof transform.deltaY === 'number' ? transform.deltaY : null,
                yBefore: transform && transform.translationBefore ? transform.translationBefore.y : null,
                yAfter: transform && transform.translationAfter ? transform.translationAfter.y : null
            });
        }
        if (console.table) {
            console.table(rows);
        } else {
            console.log(rows);
        }
        return rows;
    }

    function setupPanelButtons() {
        document.getElementById('render-btn').addEventListener('click', () => {
            const statusText = document.getElementById('status-text');
            if (statusText) statusText.textContent = 'Rendering...';
            
            // Small delay to show status
            setTimeout(() => {
                compile();
            }, 100);
        });
        
        document.getElementById('copy-all-btn').addEventListener('click', () => {
            const text = editorLines.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const statusText = document.getElementById('status-text');
                statusText.textContent = `üìã Copied ${editorLines.length} lines!`;
                statusText.style.color = 'var(--accent)';
                statusText.style.fontWeight = '700';
                setTimeout(() => {
                    statusText.textContent = 'Ready';
                    statusText.style.color = '';
                    statusText.style.fontWeight = '';
                }, 2000);
            });
        });
        
        const copyGroundBtn = document.getElementById('copy-ground-btn');
        if (copyGroundBtn) {
            copyGroundBtn.addEventListener('click', () => {
                const text = buildGroundCorrectedMPD();
                if (!text) return;
                navigator.clipboard.writeText(text).then(() => {
                    const statusText = document.getElementById('status-text');
                    if (statusText) {
                        statusText.textContent = 'üìã Copied ground-corrected MPD';
                        statusText.style.color = 'var(--accent)';
                        statusText.style.fontWeight = '700';
                        setTimeout(() => {
                            statusText.textContent = 'Ready';
                            statusText.style.color = '';
                            statusText.style.fontWeight = '';
                        }, 2000);
                    }
                }).catch(err => {
                    console.warn('[STUD] Failed to copy ground-corrected MPD', err);
                });
            });
        }
        
        // üíö SELECT ALL button
        document.getElementById('select-all-btn').addEventListener('click', () => {
            selectAllLines();
        });
        
        // üíö DESELECT ALL button
        document.getElementById('deselect-all-btn').addEventListener('click', () => {
            deselectAllLines();
        });
        
        // üíö INVERT SELECTION button
        document.getElementById('invert-selection-btn').addEventListener('click', () => {
            invertSelection();
        });
        
        // New MPD - Create blank template
        document.getElementById('new-mpd-btn').addEventListener('click', () => {
            if (confirm('Create new blank MPD? Current scene will be saved.')) {
                editorLines = [
                    '0 FILE untitled.mpd',
                    '0 Name: New Model',
                    '0 Author: ',
                    '0 ',
                    '0 ',
                ];
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = 'New blank MPD created';
            }
        });
        
        // Discard (Clear but keep locked)
        document.getElementById('clear-mpd-btn').addEventListener('click', () => {
            if (confirm('Discard unlocked lines? Locked lines will be kept.')) {
                const scene = STATE.scenes[STATE.activeSceneIdx];
                const newLines = [];
                editorLines.forEach((line, idx) => {
                    if (scene.lockedLines.has(idx)) {
                        newLines.push(line);
                    }
                });
                if (newLines.length === 0) {
                    newLines.push('0 FILE scene.mpd', '0 Empty', '', '0 STEP', '0 NOFILE');
                }
                editorLines = newLines;
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = 'Unlocked lines discarded';
            }
        });
        
        // Undo/Redo with simple history
        const history = {
            stack: [],
            position: -1,
            maxSize: 50
        };
        
        function saveHistory() {
            // Remove any redo history
            history.stack = history.stack.slice(0, history.position + 1);
            // Add current state
            history.stack.push([...editorLines]);
            // Limit size
            if (history.stack.length > history.maxSize) {
                history.stack.shift();
            } else {
                history.position++;
            }
        }
        
        // Save initial state
        saveHistory();
        
        // Undo
        document.getElementById('mpd-undo-btn').addEventListener('click', () => {
            if (history.position > 0) {
                history.position--;
                editorLines = [...history.stack[history.position]];
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = `Undo (${history.position + 1}/${history.stack.length})`;
            } else {
                document.getElementById('status-text').textContent = 'Nothing to undo';
            }
        });
        
        // Redo
        document.getElementById('mpd-redo-btn').addEventListener('click', () => {
            if (history.position < history.stack.length - 1) {
                history.position++;
                editorLines = [...history.stack[history.position]];
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = `Redo (${history.position + 1}/${history.stack.length})`;
            } else {
                document.getElementById('status-text').textContent = 'Nothing to redo';
            }
        });
        
        // Header center undo/redo (same functionality)
        document.getElementById('undo-btn').addEventListener('click', () => {
            if (history.position > 0) {
                history.position--;
                editorLines = [...history.stack[history.position]];
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = `‚Ü∂ Undo (${history.position + 1}/${history.stack.length})`;
            } else {
                document.getElementById('status-text').textContent = 'Nothing to undo';
            }
        });
        
        document.getElementById('redo-btn').addEventListener('click', () => {
            if (history.position < history.stack.length - 1) {
                history.position++;
                editorLines = [...history.stack[history.position]];
                STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                renderEditor(editorLines);
                document.getElementById('status-text').textContent = `‚Ü∑ Redo (${history.position + 1}/${history.stack.length})`;
            } else {
                document.getElementById('status-text').textContent = 'Nothing to redo';
            }
        });
        
        // Hook into renderEditor to save history after major changes
        const originalRenderEditor = renderEditor;
        renderEditor = function(lines) {
            originalRenderEditor.call(this, lines);
            // Auto-save after render (debounced)
            clearTimeout(renderEditor.saveTimer);
            renderEditor.saveTimer = setTimeout(() => saveHistory(), 500);
        };
        
        // Screenshot button
        document.getElementById('screenshot-btn').addEventListener('click', () => {
            captureScreenshot();
        });

        // GOLD import button - load GOLD JSON and restore MPD
        const goldBtn = document.getElementById('gold-import-btn');
        if (goldBtn) {
            goldBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    const statusText = document.getElementById('status-text');
                    try {
                        if (statusText) statusText.textContent = `Loading GOLD: ${file.name}...`;
                        const text = await file.text();
                        const data = JSON.parse(text);
                        const mpd = typeof data.mpd_content === 'string' ? data.mpd_content : null;
                        if (!mpd || !mpd.trim()) {
                            alert('Selected GOLD JSON does not contain a non-empty "mpd_content" field.');
                            if (statusText) statusText.textContent = '‚ùå GOLD load failed (no mpd_content)';
                            return;
                        }

                        const normalized = mpd.replace(/\r\n/g, '\n');
                        editorLines = normalized.split('\n');
                        const scene = STATE.scenes[STATE.activeSceneIdx];
                        if (scene) {
                            scene.lines = [...editorLines];
                            if (data.scene && typeof data.scene === 'string') {
                                scene.name = data.scene;
                            }
                        }

                        renderEditor(editorLines);

                        const fileNameEl = document.getElementById('file-name');
                        if (fileNameEl) {
                            const label = (scene && scene.name) || file.name.replace(/\.json$/i, '');
                            fileNameEl.textContent = label;
                        }

                        if (data.diagnostics && typeof data.diagnostics === 'object') {
                            STATE.diagnostics = { ...STATE.diagnostics, ...data.diagnostics };
                            if (STATE.viewer) STATE.viewer.setDiagnostics(STATE.diagnostics);
                        }

                        if (statusText) statusText.textContent = `üíö GOLD loaded: ${file.name}`;
                        setTimeout(() => compile(), 200);
                    } catch (err) {
                        console.error('Failed to load GOLD JSON', err);
                        if (statusText) statusText.textContent = '‚ùå GOLD load failed';
                        alert('Failed to load GOLD JSON:\n' + err.message);
                    }
                });
                input.click();
            });
        }

        // GLB export button
        const glbBtn = document.getElementById('glb-export-btn');
        if (glbBtn) {
            glbBtn.addEventListener('click', () => {
                exportSceneAsGLB();
            });
        }
        
        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Delete key = Delete selected lines (GRACE FEATURE!)
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // Only if not focused in editable content
                if (e.target.classList.contains('line-content')) return;
                
                if (selectedLines.size > 0) {
                    e.preventDefault();
                    
                    // Sort in reverse order so deletion doesn't shift indices
                    const sortedIndices = Array.from(selectedLines).sort((a, b) => b - a);
                    
                    // Delete lines from bottom up
                    sortedIndices.forEach(idx => {
                        editorLines.splice(idx, 1);
                    });
                    
                    // Clear selection
                    selectedLines.clear();
                    
                    // Re-render editor
                    renderEditor(editorLines);
                    
                    const statusText = document.getElementById('status-text');
                    if (statusText) {
                        statusText.textContent = `üíö Deleted ${sortedIndices.length} line(s)`;
                        statusText.style.color = 'var(--success)';
                        setTimeout(() => {
                            statusText.textContent = 'Ready';
                            statusText.style.color = '';
                        }, 2000);
                    }
                    
                    console.log(`üíö Grace: Deleted ${sortedIndices.length} selected lines`);
                    return;
                }
            }
            
            // Cmd+Z or Ctrl+Z = Undo
            if ((e.metaKey || e.ctrlKey) && !e.shiftKey && e.key === 'z') {
                e.preventDefault();
                if (history.position > 0) {
                    history.position--;
                    editorLines = [...history.stack[history.position]];
                    STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                    renderEditor(editorLines);
                    document.getElementById('status-text').textContent = `‚Ü∂ Undo (${history.position + 1}/${history.stack.length})`;
                } else {
                    document.getElementById('status-text').textContent = 'Nothing to undo';
                }
                return;
            }
            
            // Cmd+Shift+Z or Ctrl+Shift+Z = Redo
            if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'z') {
                e.preventDefault();
                if (history.position < history.stack.length - 1) {
                    history.position++;
                    editorLines = [...history.stack[history.position]];
                    STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
                    renderEditor(editorLines);
                    document.getElementById('status-text').textContent = `‚Ü∑ Redo (${history.position + 1}/${history.stack.length})`;
                } else {
                    document.getElementById('status-text').textContent = 'Nothing to redo';
                }
                return;
            }
            
            // Ctrl+Shift+S = Screenshot
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                captureScreenshot();
                return;
            }
            
            // Cmd+S or Ctrl+S = Trigger render (compile)
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                compile();
                return;
            }
            
            // Cmd+A or Ctrl+A = Select All
            if ((e.metaKey || e.ctrlKey) && e.key === 'a') {
                e.preventDefault();
                selectAllLines();
                return;
            }
            
            // Esc = Deselect All
            if (e.key === 'Escape' && selectedLines.size > 0) {
                e.preventDefault();
                deselectAllLines();
                return;
            }
            
            // Cmd+I or Ctrl+I = Invert Selection
            if ((e.metaKey || e.ctrlKey) && e.key === 'i') {
                e.preventDefault();
                invertSelection();
                return;
            }
            
            // Cmd+E or Ctrl+E = Batch Edit Numbers (when lines selected)
            if ((e.metaKey || e.ctrlKey) && e.key === 'e' && selectedLines.size > 0) {
                e.preventDefault();
                showBatchEditModal();
                return;
            }
            
            // Cmd+/ or Ctrl+/ = Toggle comments (turn sections on/off)
            if ((e.metaKey || e.ctrlKey) && e.key === '/' && selectedLines.size > 0) {
                e.preventDefault();
                toggleComments();
                return;
            }
        });
    }
    
    // üíö TOGGLE COMMENTS - Turn sections on/off by commenting
    function toggleComments() {
        let commentedCount = 0;
        let uncommentedCount = 0;
        
        // Check if all selected lines are commented
        const allCommented = Array.from(selectedLines).every(idx => {
            return editorLines[idx].trim().startsWith('0 //');
        });
        
        selectedLines.forEach(idx => {
            const line = editorLines[idx];
            
            if (allCommented) {
                // Uncomment: Remove "0 // " prefix
                if (line.trim().startsWith('0 //')) {
                    editorLines[idx] = line.replace(/^(\s*)0 \/\/ /, '$1');
                    uncommentedCount++;
                }
            } else {
                // Comment: Add "0 // " prefix (unless already a comment line)
                if (!line.trim().startsWith('0 ')) {
                    editorLines[idx] = `0 // ${line}`;
                    commentedCount++;
                } else if (line.trim().startsWith('0 ') && !line.trim().startsWith('0 //')) {
                    // Convert regular comment to disabled comment
                    editorLines[idx] = line.replace(/^(\s*)0 /, '$10 // ');
                    commentedCount++;
                }
            }
        });
        
        renderEditor(editorLines);
        
        const statusText = document.getElementById('status-text');
        if (statusText) {
            if (allCommented) {
                statusText.textContent = `üíö Enabled ${uncommentedCount} line(s)`;
            } else {
                statusText.textContent = `üíö Disabled ${commentedCount} line(s)`;
            }
            statusText.style.color = 'var(--accent)';
            setTimeout(() => {
                statusText.textContent = 'Ready';
                statusText.style.color = '';
            }, 2000);
        }
        
        console.log(`üíö Toggle: ${allCommented ? 'Enabled' : 'Disabled'} ${selectedLines.size} lines`);
    }
    
    // üíö BATCH EDIT - Edit multiple numbers simultaneously across selected lines
    function showBatchEditModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        `;
        
        panel.innerHTML = `
            <h2 style="color: var(--accent); margin: 0 0 16px 0;">üíö Batch Edit Numbers</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Replace all occurrences of a number across ${selectedLines.size} selected line(s)
            </p>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; color: var(--text-primary);">Find Number:</label>
                <input type="text" id="batch-find" placeholder="e.g. 120" style="width: 100%; padding: 8px; background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px; font-family: monospace;">
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 4px; color: var(--text-primary);">Replace With:</label>
                <input type="text" id="batch-replace" placeholder="e.g. 240" style="width: 100%; padding: 8px; background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px; font-family: monospace;">
            </div>
            
            <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 4px;">
                <div style="color: var(--accent); font-weight: 600; margin-bottom: 4px;">üí° Tips:</div>
                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 13px;">
                    <li>Works on exact number matches</li>
                    <li>Great for adjusting coordinates, colors, sizes</li>
                    <li>Changes only in selected lines</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="batch-cancel" class="panel-btn" style="padding: 8px 16px;">Cancel</button>
                <button id="batch-apply" class="panel-btn" style="padding: 8px 16px; background: var(--accent); color: var(--bg-main); font-weight: 600;">Replace All</button>
            </div>
        `;
        
        modal.appendChild(panel);
        document.body.appendChild(modal);
        
        const findInput = document.getElementById('batch-find');
        const replaceInput = document.getElementById('batch-replace');
        
        findInput.focus();
        
        // Apply batch edit
        document.getElementById('batch-apply').addEventListener('click', () => {
            const findValue = findInput.value.trim();
            const replaceValue = replaceInput.value.trim();
            
            if (!findValue) {
                alert('Please enter a number to find');
                return;
            }
            
            let replacementCount = 0;
            
            // Replace in selected lines
            selectedLines.forEach(idx => {
                const line = editorLines[idx];
                // Match whole numbers only (not partial)
                const regex = new RegExp(`\\b${findValue}\\b`, 'g');
                const newLine = line.replace(regex, replaceValue);
                
                if (newLine !== line) {
                    editorLines[idx] = newLine;
                    replacementCount++;
                }
            });
            
            renderEditor(editorLines);
            document.body.removeChild(modal);
            
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = `üíö Replaced "${findValue}" ‚Üí "${replaceValue}" in ${replacementCount} line(s)`;
                statusText.style.color = 'var(--accent)';
                setTimeout(() => {
                    statusText.textContent = 'Ready';
                    statusText.style.color = '';
                }, 3000);
            }
            
            console.log(`üíö Batch Edit: Replaced "${findValue}" ‚Üí "${replaceValue}" in ${replacementCount} lines`);
        });
        
        // Cancel
        document.getElementById('batch-cancel').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        // ESC to close
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.body.removeChild(modal);
            }
        });
    }
    
    function exportSceneAsGLB() {
        const statusText = document.getElementById('status-text');
        const glbBtn = document.getElementById('glb-export-btn');
        try {
            if (typeof THREE === 'undefined' || !THREE.GLTFExporter) {
                console.warn('[GLB] THREE.GLTFExporter not available');
                if (statusText) statusText.textContent = 'GLB export not available';
                return;
            }
            if (!STATE.viewer) {
                console.warn('[GLB] Viewer not ready');
                if (statusText) statusText.textContent = 'GLB export failed';
                return;
            }

            // Prefer the underlying LDraw model root to avoid exporting helpers/grid
            const root = (STATE.viewer.getModel && STATE.viewer.getModel()) ||
                         STATE.viewer.modelRoot ||
                         STATE.viewer.modelWrapper ||
                         STATE.viewer.scene;
            if (!root) {
                console.warn('[GLB] No model to export');
                if (statusText) statusText.textContent = 'No model to export';
                return;
            }

            const exporter = new THREE.GLTFExporter();
            const sceneMeta = STATE.scenes[STATE.activeSceneIdx];
            const sceneName = sceneMeta ? sceneMeta.name : 'Scene';
            const safeName = sceneName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0];
            const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-');
            const baseFilename = `grace_scene_${safeName}_${dateStr}_${timeStr}`;

            if (statusText) {
                statusText.textContent = 'Exporting GLB...';
                statusText.style.color = 'var(--accent)';
            }
            if (glbBtn) {
                glbBtn.disabled = true;
                glbBtn.textContent = '‚Ä¶';
            }

            exporter.parse(
                root,
                (gltf) => {
                    try {
                        let blob;
                        let filename;

                        // three@0.128: when { binary: true } is honored, gltf is an ArrayBuffer.
                        if (gltf instanceof ArrayBuffer) {
                            blob = new Blob([gltf], { type: 'model/gltf-binary' });
                            filename = `${baseFilename}.glb`;
                        } else {
                            // Fallback: JSON glTF object
                            const json = typeof gltf === 'string' ? gltf : JSON.stringify(gltf, null, 2);
                            blob = new Blob([json], { type: 'model/gltf+json' });
                            filename = `${baseFilename}.gltf`;
                        }

                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        // Build a manifest of LDraw part placements (like screenshot JSON)
                        try {
                            const partEntries = [];
                            if (Array.isArray(editorLines)) {
                                editorLines.forEach((line, idx) => {
                                    if (!line || typeof line !== 'string') return;
                                    const trimmed = line.trim();
                                    if (!trimmed.startsWith('1 ')) return; // Only part placement lines

                                    const pieces = trimmed.split(/\s+/);
                                    if (pieces.length < 15) return; // color + x y z + 3x3 matrix + filename

                                    const colorCode = parseInt(pieces[1], 10);
                                    const x = parseFloat(pieces[2]);
                                    const y = parseFloat(pieces[3]);
                                    const z = parseFloat(pieces[4]);
                                    const m = pieces.slice(5, 14).map((v) => parseFloat(v));
                                    const file = pieces[14];

                                    partEntries.push({
                                        lineIndex: idx,
                                        lineNumber: idx + 1,
                                        raw: line,
                                        colorCode: Number.isNaN(colorCode) ? null : colorCode,
                                        position: {
                                            x: Number.isNaN(x) ? null : x,
                                            y: Number.isNaN(y) ? null : y,
                                            z: Number.isNaN(z) ? null : z
                                        },
                                        matrix: m,
                                        filename: file
                                    });
                                });
                            }

                            const manifest = {
                                filename,
                                scene: sceneName,
                                date: dateStr,
                                time: timeStr,
                                timestamp: date.toISOString(),
                                line_count: Array.isArray(editorLines) ? editorLines.length : null,
                                part_count: partEntries.length,
                                camera: STATE.viewer && STATE.viewer.getCamera ? STATE.viewer.getCamera() : null,
                                stats: STATE.viewer && STATE.viewer.getStats ? STATE.viewer.getStats() : null,
                                parts: partEntries
                            };

                            const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
                            const manifestURL = URL.createObjectURL(manifestBlob);
                            const manifestLink = document.createElement('a');
                            manifestLink.href = manifestURL;
                            manifestLink.download = `${baseFilename}_manifest.json`;
                            document.body.appendChild(manifestLink);
                            manifestLink.click();
                            document.body.removeChild(manifestLink);
                            URL.revokeObjectURL(manifestURL);
                        } catch (manifestErr) {
                            console.error('[GLB] Manifest generation failed', manifestErr);
                        }

                        console.log('[GLB] Exported', filename);
                        if (statusText) {
                            statusText.textContent = 'GLB exported';
                            statusText.style.color = 'var(--accent)';
                            setTimeout(() => {
                                statusText.textContent = 'Ready';
                                statusText.style.color = '';
                            }, 2000);
                        }
                    } catch (e) {
                        console.error('[GLB] Download failed', e);
                        if (statusText) {
                            statusText.textContent = 'GLB download failed';
                            statusText.style.color = '';
                        }
                    } finally {
                        if (glbBtn) {
                            glbBtn.disabled = false;
                            glbBtn.textContent = 'GLB';
                        }
                    }
                },
                { binary: true }
            );
        } catch (err) {
            console.error('[GLB] Export exception', err);
            if (statusText) {
                statusText.textContent = 'GLB export failed';
                statusText.style.color = '';
            }
            if (glbBtn) {
                glbBtn.disabled = false;
                glbBtn.textContent = 'GLB';
            }
        }
    }

    function captureScreenshot() {
        const statusText = document.getElementById('status-text');
        if (statusText) statusText.textContent = 'Capturing 4:3 shot...';
        
        try {
            // Get canvas from Prime engine viewer
            const canvas = document.querySelector('#viewer canvas');
            if (!canvas) {
                if (statusText) statusText.textContent = 'No canvas found';
                logError('Screenshot', new Error('Canvas element not found'));
                return;
            }
            
            // Force multiple render frames to ensure scene is drawn
            if (STATE.viewer && STATE.viewer.render) {
                STATE.viewer.render();
                STATE.viewer.render();
                STATE.viewer.render();
            }
            
            // Small delay to let rendering complete
            setTimeout(() => {
                captureScreenshotDelayed(canvas, statusText);
            }, 100);
        } catch (err) {
            console.error('Screenshot failed:', err);
            logError('Screenshot', err);
            if (statusText) statusText.textContent = 'Screenshot failed';
        }
    }
    
    function captureScreenshotDelayed(canvas, statusText) {
        try {
            // CRITICAL: Resize renderer to 4:3 BEFORE capturing (no stretching!)
            const targetWidth = 1600;
            const targetHeight = 1200; // 4:3 ratio
            let dataURL = null;
            
            if (STATE.viewer && STATE.viewer.renderer) {
                const renderer = STATE.viewer.renderer;
                const camera = STATE.viewer.camera;
                const scene = STATE.viewer.scene;
                
                console.log('[SCREENSHOT] Renderer:', renderer);
                console.log('[SCREENSHOT] Camera:', camera);
                console.log('[SCREENSHOT] Scene:', scene);
                
                // Store original size
                const origWidth = renderer.domElement.width;
                const origHeight = renderer.domElement.height;
                
                console.log('[SCREENSHOT] Original:', origWidth, 'x', origHeight);
                console.log('[SCREENSHOT] Resizing to native 4:3:', targetWidth, 'x', targetHeight);
                
                // Resize renderer to 4:3 aspect ratio
                renderer.setSize(targetWidth, targetHeight, false);
                camera.aspect = targetWidth / targetHeight;
                camera.updateProjectionMatrix();
                
                // Render at new 4:3 size - use the engine's render directly
                console.log('[SCREENSHOT] About to render...');
                renderer.render(scene, camera);
                console.log('[SCREENSHOT] Render complete');
                
                // Capture at NATIVE 4:3 resolution (no stretching!)
                console.log('[SCREENSHOT] Calling toDataURL...');
                dataURL = renderer.domElement.toDataURL('image/png');
                console.log('[SCREENSHOT] dataURL length:', dataURL ? dataURL.length : 'NULL');
                
                // Restore original size
                renderer.setSize(origWidth, origHeight, false);
                camera.aspect = origWidth / origHeight;
                camera.updateProjectionMatrix();
                renderer.render(scene, camera);
                
                console.log('[SCREENSHOT] ‚úÖ Captured at native 4:3, restored to', origWidth, 'x', origHeight);
            }
            
            if (!dataURL) {
                throw new Error('Failed to capture screenshot - no dataURL generated');
            }
            
            // Create filename with date and scene name
            const scene = STATE.scenes[STATE.activeSceneIdx];
            const filename = scene.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0];
            const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-');
            
            const baseFilename = `wag_gold_${filename}_${dateStr}_${timeStr}`;
            
            const studSkeletonSnapshot = Array.isArray(STATE.studSkeleton)
                ? STATE.studSkeleton.map(node => {
                      if (!node || !node.worldPos) return null;
                      return {
                          x: node.worldPos.x,
                          y: node.worldPos.y,
                          z: node.worldPos.z,
                          layer: node.layer,
                          kind: node.kind,
                          lineNum: node.lineNum
                      };
                  }).filter(Boolean)
                : null;

            let partSkeletonSnapshot = null;
            if (STATE.partSkeletonLibrary && typeof STATE.partSkeletonLibrary === 'object') {
                partSkeletonSnapshot = {};
                Object.keys(STATE.partSkeletonLibrary).forEach(key => {
                    const entry = STATE.partSkeletonLibrary[key];
                    if (!entry || !Array.isArray(entry.studs)) return;
                    partSkeletonSnapshot[key] = {
                        partId: entry.partId || key,
                        studs: entry.studs.map(s => ({
                            x: s.x,
                            y: s.y,
                            z: s.z,
                            role: s.role || 'stud'
                        }))
                    };
                });
            }

            const groundViolationsSnapshot = Array.isArray(STATE.groundViolationSummary)
                ? STATE.groundViolationSummary.map(v => ({
                      lineNum: v.lineNum,
                      count: v.count,
                      partId: v.partId,
                      y: v.y
                  }))
                : null;

            // Create JSON metadata
            const metadata = {
                filename: `${baseFilename}.png`,
                scene: scene.name,
                date: dateStr,
                time: timeStr,
                timestamp: date.toISOString(),
                aspect_ratio: '4:3',
                resolution: `${targetWidth}x${targetHeight}`,
                line_count: editorLines.length,
                locked_lines: Array.from(scene.lockedLines),
                theme: document.documentElement.getAttribute('data-theme') || 'dark',
                diagnostics: STATE.diagnostics,
                camera: STATE.viewer.getCamera ? STATE.viewer.getCamera() : null,
                errors: ERROR_LOG.length,
                mpd_content: editorLines.join('\n'),
                stud_skeleton: studSkeletonSnapshot,
                ground_violations: groundViolationsSnapshot,
                part_skeletons: partSkeletonSnapshot
            };

            // Wolf bus: if hosted in a studio, broadcast GOLD snapshot to parent
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'courage-gold-snapshot',
                        payload: metadata
                    }, '*');
                }
            } catch (err) {
                console.warn('[COURAGE] failed to post courage-gold-snapshot', err);
            }
            
            // Download PNG
            const imgLink = document.createElement('a');
            imgLink.href = dataURL;
            imgLink.download = `${baseFilename}.png`;
            imgLink.click();
            
            // Download JSON
            const jsonBlob = new Blob([JSON.stringify(metadata, null, 2)], { type: 'application/json' });
            const jsonURL = URL.createObjectURL(jsonBlob);
            const jsonLink = document.createElement('a');
            jsonLink.href = jsonURL;
            jsonLink.download = `${baseFilename}.json`;
            jsonLink.click();
            URL.revokeObjectURL(jsonURL);
            
            if (statusText) {
                statusText.textContent = 'üì∏ Screenshot + JSON saved!';
                setTimeout(() => statusText.textContent = 'Ready', 2000);
            }
        } catch (err) {
            console.error('Screenshot delayed failed:', err);
            logError('Screenshot', err);
            if (statusText) statusText.textContent = 'Screenshot failed';
        }
    }
    
    function updateSceneSelector() {
        // Don't touch the dropdown - it's for loading MPD files
        // Scene switching is handled by scene dots
        const fileName = document.getElementById('file-name');
        
        // Update file name in header
        if (fileName) {
            fileName.textContent = STATE.scenes[STATE.activeSceneIdx].name;
        }
    }
    
    function switchScene(idx) {
        idx = parseInt(idx);
        if (idx === STATE.activeSceneIdx) return;
        
        // Save current scene (get current lines from editor)
        STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
        
        // Load new scene
        STATE.activeSceneIdx = idx;
        const scene = STATE.scenes[idx];
        editorLines = [...scene.lines];
        renderEditor(editorLines);
        
        // Update UI
        updateSceneSelector();
        renderSceneDots();
        document.getElementById('status-text').textContent = `Switched to ${scene.name}`;
    }
    
    function closeScene(idx) {
        if (STATE.scenes.length === 1) {
            document.getElementById('status-text').textContent = 'Cannot close last scene';
            return;
        }
        
        STATE.scenes.splice(idx, 1);
        if (STATE.activeSceneIdx >= STATE.scenes.length) {
            STATE.activeSceneIdx = STATE.scenes.length - 1;
        }
        if (idx <= STATE.activeSceneIdx && STATE.activeSceneIdx > 0) {
            STATE.activeSceneIdx--;
        }
        
        switchScene(STATE.activeSceneIdx);
    }
    
    function setupSceneManagement() {
        const selector = document.getElementById('scene-selector');
        
        // Scene selector change
        selector.addEventListener('change', (e) => {
            switchScene(e.target.value);
        });
        
        // Right-click on selector for context menu (new/delete)
        selector.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showSceneContextMenu(e.clientX, e.clientY);
        });
    }
    
    function showSceneContextMenu(x, y) {
        // Simple prompt-based for now
        const action = prompt('Scene Actions:\n1. New Scene\n2. Rename Scene\n3. Delete Scene (if >1)\n\nEnter 1, 2, or 3:');
        
        if (action === '1') {
            const newScene = createScene(`Scene ${STATE.scenes.length + 1}`);
            STATE.scenes.push(newScene);
            switchScene(STATE.scenes.length - 1);
        } else if (action === '2') {
            const newName = prompt('New scene name:', STATE.scenes[STATE.activeSceneIdx].name);
            if (newName && newName.trim()) {
                STATE.scenes[STATE.activeSceneIdx].name = newName.trim();
                updateSceneSelector();
            }
        } else if (action === '3' && STATE.scenes.length > 1) {
            closeScene(STATE.activeSceneIdx);
        }
    }


    function attachViewerEvents() {
        if (!STATE.viewer) return;
        const loading = document.getElementById('loading');
        const statusText = document.getElementById('status-text');
        const modelStats = document.getElementById('model-stats');
        
        STATE.viewer.on('model:loaded', ({ meta, stats }) => {
            loading.classList.remove('active');
            const sourceLabel = meta?.origin || 'Catalog';
            const resolvedPath = meta?.source || meta?.resolvedPath || meta?.path || meta?.filename;
            updateInfo(meta, resolvedPath, stats, sourceLabel);
            
            // Update footer
            statusText.textContent = 'Model loaded';
            statusText.style.color = 'var(--success)';
            modelStats.textContent = `${stats.meshes || 0} meshes ‚Ä¢ ${(stats.triangles || 0).toLocaleString()} tris`;
            setTimeout(() => {
                statusText.textContent = 'Ready';
                statusText.style.color = 'var(--accent)';
            }, 3000);
        });
        
        STATE.viewer.on('model:cleared', () => {
            loading.classList.remove('active');
            modelStats.textContent = 'No model loaded';
        });
    }

    function filterModels(query) {
        const q = query.trim().toLowerCase();
        if (!q) {
            WAG.filtered = [...WAG.models];
        } else {
            WAG.filtered = WAG.models.filter(model => {
                const hay = `${model.filename} ${model.name || ''} ${model.description || ''}`.toLowerCase();
                return hay.includes(q);
            });
        }
        renderModelList();
        updateStats(q);
    }

    function renderModelList() {
        const list = document.getElementById('model-list');
        list.innerHTML = '';
        if (!WAG.filtered.length) {
            list.innerHTML = '<div class="empty-state">No models match.</div>';
            return;
        }
        WAG.filtered.forEach((model, idx) => {
            const item = document.createElement('div');
            item.className = 'model-item';
            if (idx === WAG.lastSelectedIdx) item.classList.add('active');
            item.innerHTML = `<div class="model-title">${model.name || model.filename}</div>
                              <div class="model-meta">${model.filename} ‚Ä¢ ${formatBytes(model.size)}</div>`;
            item.addEventListener('click', () => {
                document.querySelectorAll('.model-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                WAG.lastSelectedIdx = idx;
                loadModel(model);
            });
            list.appendChild(item);
        });
    }

    async function loadModel(model) {
        if (!WAG.viewer) return;
        const loading = document.getElementById('loading');
        loading.classList.add('active');
        const logLabel = `[WAG] ${model.filename}`;
        console.groupCollapsed(`${logLabel} ‚Äì load start`);
        try {
            const candidatePaths = buildCandidatePaths(model);
            console.log('Candidate paths:', candidatePaths);
            const resolvedPath = await loadWithFallbacks(candidatePaths, {
                filename: model.filename,
                name: model.name,
                author: model.author,
                size: model.size,
                description: model.description,
                origin: 'Catalog'
            });
            console.log('Loaded via:', resolvedPath);
            
            // GOLD EDITOR: Also load text into line editor
            try {
                const response = await fetch(encodeURI(resolvedPath));
                if (response.ok) {
                    const text = await response.text();
                    editorLines = text.split('\n');
                    renderEditor(editorLines);
                    console.log('‚úì Loaded into line editor');
                }
            } catch (err) {
                console.warn('Could not load text into editor:', err);
            }
        } catch (err) {
            console.error(`${logLabel} ‚Äì failed after fallback attempts`, err);
            alert(`Failed to load ${model.filename}: ${err.message}`);
            loading.classList.remove('active');
        } finally {
            console.groupEnd();
        }
    }

    async function loadWithFallbacks(paths, meta) {
        if (!WAG.viewer) throw new Error('Viewer not initialized');
        let lastError = null;
        for (const candidate of paths) {
            const encoded = encodeURI(candidate);
            try {
                await WAG.viewer.loadPath(encoded, { ...meta, resolvedPath: candidate });
                return candidate;
            } catch (err) {
                console.warn('[WAG] Path failed', candidate, err);
                lastError = err;
            }
        }
        throw lastError || new Error('All path fallbacks failed');
    }

    async function loadManualText(rawText, meta = {}) {
        if (!STATE.viewer) return;
        
        showLoadingOverlay('Loading Model...', 'Building 3D geometry...');
        
        // üíö GRACE: Always hide loading after 10 seconds max (no infinite hangs!)
        const gracefulTimeout = setTimeout(() => {
            console.warn('üíö Grace: Loading timeout - forcing scene display');
            hideLoadingOverlay();
            document.getElementById('status-text').textContent = 'üíö Scene loaded (some parts may be missing)';
        }, 10000);
        
        // Use raw text from editor; avoid aggressively filtering comments to
        // prevent accidentally stripping structure that LDrawLoader expects.
        const text = (rawText || '').trim();
        if (!text) {
            clearTimeout(gracefulTimeout);
            hideLoadingOverlay();
            alert('Paste MPD/LDR contents first.');
            return;
        }
        const loading = document.getElementById('loading');
        loading.classList.add('active');
        try {
            // Normalize bare '//' lines to valid LDraw comments ('0 //') so
            // the loader doesn't choke on them.
            const normalizedText = text
                .split('\n')
                .map((line) => {
                    const trimmedLine = line.trimStart();
                    if (trimmedLine.startsWith('//')) {
                        const leadingSpacesMatch = line.match(/^\s*/);
                        const leadingSpaces = leadingSpacesMatch ? leadingSpacesMatch[0] : '';
                        const withoutSlashes = trimmedLine.replace(/^\/\//, '');
                        return `${leadingSpaces}0 //${withoutSlashes}`;
                    }
                    return line;
                })
                .join('\n');

            const result = await STATE.viewer.loadText(normalizedText, { ...meta });
            clearTimeout(gracefulTimeout); // Success - cancel timeout
            console.log('[WAG] Load result:', result);
            
            // CRITICAL: Fit camera to model after loading
            if (STATE.viewer && STATE.viewer.fitToCurrent) {
                STATE.viewer.fitToCurrent();
                console.log('[WAG] Camera fitted to model');
            }
            
            // Annotate meshes with line numbers (Bronze method!)
            annotateModelWithLineNumbers();
            
            // Compute coarse stud skeleton and model planes for inference work
            computeStudSkeletonAndPlanes();
            
            clearModelSelection();
            loading.classList.remove('active');
            hideLoadingOverlay();
        } catch (err) {
            clearTimeout(gracefulTimeout); // Error caught - cancel timeout
            hideLoadingOverlay();
            console.error('[WAG] Manual text load failed', err);
            logError('Manual Load', err);
            
            // Check if model is empty (all lines filtered out)
            if (err.message && err.message.includes('empty')) {
                alert('‚ö†Ô∏è Model appears empty!\n\nThis might be because:\n‚Ä¢ All lines were decoration/comments\n‚Ä¢ No actual part geometry (Type 1 lines)\n‚Ä¢ File contains only metadata\n\nTry adding some parts like:\n1 4 0 0 0 1 0 0 0 1 0 0 0 1 3001.dat');
            }
            
            // Try to find offending line from error message
            let lineMatch = null;
            if (err.message) {
                lineMatch = err.message.match(/line\s+(\d+)/i);
                if (lineMatch) {
                    const lineNum = parseInt(lineMatch[1]) - 1;
                    console.log('[ERROR] Highlighting line from error:', lineNum);
                    setTimeout(() => highlightErrorLine(lineNum, err.message), 200);
                }
            }
            
            // Also try stack trace for line numbers
            if (err.stack && !lineMatch) {
                const stackLineMatch = err.stack.match(/:(\d+):/);
                if (stackLineMatch) {
                    const lineNum = parseInt(stackLineMatch[1]);
                    console.log('[ERROR] Highlighting line from stack:', lineNum);
                    setTimeout(() => highlightErrorLine(lineNum, err.message), 200);
                }
            }
            
            alert(`Manual scene load failed: ${err.message}`);
            loading.classList.remove('active');
        }
    }

    async function loadManualPath(rawPath) {
        if (!WAG.viewer) return;
        const path = (rawPath || '').trim();
        if (!path) {
            alert('Provide a relative path (e.g. scene-the-grinning-default.mpd).');
            return;
        }
        const loading = document.getElementById('loading');
        loading.classList.add('active');
        try {
            await WAG.viewer.loadPath(path, {
                filename: path,
                name: path,
                description: 'Loaded via manual path',
                origin: 'Manual Path'
            });
            clearModelSelection();
        } catch (err) {
            console.error('[WAG] Manual path load failed', err);
            alert(`Failed to load "${path}": ${err.message}`);
            loading.classList.remove('active');
        }
    }

    function clearModelSelection() {
        // Legacy function - model catalog not used in Gold editor
        const modelItems = document.querySelectorAll('.model-item');
        if (modelItems.length > 0) {
            modelItems.forEach(el => el.classList.remove('active'));
        }
    }

    function updateInfo(meta, resolvedPath, stats, sourceLabel = 'Catalog') {
        const infoPanel = document.getElementById('info-panel');
        if (!infoPanel) return; // Element removed, skip
        
        infoPanel.style.display = 'block';
        
        const setIfExists = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        
        setIfExists('info-title', meta?.name || meta?.filename || 'Manual Scene');
        setIfExists('info-source', sourceLabel);
        setIfExists('info-file', meta?.filename || '‚Äî');
        setIfExists('info-author', meta?.author || 'unknown');
        setIfExists('info-size', meta?.size ? formatBytes(meta.size) : '‚Äî');
        setIfExists('info-path', resolvedPath || meta?.path || meta?.filename || '‚Äî');
        setIfExists('info-stats', formatStats(stats || WAG.viewer?.getStats()));
        setIfExists('info-notes', (meta?.description && meta.description !== meta.filename) ? meta.description : '‚Äî');
    }

    function updateStats(query = '') {
        const stats = document.getElementById('stats');
        const total = WAG.models.length;
        if (!total) {
            stats.textContent = '0 models indexed';
            return;
        }
        const quarantinedCount = WAG.quarantinedFiles?.length || 0;
        if (query) {
            stats.textContent = `${WAG.filtered.length}/${total} match "${query}"`;
        } else {
            const suffix = quarantinedCount ? ` | ${quarantinedCount} quarantined` : '';
            stats.textContent = `${total} models ready${suffix}`;
        }
    }

    function formatStats(stats) {
        if (!stats) return '‚Äî';
        return `Meshes: ${stats.meshes} ‚Ä¢ Lines: ${stats.lines} ‚Ä¢ Tris: ${stats.triangles}`;
    }

    function formatBytes(bytes = 0) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${(bytes / Math.pow(k, i)).toFixed(1)} ${sizes[i]}`;
    }

    function setToggleButtonState(button, active) {
        if (!button) return;
        button.classList.toggle('active', !!active);
        if (button.id === 'toggle-spin') {
            button.textContent = active ? 'Stop Spin' : 'Auto Spin';
        }
    }

    function loadMinifigFromWagFrank(lines, name, replace = true) {
        if (!Array.isArray(lines) || !lines.length) return;

        if (replace) {
            editorLines = [...lines];
        } else {
            const insertIdx = editorLines.lastIndexOf('0 STEP');
            const offsetZ = (() => {
                const matches = editorLines.filter((line) => line.startsWith('1 '));
                let maxZ = 0;
                matches.forEach((line) => {
                    const parts = line.trim().split(/\s+/);
                    const z = parseFloat(parts[5]);
                    if (!Number.isNaN(z)) {
                        maxZ = Math.max(maxZ, z);
                    }
                });
                return maxZ + 220;
            })();
            const shifted = lines.map((line) => {
                if (!line.startsWith('1 ')) return line;
                const segments = line.trim().split(/\s+/);
                const z = parseFloat(segments[5]);
                if (!Number.isNaN(z)) {
                    segments[5] = (z + offsetZ).toString();
                    return segments.join(' ');
                }
                return line;
            });
            if (insertIdx >= 0) {
                editorLines.splice(insertIdx, 0, `0 // Added Minifig ${name}`, ...shifted, '');
            } else {
                editorLines.push(`0 // Added Minifig ${name}`, ...shifted, '');
            }
        }

        STATE.scenes[STATE.activeSceneIdx].lines = [...editorLines];
        STATE.scenes[STATE.activeSceneIdx].name = name;
        renderEditor(editorLines);
        updateSceneSelector();
        const statusEl = document.getElementById('status-text');
        if (statusEl) {
            statusEl.textContent = `${replace ? 'Loaded' : '‚ûï Added'} ${name} via wag-frank`;
        }
        setTimeout(() => compileCurrentMPD(), 500);
    }

    function setupWagFrankBridge() {
        if (!wagFrankBus) return;
        wagFrankBus.onmessage = (event) => {
            const msg = event.data;
            if (!msg || typeof msg !== 'object') return;
            const kind = msg.kind;
            if (
                kind !== 'minifig-mpd' &&
                kind !== 'minifig-family-mpd' &&
                kind !== 'scene-mpd' &&
                kind !== 'location-mpd'
            ) {
                return;
            }
            const payload = msg.payload || {};
            let { mpdLines, name, mode } = payload;
            if (!Array.isArray(mpdLines) || !mpdLines.length) return;
            if (!name) {
                if (kind === 'minifig-family-mpd') {
                    name = 'Minifig Family';
                } else if (kind === 'scene-mpd') {
                    name = 'Scene from wag-frank';
                } else if (kind === 'location-mpd') {
                    name = 'Location from locationator';
                } else {
                    name = 'Minifig from wag-frank';
                }
            }
            const replace = mode === 'replace';
            try {
                const lines = mpdLines.map((line) => String(line));
                if (kind === 'scene-mpd' || kind === 'location-mpd') {
                    loadMinifigFromWagFrank(lines, name, true);
                } else {
                    loadMinifigFromWagFrank(lines, name, replace);
                }
            } catch (err) {
                console.error('[wag-frank] Failed to load minifig/location from message', err);
            }
        };
    }

    function setupCourageWolfBusBridge() {
        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (!msg || typeof msg !== 'object' || !msg.type) return;
            if (msg.type === 'studio-load-mpd-from-were') {
                const mpdText = typeof msg.mpd === 'string' ? msg.mpd : '';
                if (!mpdText.trim()) return;
                try {
                    const normalized = mpdText.replace(/\r\n/g, '\n');
                    editorLines = normalized.split('\n');
                    const scene = STATE.scenes[STATE.activeSceneIdx];
                    if (scene) {
                        scene.lines = [...editorLines];
                    }
                    renderEditor(editorLines);
                    const statusText = document.getElementById('status-text');
                    if (statusText) {
                        statusText.textContent = 'üíö MPD loaded from WERE (wolf bus)';
                    }
                    setTimeout(() => compileCurrentMPD(), 200);
                } catch (err) {
                    console.warn('[COURAGE] Failed to apply MPD from WERE wolf bus', err);
                }
            }
        });
    }

    init().then(() => {
        setupWagFrankBridge();
        setupCourageWolfBusBridge();
        try {
            const params = new URLSearchParams(window.location.search);
            const mpd = params.get('mpd');
            if (mpd) {
                const decoded = decodeURIComponent(mpd);
                loadManualPath(decoded);
            }
        } catch (err) {
            console.warn('[WAG] mpd autoload failed', err);
        }
    });
    </script>
</body>
</html>
